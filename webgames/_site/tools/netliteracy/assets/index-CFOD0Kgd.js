(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const w of o.addedNodes)w.tagName==="LINK"&&w.rel==="modulepreload"&&s(w)}).observe(document,{childList:!0,subtree:!0});function n(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(r){if(r.ep)return;r.ep=!0;const o=n(r);fetch(r.href,o)}})();const c=document.getElementById("dropzone"),y=document.getElementById("file-input"),E=document.getElementById("status"),d=document.getElementById("detect-button"),u=document.getElementById("download-button"),f=document.getElementById("preview-canvas");if(!c||!y||!E||!d||!u||!f)throw new Error("初期化エラー: 必要なDOM要素が見つかりません");const a=f.getContext("2d",{willReadFrequently:!0});if(!a)throw new Error("CanvasRenderingContext2D を取得できませんでした");let l=null,h=0,m=0,p=[],g=null;const i=e=>{E.textContent=e},L=async()=>g||("FaceDetector"in window?(g=new FaceDetector({fastMode:!0,maxDetectedFaces:12,scoreThreshold:.3}),g):null),I=()=>{a.clearRect(0,0,f.width,f.height),p=[],u.disabled=!0},M=async e=>{I(),l=null;const t=await new Promise((s,r)=>{const o=new FileReader;o.onerror=()=>r(new Error("画像の読み込みに失敗しました")),o.onload=()=>s(String(o.result)),o.readAsDataURL(e)}),n=new Image;await new Promise((s,r)=>{n.onload=()=>s(),n.onerror=()=>r(new Error("画像の表示に失敗しました")),n.src=t}),h=n.naturalWidth,m=n.naturalHeight,l=n,f.width=h,f.height=m,a.drawImage(n,0,0,h,m),i(`画像を読み込みました（${h}×${m}）。「顔をぼかす」を押してください。`),d.disabled=!1},b=async e=>{if(!e){i("有効なファイルが選択されていません。");return}if(!e.type.startsWith("image/")){i("画像ファイルを選択してください。");return}d.disabled=!0,u.disabled=!0,i("画像を読み込んでいます...");try{await M(e)}catch(t){console.error(t),i(t instanceof Error?t.message:"画像の読み込みに失敗しました。")}};c.addEventListener("dragover",e=>{e.preventDefault(),c.classList.add("dragging")});c.addEventListener("dragleave",()=>{c.classList.remove("dragging")});c.addEventListener("drop",e=>{var n,s;e.preventDefault(),c.classList.remove("dragging");const t=(s=(n=e.dataTransfer)==null?void 0:n.files)==null?void 0:s[0];b(t??null)});y.addEventListener("change",()=>{var t;const e=((t=y.files)==null?void 0:t[0])??null;b(e)});const v=()=>{l&&(a.drawImage(l,0,0,h,m),p.forEach(({boundingBox:e})=>{const t=Math.max(e.width,e.height)*.35,n=Math.max(0,Math.floor(e.x-t)),s=Math.max(0,Math.floor(e.y-t)),r=Math.min(h-n,Math.ceil(e.width+t*2)),o=Math.min(m-s,Math.ceil(e.height+t*2));a.save(),a.filter="blur(26px)",a.globalCompositeOperation="source-over",a.drawImage(l,n,s,r,o,n,s,r,o),a.restore(),a.save(),a.strokeStyle="rgba(59, 130, 246, 0.28)",a.lineWidth=Math.max(2,Math.min(r,o)*.05),a.strokeRect(n+a.lineWidth,s+a.lineWidth,r-a.lineWidth*2,o-a.lineWidth*2),a.restore()}))},D=async()=>{if(!l){i("先に画像を選択してください。");return}const e=await L();if(!e){i("このブラウザは FaceDetector API に対応していません。最新の Chrome / Edge をご利用ください。");return}i("顔を検出しています..."),d.disabled=!0,u.disabled=!0;try{const t=await e.detect(l);if(!t.length){p=[],v(),i("顔は見つかりませんでした。"),d.disabled=!1;return}p=t.map(n=>({boundingBox:n.boundingBox})),v(),i(`${t.length} 件の顔をぼかしました。`),u.disabled=!1}catch(t){console.error(t),i("顔の検出中にエラーが発生しました。")}finally{d.disabled=!1}};d.addEventListener("click",()=>{D()});u.addEventListener("click",async()=>{if(u.disabled)return;const e=await new Promise(s=>f.toBlob(s,"image/png"));if(!e){i("画像を生成できませんでした。");return}const t=URL.createObjectURL(e),n=document.createElement("a");n.href=t,n.download="blurred-photo.png",n.click(),URL.revokeObjectURL(t)});i("写真を選択してください。");
