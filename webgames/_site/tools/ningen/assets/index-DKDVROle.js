(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))r(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function e(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(i){if(i.ep)return;i.ep=!0;const o=e(i);fetch(i.href,o)}})();function Ot(t,n){var e,r=1;t==null&&(t=0),n==null&&(n=0);function i(){var o,s=e.length,l,d=0,c=0;for(o=0;o<s;++o)l=e[o],d+=l.x,c+=l.y;for(d=(d/s-t)*r,c=(c/s-n)*r,o=0;o<s;++o)l=e[o],l.x-=d,l.y-=c}return i.initialize=function(o){e=o},i.x=function(o){return arguments.length?(t=+o,i):t},i.y=function(o){return arguments.length?(n=+o,i):n},i.strength=function(o){return arguments.length?(r=+o,i):r},i}function Bt(t){const n=+this._x.call(null,t),e=+this._y.call(null,t);return mt(this.cover(n,e),n,e,t)}function mt(t,n,e,r){if(isNaN(n)||isNaN(e))return t;var i,o=t._root,s={data:r},l=t._x0,d=t._y0,c=t._x1,g=t._y1,w,x,f,m,u,a,h,y;if(!o)return t._root=s,t;for(;o.length;)if((u=n>=(w=(l+c)/2))?l=w:c=w,(a=e>=(x=(d+g)/2))?d=x:g=x,i=o,!(o=o[h=a<<1|u]))return i[h]=s,t;if(f=+t._x.call(null,o.data),m=+t._y.call(null,o.data),n===f&&e===m)return s.next=o,i?i[h]=s:t._root=s,t;do i=i?i[h]=new Array(4):t._root=new Array(4),(u=n>=(w=(l+c)/2))?l=w:c=w,(a=e>=(x=(d+g)/2))?d=x:g=x;while((h=a<<1|u)===(y=(m>=x)<<1|f>=w));return i[y]=o,i[h]=s,t}function kt(t){var n,e,r=t.length,i,o,s=new Array(r),l=new Array(r),d=1/0,c=1/0,g=-1/0,w=-1/0;for(e=0;e<r;++e)isNaN(i=+this._x.call(null,n=t[e]))||isNaN(o=+this._y.call(null,n))||(s[e]=i,l[e]=o,i<d&&(d=i),i>g&&(g=i),o<c&&(c=o),o>w&&(w=o));if(d>g||c>w)return this;for(this.cover(d,c).cover(g,w),e=0;e<r;++e)mt(this,s[e],l[e],t[e]);return this}function Dt(t,n){if(isNaN(t=+t)||isNaN(n=+n))return this;var e=this._x0,r=this._y0,i=this._x1,o=this._y1;if(isNaN(e))i=(e=Math.floor(t))+1,o=(r=Math.floor(n))+1;else{for(var s=i-e||1,l=this._root,d,c;e>t||t>=i||r>n||n>=o;)switch(c=(n<r)<<1|t<e,d=new Array(4),d[c]=l,l=d,s*=2,c){case 0:i=e+s,o=r+s;break;case 1:e=i-s,o=r+s;break;case 2:i=e+s,r=o-s;break;case 3:e=i-s,r=o-s;break}this._root&&this._root.length&&(this._root=l)}return this._x0=e,this._y0=r,this._x1=i,this._y1=o,this}function Wt(){var t=[];return this.visit(function(n){if(!n.length)do t.push(n.data);while(n=n.next)}),t}function Ut(t){return arguments.length?this.cover(+t[0][0],+t[0][1]).cover(+t[1][0],+t[1][1]):isNaN(this._x0)?void 0:[[this._x0,this._y0],[this._x1,this._y1]]}function A(t,n,e,r,i){this.node=t,this.x0=n,this.y0=e,this.x1=r,this.y1=i}function Ft(t,n,e){var r,i=this._x0,o=this._y0,s,l,d,c,g=this._x1,w=this._y1,x=[],f=this._root,m,u;for(f&&x.push(new A(f,i,o,g,w)),e==null?e=1/0:(i=t-e,o=n-e,g=t+e,w=n+e,e*=e);m=x.pop();)if(!(!(f=m.node)||(s=m.x0)>g||(l=m.y0)>w||(d=m.x1)<i||(c=m.y1)<o))if(f.length){var a=(s+d)/2,h=(l+c)/2;x.push(new A(f[3],a,h,d,c),new A(f[2],s,h,a,c),new A(f[1],a,l,d,h),new A(f[0],s,l,a,h)),(u=(n>=h)<<1|t>=a)&&(m=x[x.length-1],x[x.length-1]=x[x.length-1-u],x[x.length-1-u]=m)}else{var y=t-+this._x.call(null,f.data),v=n-+this._y.call(null,f.data),p=y*y+v*v;if(p<e){var _=Math.sqrt(e=p);i=t-_,o=n-_,g=t+_,w=n+_,r=f.data}}return r}function Ht(t){if(isNaN(g=+this._x.call(null,t))||isNaN(w=+this._y.call(null,t)))return this;var n,e=this._root,r,i,o,s=this._x0,l=this._y0,d=this._x1,c=this._y1,g,w,x,f,m,u,a,h;if(!e)return this;if(e.length)for(;;){if((m=g>=(x=(s+d)/2))?s=x:d=x,(u=w>=(f=(l+c)/2))?l=f:c=f,n=e,!(e=e[a=u<<1|m]))return this;if(!e.length)break;(n[a+1&3]||n[a+2&3]||n[a+3&3])&&(r=n,h=a)}for(;e.data!==t;)if(i=e,!(e=e.next))return this;return(o=e.next)&&delete e.next,i?(o?i.next=o:delete i.next,this):n?(o?n[a]=o:delete n[a],(e=n[0]||n[1]||n[2]||n[3])&&e===(n[3]||n[2]||n[1]||n[0])&&!e.length&&(r?r[h]=e:this._root=e),this):(this._root=o,this)}function Yt(t){for(var n=0,e=t.length;n<e;++n)this.remove(t[n]);return this}function Gt(){return this._root}function Xt(){var t=0;return this.visit(function(n){if(!n.length)do++t;while(n=n.next)}),t}function Kt(t){var n=[],e,r=this._root,i,o,s,l,d;for(r&&n.push(new A(r,this._x0,this._y0,this._x1,this._y1));e=n.pop();)if(!t(r=e.node,o=e.x0,s=e.y0,l=e.x1,d=e.y1)&&r.length){var c=(o+l)/2,g=(s+d)/2;(i=r[3])&&n.push(new A(i,c,g,l,d)),(i=r[2])&&n.push(new A(i,o,g,c,d)),(i=r[1])&&n.push(new A(i,c,s,l,g)),(i=r[0])&&n.push(new A(i,o,s,c,g))}return this}function Jt(t){var n=[],e=[],r;for(this._root&&n.push(new A(this._root,this._x0,this._y0,this._x1,this._y1));r=n.pop();){var i=r.node;if(i.length){var o,s=r.x0,l=r.y0,d=r.x1,c=r.y1,g=(s+d)/2,w=(l+c)/2;(o=i[0])&&n.push(new A(o,s,l,g,w)),(o=i[1])&&n.push(new A(o,g,l,d,w)),(o=i[2])&&n.push(new A(o,s,w,g,c)),(o=i[3])&&n.push(new A(o,g,w,d,c))}e.push(r)}for(;r=e.pop();)t(r.node,r.x0,r.y0,r.x1,r.y1);return this}function Qt(t){return t[0]}function Vt(t){return arguments.length?(this._x=t,this):this._x}function Zt(t){return t[1]}function te(t){return arguments.length?(this._y=t,this):this._y}function st(t,n,e){var r=new ct(n??Qt,e??Zt,NaN,NaN,NaN,NaN);return t==null?r:r.addAll(t)}function ct(t,n,e,r,i,o){this._x=t,this._y=n,this._x0=e,this._y0=r,this._x1=i,this._y1=o,this._root=void 0}function lt(t){for(var n={data:t.data},e=n;t=t.next;)e=e.next={data:t.data};return n}var L=st.prototype=ct.prototype;L.copy=function(){var t=new ct(this._x,this._y,this._x0,this._y0,this._x1,this._y1),n=this._root,e,r;if(!n)return t;if(!n.length)return t._root=lt(n),t;for(e=[{source:n,target:t._root=new Array(4)}];n=e.pop();)for(var i=0;i<4;++i)(r=n.source[i])&&(r.length?e.push({source:r,target:n.target[i]=new Array(4)}):n.target[i]=lt(r));return t};L.add=Bt;L.addAll=kt;L.cover=Dt;L.data=Wt;L.extent=Ut;L.find=Ft;L.remove=Ht;L.removeAll=Yt;L.root=Gt;L.size=Xt;L.visit=Kt;L.visitAfter=Jt;L.x=Vt;L.y=te;function D(t){return function(){return t}}function O(t){return(t()-.5)*1e-6}function ee(t){return t.x+t.vx}function ne(t){return t.y+t.vy}function re(t){var n,e,r,i=1,o=1;typeof t!="function"&&(t=D(t==null?1:+t));function s(){for(var c,g=n.length,w,x,f,m,u,a,h=0;h<o;++h)for(w=st(n,ee,ne).visitAfter(l),c=0;c<g;++c)x=n[c],u=e[x.index],a=u*u,f=x.x+x.vx,m=x.y+x.vy,w.visit(y);function y(v,p,_,C,E){var b=v.data,N=v.r,S=u+N;if(b){if(b.index>x.index){var P=f-b.x-b.vx,j=m-b.y-b.vy,I=P*P+j*j;I<S*S&&(P===0&&(P=O(r),I+=P*P),j===0&&(j=O(r),I+=j*j),I=(S-(I=Math.sqrt(I)))/I*i,x.vx+=(P*=I)*(S=(N*=N)/(a+N)),x.vy+=(j*=I)*S,b.vx-=P*(S=1-S),b.vy-=j*S)}return}return p>f+S||C<f-S||_>m+S||E<m-S}}function l(c){if(c.data)return c.r=e[c.data.index];for(var g=c.r=0;g<4;++g)c[g]&&c[g].r>c.r&&(c.r=c[g].r)}function d(){if(n){var c,g=n.length,w;for(e=new Array(g),c=0;c<g;++c)w=n[c],e[w.index]=+t(w,c,n)}}return s.initialize=function(c,g){n=c,r=g,d()},s.iterations=function(c){return arguments.length?(o=+c,s):o},s.strength=function(c){return arguments.length?(i=+c,s):i},s.radius=function(c){return arguments.length?(t=typeof c=="function"?c:D(+c),d(),s):t},s}function ie(t){return t.index}function ut(t,n){var e=t.get(n);if(!e)throw new Error("node not found: "+n);return e}function oe(t){var n=ie,e=w,r,i=D(30),o,s,l,d,c,g=1;t==null&&(t=[]);function w(a){return 1/Math.min(l[a.source.index],l[a.target.index])}function x(a){for(var h=0,y=t.length;h<g;++h)for(var v=0,p,_,C,E,b,N,S;v<y;++v)p=t[v],_=p.source,C=p.target,E=C.x+C.vx-_.x-_.vx||O(c),b=C.y+C.vy-_.y-_.vy||O(c),N=Math.sqrt(E*E+b*b),N=(N-o[v])/N*a*r[v],E*=N,b*=N,C.vx-=E*(S=d[v]),C.vy-=b*S,_.vx+=E*(S=1-S),_.vy+=b*S}function f(){if(s){var a,h=s.length,y=t.length,v=new Map(s.map((_,C)=>[n(_,C,s),_])),p;for(a=0,l=new Array(h);a<y;++a)p=t[a],p.index=a,typeof p.source!="object"&&(p.source=ut(v,p.source)),typeof p.target!="object"&&(p.target=ut(v,p.target)),l[p.source.index]=(l[p.source.index]||0)+1,l[p.target.index]=(l[p.target.index]||0)+1;for(a=0,d=new Array(y);a<y;++a)p=t[a],d[a]=l[p.source.index]/(l[p.source.index]+l[p.target.index]);r=new Array(y),m(),o=new Array(y),u()}}function m(){if(s)for(var a=0,h=t.length;a<h;++a)r[a]=+e(t[a],a,t)}function u(){if(s)for(var a=0,h=t.length;a<h;++a)o[a]=+i(t[a],a,t)}return x.initialize=function(a,h){s=a,c=h,f()},x.links=function(a){return arguments.length?(t=a,f(),x):t},x.id=function(a){return arguments.length?(n=a,x):n},x.iterations=function(a){return arguments.length?(g=+a,x):g},x.strength=function(a){return arguments.length?(e=typeof a=="function"?a:D(+a),m(),x):e},x.distance=function(a){return arguments.length?(i=typeof a=="function"?a:D(+a),u(),x):i},x}var ae={value:()=>{}};function wt(){for(var t=0,n=arguments.length,e={},r;t<n;++t){if(!(r=arguments[t]+"")||r in e||/[\s.]/.test(r))throw new Error("illegal type: "+r);e[r]=[]}return new V(e)}function V(t){this._=t}function se(t,n){return t.trim().split(/^|\s+/).map(function(e){var r="",i=e.indexOf(".");if(i>=0&&(r=e.slice(i+1),e=e.slice(0,i)),e&&!n.hasOwnProperty(e))throw new Error("unknown type: "+e);return{type:e,name:r}})}V.prototype=wt.prototype={constructor:V,on:function(t,n){var e=this._,r=se(t+"",e),i,o=-1,s=r.length;if(arguments.length<2){for(;++o<s;)if((i=(t=r[o]).type)&&(i=ce(e[i],t.name)))return i;return}if(n!=null&&typeof n!="function")throw new Error("invalid callback: "+n);for(;++o<s;)if(i=(t=r[o]).type)e[i]=ft(e[i],t.name,n);else if(n==null)for(i in e)e[i]=ft(e[i],t.name,null);return this},copy:function(){var t={},n=this._;for(var e in n)t[e]=n[e].slice();return new V(t)},call:function(t,n){if((i=arguments.length-2)>0)for(var e=new Array(i),r=0,i,o;r<i;++r)e[r]=arguments[r+2];if(!this._.hasOwnProperty(t))throw new Error("unknown type: "+t);for(o=this._[t],r=0,i=o.length;r<i;++r)o[r].value.apply(n,e)},apply:function(t,n,e){if(!this._.hasOwnProperty(t))throw new Error("unknown type: "+t);for(var r=this._[t],i=0,o=r.length;i<o;++i)r[i].value.apply(n,e)}};function ce(t,n){for(var e=0,r=t.length,i;e<r;++e)if((i=t[e]).name===n)return i.value}function ft(t,n,e){for(var r=0,i=t.length;r<i;++r)if(t[r].name===n){t[r]=ae,t=t.slice(0,r).concat(t.slice(r+1));break}return e!=null&&t.push({name:n,value:e}),t}var Y=0,X=0,G=0,vt=1e3,Z,K,tt=0,W=0,it=0,Q=typeof performance=="object"&&performance.now?performance:Date,_t=typeof window=="object"&&window.requestAnimationFrame?window.requestAnimationFrame.bind(window):function(t){setTimeout(t,17)};function bt(){return W||(_t(le),W=Q.now()+it)}function le(){W=0}function ot(){this._call=this._time=this._next=null}ot.prototype=Nt.prototype={constructor:ot,restart:function(t,n,e){if(typeof t!="function")throw new TypeError("callback is not a function");e=(e==null?bt():+e)+(n==null?0:+n),!this._next&&K!==this&&(K?K._next=this:Z=this,K=this),this._call=t,this._time=e,at()},stop:function(){this._call&&(this._call=null,this._time=1/0,at())}};function Nt(t,n,e){var r=new ot;return r.restart(t,n,e),r}function ue(){bt(),++Y;for(var t=Z,n;t;)(n=W-t._time)>=0&&t._call.call(void 0,n),t=t._next;--Y}function ht(){W=(tt=Q.now())+it,Y=X=0;try{ue()}finally{Y=0,he(),W=0}}function fe(){var t=Q.now(),n=t-tt;n>vt&&(it-=n,tt=t)}function he(){for(var t,n=Z,e,r=1/0;n;)n._call?(r>n._time&&(r=n._time),t=n,n=n._next):(e=n._next,n._next=null,n=t?t._next=e:Z=e);K=t,at(r)}function at(t){if(!Y){X&&(X=clearTimeout(X));var n=t-W;n>24?(t<1/0&&(X=setTimeout(ht,t-Q.now()-it)),G&&(G=clearInterval(G))):(G||(tt=Q.now(),G=setInterval(fe,vt)),Y=1,_t(ht))}}const de=1664525,ge=1013904223,dt=4294967296;function ye(){let t=1;return()=>(t=(de*t+ge)%dt)/dt}function pe(t){return t.x}function xe(t){return t.y}var me=10,we=Math.PI*(3-Math.sqrt(5));function ve(t){var n,e=1,r=.001,i=1-Math.pow(r,1/300),o=0,s=.6,l=new Map,d=Nt(w),c=wt("tick","end"),g=ye();t==null&&(t=[]);function w(){x(),c.call("tick",n),e<r&&(d.stop(),c.call("end",n))}function x(u){var a,h=t.length,y;u===void 0&&(u=1);for(var v=0;v<u;++v)for(e+=(o-e)*i,l.forEach(function(p){p(e)}),a=0;a<h;++a)y=t[a],y.fx==null?y.x+=y.vx*=s:(y.x=y.fx,y.vx=0),y.fy==null?y.y+=y.vy*=s:(y.y=y.fy,y.vy=0);return n}function f(){for(var u=0,a=t.length,h;u<a;++u){if(h=t[u],h.index=u,h.fx!=null&&(h.x=h.fx),h.fy!=null&&(h.y=h.fy),isNaN(h.x)||isNaN(h.y)){var y=me*Math.sqrt(.5+u),v=u*we;h.x=y*Math.cos(v),h.y=y*Math.sin(v)}(isNaN(h.vx)||isNaN(h.vy))&&(h.vx=h.vy=0)}}function m(u){return u.initialize&&u.initialize(t,g),u}return f(),n={tick:x,restart:function(){return d.restart(w),n},stop:function(){return d.stop(),n},nodes:function(u){return arguments.length?(t=u,f(),l.forEach(m),n):t},alpha:function(u){return arguments.length?(e=+u,n):e},alphaMin:function(u){return arguments.length?(r=+u,n):r},alphaDecay:function(u){return arguments.length?(i=+u,n):+i},alphaTarget:function(u){return arguments.length?(o=+u,n):o},velocityDecay:function(u){return arguments.length?(s=1-u,n):1-s},randomSource:function(u){return arguments.length?(g=u,l.forEach(m),n):g},force:function(u,a){return arguments.length>1?(a==null?l.delete(u):l.set(u,m(a)),n):l.get(u)},find:function(u,a,h){var y=0,v=t.length,p,_,C,E,b;for(h==null?h=1/0:h*=h,y=0;y<v;++y)E=t[y],p=u-E.x,_=a-E.y,C=p*p+_*_,C<h&&(b=E,h=C);return b},on:function(u,a){return arguments.length>1?(c.on(u,a),n):c.on(u)}}}function _e(){var t,n,e,r,i=D(-30),o,s=1,l=1/0,d=.81;function c(f){var m,u=t.length,a=st(t,pe,xe).visitAfter(w);for(r=f,m=0;m<u;++m)n=t[m],a.visit(x)}function g(){if(t){var f,m=t.length,u;for(o=new Array(m),f=0;f<m;++f)u=t[f],o[u.index]=+i(u,f,t)}}function w(f){var m=0,u,a,h=0,y,v,p;if(f.length){for(y=v=p=0;p<4;++p)(u=f[p])&&(a=Math.abs(u.value))&&(m+=u.value,h+=a,y+=a*u.x,v+=a*u.y);f.x=y/h,f.y=v/h}else{u=f,u.x=u.data.x,u.y=u.data.y;do m+=o[u.data.index];while(u=u.next)}f.value=m}function x(f,m,u,a){if(!f.value)return!0;var h=f.x-n.x,y=f.y-n.y,v=a-m,p=h*h+y*y;if(v*v/d<p)return p<l&&(h===0&&(h=O(e),p+=h*h),y===0&&(y=O(e),p+=y*y),p<s&&(p=Math.sqrt(s*p)),n.vx+=h*f.value*r/p,n.vy+=y*f.value*r/p),!0;if(f.length||p>=l)return;(f.data!==n||f.next)&&(h===0&&(h=O(e),p+=h*h),y===0&&(y=O(e),p+=y*y),p<s&&(p=Math.sqrt(s*p)));do f.data!==n&&(v=o[f.data.index]*r/p,n.vx+=h*v,n.vy+=y*v);while(f=f.next)}return c.initialize=function(f,m){t=f,e=m,g()},c.strength=function(f){return arguments.length?(i=typeof f=="function"?f:D(+f),g(),c):i},c.distanceMin=function(f){return arguments.length?(s=f*f,c):Math.sqrt(s)},c.distanceMax=function(f){return arguments.length?(l=f*f,c):Math.sqrt(l)},c.theta=function(f){return arguments.length?(d=f*f,c):Math.sqrt(d)},c}let z=null,et=null,gt=null;const be=()=>"/dev-sandbox/tools/ningen/mecab/",Ne=async()=>{const t=be(),e=await import(`${t}libmecab.js`);return(e.default??e)({locateFile:i=>i.endsWith(".wasm")?`${t}libmecab.wasm`:i.endsWith(".data")?`${t}libmecab.data`:i})},Se=async()=>{if(!z&&(gt||(gt=Ne()),z=await gt,et=z.ccall("mecab_new2","number",["string"],[""]),!et))throw new Error("MeCab インスタンスの初期化に失敗しました")};class yt{static async waitReady(){await Se()}static query(n){if(!z||!et)throw new Error("Mecab not ready");const e=n,r=Math.max(1024,e.length*128),i=z._malloc(r);try{const o=z.ccall("mecab_sparse_tostr3","number",["number","string","number","number","number"],[et,e,z.lengthBytesUTF8(e)+1,i,r]),s=z.UTF8ToString(o);return s?s.split(`
`).map(l=>l.trim()).filter(Boolean).map(l=>{const[d,c]=l.split("	");if(!d||!c)return null;const g=c.split(",");return{word:d,pos:g[0]??"",pos_detail1:g[1]??"",pos_detail2:g[2]??"",pos_detail3:g[3]??"",conjugation1:g[4]??"",conjugation2:g[5]??"",dictionary_form:g[6]??"",reading:g[7]??"",pronunciation:g[8]??""}}).filter(l=>l!==null):[]}finally{z._free(i)}}}const St=new Set(["こと","もの","よう","ような","ように","ところ","それ","これ","あれ","の","ん","そして","しかし","ようだ","ため","ので","など","また","なに","何","自分","人間","私","僕","俺","君","さん","する","こと","ある","いる","なる","できる","これら","それら","どこ","ここ","よう","ほんと","ほんとう","感じ","時","中","前","後","胸","事","人","たち","年"]),Me=new Set(["。","！","!","？","?","…","‥"]),nt=["#38bdf8","#a855f7","#f472b6","#facc15","#34d399","#60a5fa","#f97316","#fb7185"],Mt=document.querySelector("#app");if(!Mt)throw new Error("#app not found");Mt.innerHTML=`
  <section class="header">
    <h1>人間失格ワードクラウドラボ</h1>
    <p>
      青空文庫版『人間失格』を MeCab で形態素解析し、名詞頻度からワードクラウドを生成します。閾値や上限語数を調整して語彙を可視化し、共起ネットワークでも語の関係性を確認しましょう。
    </p>
  </section>
  <div class="status" id="status" data-state="loading">データを解析しています…</div>
  <section class="panel">
    <article class="card">
      <label>解析概要</label>
      <ul id="summary" class="summary-list"></ul>
      <div class="controls">
        <label for="min-count">最小出現回数</label>
        <input id="min-count" type="number" min="1" max="20" value="3" />
        <label for="max-words">最大語数</label>
        <input id="max-words" type="number" min="20" max="200" value="120" />
      </div>
      <div class="controls">
        <button id="regenerate" type="button">ワードクラウドを再生成</button>
        <button id="download" type="button" disabled>PNGとしてダウンロード</button>
      </div>
    </article>
    <article class="card wordcloud-card">
      <h2>Word Cloud</h2>
      <canvas id="cloud-canvas" width="1000" height="600" aria-label="ワードクラウド"></canvas>
      <p class="status" id="cloud-status" data-state="pending">生成準備中です。</p>
      <div class="download-row">
        <span id="cloud-legend"></span>
      </div>
    </article>
    <article class="card network-card">
      <h2>共起ネットワーク</h2>
      <div class="controls">
        <label for="coocc-threshold">最小共起回数</label>
        <input id="coocc-threshold" type="number" min="1" max="30" value="3" />
        <label for="coocc-max-nodes">最大ノード数</label>
        <input id="coocc-max-nodes" type="number" min="10" max="80" value="45" />
      </div>
      <div class="controls">
        <button id="regenerate-network" type="button">共起ネットワークを再生成</button>
      </div>
      <canvas id="network-canvas" width="1000" height="600" aria-label="共起ネットワーク"></canvas>
      <p class="status" id="network-status" data-state="pending">生成準備中です。</p>
      <div class="download-row">
        <span id="network-legend"></span>
      </div>
    </article>
    <article class="card">
      <label>上位語リスト</label>
      <table>
        <thead>
          <tr>
            <th scope="col">語</th>
            <th scope="col">読み</th>
            <th scope="col">出現回数</th>
          </tr>
        </thead>
        <tbody id="ranking"></tbody>
      </table>
    </article>
  </section>
`;const k=document.querySelector("#status"),B=document.querySelector("#cloud-status"),Ct=document.querySelector("#summary"),Et=document.querySelector("#ranking"),$t=document.querySelector("#min-count"),At=document.querySelector("#max-words"),Lt=document.querySelector("#regenerate"),rt=document.querySelector("#download"),M=document.querySelector("#cloud-canvas"),U=document.querySelector("#cloud-legend"),$=document.querySelector("#network-canvas"),q=document.querySelector("#network-status"),Tt=document.querySelector("#coocc-threshold"),Pt=document.querySelector("#coocc-max-nodes"),It=document.querySelector("#regenerate-network"),F=document.querySelector("#network-legend");if(!k||!B||!Ct||!Et||!$t||!At||!Lt||!rt||!M||!U||!$||!q||!Tt||!Pt||!It||!F)throw new Error("必要なDOM要素が見つかりません");let T=null,J=[],R=[],H=[];const Ce=async()=>{const n=await fetch("/dev-sandbox/tools/ningen/corpus/ningen.txt");if(!n.ok)throw new Error(`本文を取得できませんでした (${n.status})`);return n.text()},Ee=t=>t.filter(n=>n.word&&n.pos&&n.pos!=="記号"),$e=t=>{const n=new Map;return t.forEach(e=>{if(e.pos!=="名詞"||e.pos_detail1==="数"||e.pos_detail1==="非自立"||e.pos_detail1==="代名詞")return;const r=(e.dictionary_form&&e.dictionary_form!=="*"?e.dictionary_form:e.word).trim();if(!r||St.has(r)||r.length<=1)return;const i=n.get(r);i?(i.count+=1,i.surface.length<e.word.length&&(i.surface=e.word)):n.set(r,{surface:e.word,base:r,reading:e.reading&&e.reading!=="*"?e.reading:e.word,count:1})}),[...n.values()].sort((e,r)=>r.count-e.count)},Ae=async()=>{k.dataset.state="loading",k.textContent="本文を読み込み、解析しています…",await yt.waitReady();const t=await Ce(),n=yt.query(t),e=Ee(n),r=$e(e);T={rawTokens:n,tokens:e,stats:r,totalTokens:n.length,nounCount:r.reduce((i,o)=>i+o.count,0)},k.dataset.state="ready",k.textContent=`解析完了：トークン ${T.totalTokens.toLocaleString()}件／抽出名詞 ${T.stats.length}語`,Le(),Te()},Le=()=>{T&&(Ct.innerHTML=`
    <li>総トークン: ${T.totalTokens.toLocaleString()} 件</li>
    <li>抽出名詞: ${T.stats.length.toLocaleString()} 語</li>
    <li>名詞出現総数: ${T.nounCount.toLocaleString()} 回</li>
  `)},Te=()=>{if(!T)return;const t=T.stats.slice(0,20);Et.innerHTML=t.map(n=>`
        <tr>
          <td>${pt(n.base)}</td>
          <td>${pt(n.reading)}</td>
          <td>${n.count}</td>
        </tr>
      `).join("")},pt=t=>t.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;"),Pe=(t,n,e)=>{const r=[],i=M.getContext("2d");if(!i)return r;const o=M.width,s=M.height,l=o/2,d=s/2,c=Math.PI*(3-Math.sqrt(5)),g=20,w=8,x=f=>r.some(m=>{const u={x:m.x-w/2,y:m.y-w/2,width:m.width+w,height:m.height+w};return!(f.x+f.width<u.x||f.x>u.x+u.width||f.y+f.height<u.y||f.y>u.y+u.height)});return t.forEach((f,m)=>{const a=18+(f.count-n)/Math.max(1,e-n)*46;i.font=`700 ${a}px 'Noto Sans JP', 'Hiragino Kaku Gothic ProN', sans-serif`;const y=i.measureText(f.base).width,v=a*1.05;let p=m*c,_=g*Math.sqrt(m+1),C=0,E=0,b=0,N;do{const S=_*Math.cos(p),P=_*Math.sin(p);E=l+S-y/2,b=d+P-v/2,N={x:E,y:b,width:y,height:v},_+=g*.3,p+=c*.05,C+=1}while(x(N)&&C<800);N.x=Math.min(Math.max(0,N.x),o-y),N.y=Math.min(Math.max(0,N.y),s-v),r.push({stat:f,x:N.x,y:N.y,width:y,height:v,fontSize:a,color:nt[m%nt.length]})}),r},Ie=t=>{const n=M.getContext("2d");n&&(n.clearRect(0,0,M.width,M.height),n.fillStyle="rgba(15, 23, 42, 0.9)",n.fillRect(0,0,M.width,M.height),n.textBaseline="top",t.slice().sort((e,r)=>e.fontSize-r.fontSize).forEach(e=>{n.font=`700 ${e.fontSize}px 'Noto Sans JP', 'Hiragino Kaku Gothic ProN', sans-serif`;const r=n.createLinearGradient(e.x,e.y,e.x,e.y+e.height);r.addColorStop(0,e.color),r.addColorStop(1,`${e.color}cc`),n.fillStyle=r,n.fillText(e.stat.base,e.x,e.y)}))},qt=()=>{var o,s;if(!T)return;const t=Number.parseInt($t.value,10)||1,n=Number.parseInt(At.value,10)||120,e=T.stats.filter(l=>l.count>=t).slice(0,n);if(!e.length){B.dataset.state="error",B.textContent="指定条件を満たす語がありません。閾値を下げてください。",J=[],rt.disabled=!0;return}B.dataset.state="loading",B.textContent=`レイアウト計算中…（${e.length} 語）`;const r=((o=e[0])==null?void 0:o.count)??1,i=((s=e[e.length-1])==null?void 0:s.count)??1;J=Pe(e,i,r),Ie(J),B.dataset.state="ready",B.textContent=`生成済み：${e.length} 語`,U.textContent="",rt.disabled=!1},qe=(t,n)=>{const e=new Map;let r=[];const i=()=>{if(!r.length)return;const o=[...new Set(r)];for(let s=0;s<o.length;s+=1)for(let l=s+1;l<o.length;l+=1){const d=o[s],c=o[l];if(!n.has(d)||!n.has(c))continue;const g=d<c?`${d}__${c}`:`${c}__${d}`;e.set(g,(e.get(g)??0)+1)}r=[]};return t.forEach(o=>{if(o.pos==="名詞"){if(o.pos_detail1==="数"||o.pos_detail1==="非自立"||o.pos_detail1==="代名詞")return;const s=o.dictionary_form&&o.dictionary_form!=="*"?o.dictionary_form:o.word;if(!s||St.has(s)||s.length<=1)return;r.push(s);return}o.pos==="記号"&&Me.has(o.word)&&i()}),i(),e},zt=()=>{var u;if(!T)return;const t=Number.parseInt(Tt.value,10)||3,n=Number.parseInt(Pt.value,10)||45;q.dataset.state="loading",q.textContent="共起ネットワークを構築しています…";const e=T.stats.slice(0,n),r=new Set(e.map(a=>a.base)),o=[...qe(T.rawTokens,r).entries()].sort((a,h)=>h[1]-a[1]);let s=t,l=[];for(;s>=1&&(l=o.filter(([,a])=>a>=s).map(([a,h])=>{const[y,v]=a.split("__");return{source:y,target:v,weight:h}}),!(l.length||s===1));)s-=1;if(!l.length){q.dataset.state="error",q.textContent="共起が見つかりませんでした。条件を見直してください。",R=[],H=[],xt();return}s!==t&&(q.dataset.state="loading",q.textContent=`指定された最小共起回数では共起が見つかりませんでした。閾値 ${s} で生成しています。`);const d=new Map;e.forEach(a=>d.set(a.base,a));const c=new Set;l.forEach(a=>{c.add(a.source),c.add(a.target)});const g=e.filter(a=>c.has(a.base)),w=((u=g[0])==null?void 0:u.count)??1,x=g.map((a,h)=>({id:a.base,label:a.base,reading:a.reading,count:a.count,radius:18+a.count/w*24,color:nt[h%nt.length]})),f=l.map(a=>({source:a.source,target:a.target,weight:a.weight})),m=ve(x).force("link",oe(f).id(a=>a.id).distance(a=>220-Math.min(150,a.weight*12)).strength(.9)).force("charge",_e().strength(-320)).force("center",Ot($.width/2,$.height/2)).force("collide",re().radius(a=>a.radius+16).strength(1));m.stop();for(let a=0;a<360;a+=1)m.tick();R=x.map(a=>({id:a.id,label:a.label,reading:a.reading,count:a.count,radius:a.radius,color:a.color,x:typeof a.x=="number"?a.x:$.width/2,y:typeof a.y=="number"?a.y:$.height/2})),H=f.map(a=>({source:typeof a.source=="string"?a.source:a.source.id,target:typeof a.target=="string"?a.target:a.target.id,weight:a.weight})),xt(),q.dataset.state="ready",q.textContent=`生成済み：ノード ${R.length} 件／エッジ ${H.length} 本${s!==t?`（閾値 ${s} へ自動調整）`:""}`,F.textContent=""},xt=()=>{const t=$.getContext("2d");if(!t||(t.clearRect(0,0,$.width,$.height),t.fillStyle="#f8fafc",t.fillRect(0,0,$.width,$.height),!R.length))return;const n=H.reduce((e,r)=>Math.max(e,r.weight),1);t.lineCap="round",H.forEach(e=>{const r=R.find(l=>l.id===e.source),i=R.find(l=>l.id===e.target);if(!r||!i)return;const o=1+e.weight/n*4,s=t.createLinearGradient(r.x,r.y,i.x,i.y);s.addColorStop(0,`${r.color}bb`),s.addColorStop(1,`${i.color}bb`),t.strokeStyle=s,t.lineWidth=o,t.beginPath(),t.moveTo(r.x,r.y),t.lineTo(i.x,i.y),t.stroke()}),t.textAlign="center",t.textBaseline="middle",R.forEach(e=>{const r=t.createRadialGradient(e.x,e.y,e.radius*.1,e.x,e.y,e.radius);r.addColorStop(0,`${e.color}ff`),r.addColorStop(1,`${e.color}aa`),t.fillStyle=r,t.beginPath(),t.arc(e.x,e.y,e.radius,0,Math.PI*2),t.fill(),t.fillStyle="#0f172a",t.font=`600 ${Math.max(14,e.radius*.7)}px 'Noto Sans JP', 'Hiragino Kaku Gothic ProN', sans-serif`,t.fillText(e.label,e.x,e.y)})},ze=()=>{const t=document.createElement("canvas");t.width=M.width,t.height=M.height;const n=t.getContext("2d"),e=M.getContext("2d");!n||!e||(n.fillStyle="#ffffff",n.fillRect(0,0,t.width,t.height),n.drawImage(M,0,0),t.toBlob(r=>{if(!r)return;const i=URL.createObjectURL(r),o=document.createElement("a");o.href=i,o.download="ningen-wordcloud.png",o.click(),URL.revokeObjectURL(i)},"image/png"))},Rt=t=>{if(!J.length){U.textContent="";return}const n=M.getBoundingClientRect(),e=M.width/n.width,r=M.height/n.height,i=(t.clientX-n.left)*e,o=(t.clientY-n.top)*r,s=J.find(l=>i>=l.x&&i<=l.x+l.width&&o>=l.y&&o<=l.y+l.height);s?U.textContent=`${s.stat.base}（${s.stat.reading}）: ${s.stat.count} 回`:t.type==="mousemove"&&(U.textContent="")},jt=t=>{if(!R.length){F.textContent="";return}const n=$.getBoundingClientRect(),e=$.width/n.width,r=$.height/n.height,i=(t.clientX-n.left)*e,o=(t.clientY-n.top)*r,s=R.find(l=>{const d=i-l.x,c=o-l.y;return Math.sqrt(d*d+c*c)<=l.radius});if(s){const l=H.filter(d=>d.source===s.id||d.target===s.id).map(d=>d.source===s.id?d.target:d.source).join("、");F.textContent=`${s.label}（${s.reading}）: ${s.count} 回 / 共起: ${l||"なし"}`}else t.type==="mousemove"&&(F.textContent="")};Lt.addEventListener("click",qt);rt.addEventListener("click",ze);M.addEventListener("mousemove",Rt);M.addEventListener("click",Rt);M.addEventListener("mouseleave",()=>{U.textContent=""});It.addEventListener("click",zt);$.addEventListener("mousemove",jt);$.addEventListener("click",jt);$.addEventListener("mouseleave",()=>{F.textContent=""});Promise.resolve().then(()=>Ae()).then(()=>{qt(),zt()}).catch(t=>{k.dataset.state="error",k.textContent="初期化中にエラーが発生しました。コンソールをご確認ください。",console.error(t)});
