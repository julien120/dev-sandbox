(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))t(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const n of s.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&t(n)}).observe(document,{childList:!0,subtree:!0});function i(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function t(r){if(r.ep)return;r.ep=!0;const s=i(r);fetch(r.href,s)}})();class k{constructor(){Object.defineProperty(this,"data",{enumerable:!0,configurable:!0,writable:!0,value:[]})}writeByte(e){this.data.push(e&255)}writeUTFBytes(e){for(let i=0;i<e.length;i+=1)this.writeByte(e.charCodeAt(i))}writeBytes(e,i=0,t=e.length){for(let r=i;r<i+t;r+=1)this.writeByte(e[r])}getData(){return Uint8Array.from(this.data)}}class F{constructor(e,i,t,r){Object.defineProperty(this,"imgW",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"imgH",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"pixAry",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"initCodeSize",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"curAccum",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"curBits",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"masks",{enumerable:!0,configurable:!0,writable:!0,value:[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535]}),Object.defineProperty(this,"aCount",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"accum",{enumerable:!0,configurable:!0,writable:!0,value:new Uint8Array(256)}),this.imgW=e,this.imgH=i,this.pixAry=t,this.initCodeSize=Math.max(2,r)}encode(e){e.writeByte(this.initCodeSize),this.compress(this.initCodeSize+1,e),e.writeByte(0)}charOut(e,i){this.accum[this.aCount]=e,this.aCount+=1,this.aCount>=254&&this.flushChar(i)}flushChar(e){this.aCount>0&&(e.writeByte(this.aCount),e.writeBytes(this.accum,0,this.aCount),this.aCount=0)}clBlock(e,i,t,r,s,n){this.resetCodeTable(i),r.value=1<<t-1,s.value=!0;const a=1<<t-1;this.output(a,e,t,s),n.value=this.pixAry[0]&255}resetCodeTable(e){e.fill(-1)}compress(e,i){const r=new Int32Array(5003),s=new Int32Array(5003);this.resetCodeTable(r);let n=this.pixAry[0]&255;Math.max(0,Math.min(8,Math.floor(Math.log(this.initCodeSize)/Math.LN2)));const a=1<<e-1,u=a+1;let h=a+2,d=e,f=(1<<d)-1,c=!1;this.output(a,i,d,{value:c});const w={value:0},b={value:0},p={value:h},y={value:c},g=P=>{let v=P;return v+=v<<8>>>0,v^=v>>4,v%5003};for(let P=1;P<this.pixAry.length;P+=1){const v=this.pixAry[P]&255;w.value=(v<<12)+n;const L=g(w.value);if(b.value=L,r[b.value]===w.value){n=s[b.value];continue}if(r[b.value]>=0){let j=5003-b.value;b.value===0&&(j=1);do if(b.value-=j,b.value<0&&(b.value+=5003),r[b.value]===w.value){n=s[b.value];break}while(r[b.value]>=0);if(r[b.value]===w.value)continue}this.output(n,i,d,y),n=v,p.value<4096?(s[b.value]=p.value,r[b.value]=w.value,p.value+=1):(this.clBlock(i,r,d,p,y,{value:n}),n=v),p.value>f&&d<12&&(d+=1,f=(1<<d)-1)}this.output(n,i,d,y),this.output(u,i,d,y)}output(e,i,t,r){for(this.curAccum&=this.masks[this.curBits],this.curBits>0?this.curAccum|=e<<this.curBits:this.curAccum=e,this.curBits+=t;this.curBits>=8;)this.charOut(this.curAccum&255,i),this.curAccum>>=8,this.curBits-=8;r.value&&(this.curAccum=0,this.curBits=0,r.value=!1)}}class D{constructor(e,i){Object.defineProperty(this,"netsize",{enumerable:!0,configurable:!0,writable:!0,value:256}),Object.defineProperty(this,"network",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"bias",{enumerable:!0,configurable:!0,writable:!0,value:new Int32Array(this.netsize)}),Object.defineProperty(this,"freq",{enumerable:!0,configurable:!0,writable:!0,value:new Int32Array(this.netsize)}),Object.defineProperty(this,"radPower",{enumerable:!0,configurable:!0,writable:!0,value:new Int32Array(this.netsize>>3)}),Object.defineProperty(this,"netIndex",{enumerable:!0,configurable:!0,writable:!0,value:new Int32Array(256)});for(let t=0;t<this.netsize;t+=1){const r=(t<<16)/this.netsize;this.network[t]=[r,r,r],this.freq[t]=65536,this.bias[t]=0}this.learn(e,i),this.buildIndex()}learn(e,i){const t=e.length,r=30+(i-1)/3;let s=t/(3*i),n=0,a=1024,u=(this.netsize>>3)-1;s<this.netsize&&(s=this.netsize);let h=u>>3;h<=1&&(h=0);for(let c=0;c<h;c+=1)this.radPower[c]=a*((h*h-c*c)*256/(h*h));let d=0;t<1509?d=3:t%499!==0?d=499:t%491!==0?d=491:t%487!==0?d=487:d=503;let f=0;for(let c=0;c<s;c+=1){const w=e[f]&255,b=e[f+1]&255,p=e[f+2]&255,y=this.contest(w,b,p);if(this.alterSingle(a,y,w,b,p),h!==0&&this.alterNeigh(h,y,w,b,p),f+=d*3,f>=t&&(f-=t),n+=1,n%100===0){a-=a/r,u-=u/30,h=u>>3,h<=1&&(h=0);for(let g=0;g<h;g+=1)this.radPower[g]=a*((h*h-g*g)*256/(h*h))}}}buildIndex(){let e=0,i=0;for(let t=0;t<this.netsize;t+=1){const r=this.network[t];let s=t,n=r[1];for(let a=t+1;a<this.netsize;a+=1){const u=this.network[a];u[1]<n&&(s=a,n=u[1])}if(t!==s){const a=this.network[s];[this.network[t],this.network[s]]=[a,r]}if(n!==e){this.netIndex[e]=i+t>>1;for(let a=e+1;a<n;a+=1)this.netIndex[a]=t;e=n,i=t}}this.netIndex[e]=i+this.netsize-1>>1;for(let t=e+1;t<256;t+=1)this.netIndex[t]=this.netsize-1}contest(e,i,t){let r=-1,s=1<<31,n=s;for(let a=0;a<this.netsize;a+=1){const u=this.network[a],h=Math.abs(u[0]-e)+Math.abs(u[1]-i)+Math.abs(u[2]-t);h<s&&(s=h,r=a);const d=h-(this.bias[a]>>12);d<n&&(n=d,r=a),this.freq[a]-=this.freq[a]>>10,this.bias[a]+=this.freq[a]<<10}return this.freq[r]+=64,this.bias[r]-=65536,r}alterSingle(e,i,t,r,s){const n=this.network[i];n[0]-=e*(n[0]-t)/1024,n[1]-=e*(n[1]-r)/1024,n[2]-=e*(n[2]-s)/1024}alterNeigh(e,i,t,r,s){let n=Math.max(i-e,0),a=Math.min(i+e,this.netsize-1),u=i+1,h=i-1,d=1;for(;u<=a||h>=n;){const f=this.radPower[d++]/262144;if(u<=a){const c=this.network[u++];c[0]-=f*(c[0]-t),c[1]-=f*(c[1]-r),c[2]-=f*(c[2]-s)}if(h>=n){const c=this.network[h--];c[0]-=f*(c[0]-t),c[1]-=f*(c[1]-r),c[2]-=f*(c[2]-s)}}}map(e,i,t){let r=1073741824,s=-1;for(let n=0;n<this.netsize;n+=1){const a=this.network[n],u=Math.abs(a[0]-e)+Math.abs(a[1]-i)+Math.abs(a[2]-t);u<r&&(r=u,s=n)}return s}colorMap(){const e=this.network.map(t=>[Math.max(0,Math.min(255,Math.round(t[0]))),Math.max(0,Math.min(255,Math.round(t[1]))),Math.max(0,Math.min(255,Math.round(t[2])))]).sort((t,r)=>t[1]-r[1]),i=new Uint8Array(this.netsize*3);for(let t=0;t<e.length;t+=1){const r=e[t],s=t*3;i[s]=r[0],i[s+1]=r[1],i[s+2]=r[2]}return i}}class T{constructor(e,i){Object.defineProperty(this,"width",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"height",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"transparent",{enumerable:!0,configurable:!0,writable:!0,value:-1}),Object.defineProperty(this,"repeat",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"delay",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"started",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"out",{enumerable:!0,configurable:!0,writable:!0,value:new k}),Object.defineProperty(this,"image",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"indexedPixels",{enumerable:!0,configurable:!0,writable:!0,value:new Uint8Array(0)}),Object.defineProperty(this,"colorDepth",{enumerable:!0,configurable:!0,writable:!0,value:8}),Object.defineProperty(this,"colorTab",{enumerable:!0,configurable:!0,writable:!0,value:new Uint8Array(0)}),Object.defineProperty(this,"usedEntry",{enumerable:!0,configurable:!0,writable:!0,value:new Array(256).fill(!1)}),Object.defineProperty(this,"palSize",{enumerable:!0,configurable:!0,writable:!0,value:7}),Object.defineProperty(this,"sample",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(this,"dispose",{enumerable:!0,configurable:!0,writable:!0,value:-1}),Object.defineProperty(this,"firstFrame",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.width=e,this.height=i}setDelay(e){this.delay=Math.round(e/10)}setFrameRate(e){this.delay=Math.round(100/e)}setRepeat(e){this.repeat=e}setTransparent(e){this.transparent=e}setDispose(e){e>=0&&(this.dispose=e)}setQuality(e){e<1&&(e=1),this.sample=e}start(){this.writeString("GIF89a"),this.started=!0}addFrame(e){if(!this.started)throw new Error("Encoder not started.");return this.image=e.getImageData(0,0,this.width,this.height),this.analyzePixels(),this.firstFrame&&(this.writeLSD(),this.writePalette(),this.repeat>=0&&this.writeNetscapeExt()),this.writeGraphicCtrlExt(),this.writeImageDesc(),this.firstFrame||this.writePalette(),this.writePixels(),this.firstFrame=!1,!0}finish(){return this.started?(this.out.writeByte(59),this.started=!1,!0):!1}stream(){return this.out}analyzePixels(){if(!this.image)return;const e=this.image.data.length,i=new Uint8Array(e/4*3),t=this.image.data;let r=0;for(let u=0;u<e;u+=4)i[r++]=t[u],i[r++]=t[u+1],i[r++]=t[u+2];const s=new D(i,this.sample);this.colorTab=s.colorMap(),this.colorDepth=8,this.palSize=7;const n=this.colorTab.length/3;this.usedEntry=new Array(n).fill(!1),this.indexedPixels=new Uint8Array(this.width*this.height);let a=0;for(let u=0;u<this.width*this.height;u+=1){const h=t[a++],d=t[a++],f=t[a++];a++;const c=s.map(h,d,f);this.usedEntry[c]=!0,this.indexedPixels[u]=c}this.image=null}writeGraphicCtrlExt(){this.out.writeByte(33),this.out.writeByte(249),this.out.writeByte(4);let e=0,i=0;this.transparent>=0&&(e=1),this.dispose>=0&&(i=this.dispose&7),i<<=2,this.out.writeByte(i|e),this.writeShort(this.delay),this.out.writeByte(this.transparent>=0?this.transparent:0),this.out.writeByte(0)}writeImageDesc(){this.out.writeByte(44),this.writeShort(0),this.writeShort(0),this.writeShort(this.width),this.writeShort(this.height),this.firstFrame?this.out.writeByte(0):this.out.writeByte(128|this.palSize)}writeLSD(){this.writeShort(this.width),this.writeShort(this.height),this.out.writeByte(240|this.palSize),this.out.writeByte(0),this.out.writeByte(0)}writePalette(){this.out.writeBytes(this.colorTab);const e=3*256-this.colorTab.length;for(let i=0;i<e;i+=1)this.out.writeByte(0)}writePixels(){new F(this.width,this.height,this.indexedPixels,this.colorDepth).encode(this.out)}writeShort(e){this.out.writeByte(e&255),this.out.writeByte(e>>8&255)}writeString(e){this.out.writeUTFBytes(e)}writeNetscapeExt(){this.out.writeByte(33),this.out.writeByte(255),this.out.writeByte(11),this.writeString("NETSCAPE2.0"),this.out.writeByte(3),this.out.writeByte(1),this.writeShort(this.repeat),this.out.writeByte(0)}}const O=10*1024*1024,l={width:document.getElementById("width-range"),fps:document.getElementById("fps-range"),quality:document.getElementById("quality-range"),download:document.getElementById("download-link"),convert:document.getElementById("convert-button"),status:document.getElementById("status"),video:document.getElementById("preview-video"),canvas:document.getElementById("working-canvas")},z=document.getElementById("width-value"),q=document.getElementById("fps-value"),U=document.getElementById("quality-value"),B=document.getElementById("dropzone"),N=document.getElementById("file-input");let A=null,x=null;const M=()=>{z.textContent=`${l.width.value}px`,q.textContent=`${l.fps.value}fps`,U.textContent=`${l.quality.value}/8`};M();const m=(o,e=!1)=>{l.status.textContent=o,l.status.dataset.state=e?"error":"normal"},S=()=>{l.video.removeAttribute("src"),l.video.load(),l.convert.disabled=!0,l.download.setAttribute("aria-disabled","true"),l.download.removeAttribute("href"),m("動画ファイルを読み込んでください。")},C=o=>{if(!o.type.startsWith("video/")){m("対応していないファイル形式です。動画ファイルを選択してください。",!0);return}A=o,x&&(URL.revokeObjectURL(x),x=null),x=URL.createObjectURL(o),l.video.src=x,l.video.onloadedmetadata=()=>{l.video.currentTime=0,l.convert.disabled=!1;const e=Math.min(960,Math.round(l.video.videoWidth));l.width.max=String(Math.max(160,e)),l.width.value=String(Math.min(e,Number(l.width.value))),z.textContent=`${l.width.value}px`,m("動画が読み込まれました。設定を調整して「GIF を作成」を押してください。")},l.video.onerror=()=>{m("動画の読み込みに失敗しました。",!0),S()}},$=o=>{var e,i;o.preventDefault(),B.classList.remove("drag-over"),(i=(e=o.dataTransfer)==null?void 0:e.files)!=null&&i.length&&C(o.dataTransfer.files[0])},R=async(o,e,i)=>{const t=e.width,r=o.videoHeight/o.videoWidth,s=Math.round(t*r);l.canvas.width=t,l.canvas.height=s;const n=l.canvas.getContext("2d");if(!n)throw new Error("Canvas が利用できません。");const a=new T(t,s);a.setRepeat(0),a.setDelay(Math.round(1e3/e.fps)),a.setQuality(e.quality),a.start();const u=o.duration,h=Math.max(1,Math.floor(u*e.fps)),d=Math.round(1e3/e.fps);a.setDelay(d);for(let w=0;w<h;w+=1){if(i.aborted)throw new Error("処理が中断されました。");const b=Math.min(u,w/e.fps);await W(o,b),n.drawImage(o,0,0,t,s),a.addFrame(n),m(`フレームを処理中... (${w+1}/${h})`),await G()}a.finish();const f=a.stream().getData(),c=new Uint8Array(f.length);return c.set(f),new Blob([c.buffer],{type:"image/gif"})},W=(o,e)=>new Promise((i,t)=>{const r=()=>{o.removeEventListener("seeked",r),o.removeEventListener("error",s),i()},s=()=>{o.removeEventListener("seeked",r),o.removeEventListener("error",s),t(new Error("動画のシークに失敗しました。"))};o.addEventListener("seeked",r,{once:!0}),o.addEventListener("error",s,{once:!0}),o.currentTime=e}),G=()=>new Promise(o=>{requestAnimationFrame(()=>o())}),V=async(o,e,i)=>{let t=e.width,r=e.fps,s=0,n=null;for(;t>=160&&r>=5;){s+=1,m(`変換中... (試行 ${s})`);const a=await R(o,{...e,width:t,fps:r},i);if(a.size<=O)return{blob:a,width:t,fps:r,iterations:s};if(n=a,t>320){t=Math.floor(t*.85);continue}r=Math.max(5,r-2)}if(n)return{blob:n,width:t,fps:r,iterations:s};throw new Error("出力サイズを 10MB 以下に抑えられませんでした。設定を見直してください。")};let E=null;l.convert.addEventListener("click",async()=>{if(!(!A||!x)){E&&E.abort(),E=new AbortController,l.convert.disabled=!0,l.download.setAttribute("aria-disabled","true"),l.download.removeAttribute("href"),m("変換を開始しました...");try{l.video.pause(),l.video.currentTime=0;const o={width:Number.parseInt(l.width.value,10),fps:Number.parseInt(l.fps.value,10),quality:Number.parseInt(l.quality.value,10)},e=await V(l.video,o,E.signal),i=URL.createObjectURL(e.blob);l.download.href=i,l.download.download=`${A.name.replace(/\.[^.]+$/,"")||"output"}.gif`,l.download.setAttribute("aria-disabled","false"),m(e.blob.size<=O?`変換が完了しました！ (${I(e.blob.size)})`:`変換は完了しましたが 10MB を超えています (${I(e.blob.size)})。解像度やフレームレートを下げて再試行してください。`,e.blob.size>O)}catch(o){console.error(o),m(o instanceof Error?o.message:"変換中にエラーが発生しました。",!0)}finally{l.convert.disabled=!1,E=null}}});N.addEventListener("change",o=>{var i;const e=o.target;(i=e.files)!=null&&i.length&&C(e.files[0])});B.addEventListener("dragover",o=>{o.preventDefault(),B.classList.add("drag-over")});B.addEventListener("dragleave",()=>{B.classList.remove("drag-over")});B.addEventListener("drop",$);l.width.addEventListener("input",M);l.fps.addEventListener("input",M);l.quality.addEventListener("input",M);l.download.addEventListener("click",()=>{l.download.getAttribute("aria-disabled")!=="true"&&m("GIF をダウンロードしています...")});const I=o=>o<1024?`${o}B`:o<1024*1024?`${(o/1024).toFixed(1)}KB`:`${(o/(1024*1024)).toFixed(2)}MB`;S();
