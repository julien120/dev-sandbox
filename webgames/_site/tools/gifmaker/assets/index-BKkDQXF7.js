var pe=Object.defineProperty;var ee=e=>{throw TypeError(e)};var we=(e,t,r)=>t in e?pe(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var m=(e,t,r)=>we(e,typeof t!="symbol"?t+"":t,r),te=(e,t,r)=>t.has(e)||ee("Cannot "+r);var a=(e,t,r)=>(te(e,t,"read from private field"),r?r.call(e):t.get(e)),y=(e,t,r)=>t.has(e)?ee("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,r),B=(e,t,r,n)=>(te(e,t,"write to private field"),n?n.call(e,r):t.set(e,r),r);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const c of s.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&n(c)}).observe(document,{childList:!0,subtree:!0});function r(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(o){if(o.ep)return;o.ep=!0;const s=r(o);fetch(o.href,s)}})();var l;(function(e){e.LOAD="LOAD",e.EXEC="EXEC",e.WRITE_FILE="WRITE_FILE",e.READ_FILE="READ_FILE",e.DELETE_FILE="DELETE_FILE",e.RENAME="RENAME",e.CREATE_DIR="CREATE_DIR",e.LIST_DIR="LIST_DIR",e.DELETE_DIR="DELETE_DIR",e.ERROR="ERROR",e.DOWNLOAD="DOWNLOAD",e.PROGRESS="PROGRESS",e.LOG="LOG"})(l||(l={}));const ye=(()=>{let e=0;return()=>e++})(),be=new Error("ffmpeg is not loaded, call `await ffmpeg.load()` first"),Le=new Error("called FFmpeg.terminate()");var d,L,w,A,I,P,h;class ve{constructor(){y(this,d,null);y(this,L,{});y(this,w,{});y(this,A,[]);y(this,I,[]);m(this,"loaded",!1);y(this,P,()=>{a(this,d)&&(a(this,d).onmessage=({data:{id:t,type:r,data:n}})=>{switch(r){case l.LOAD:this.loaded=!0,a(this,L)[t](n);break;case l.EXEC:case l.WRITE_FILE:case l.READ_FILE:case l.DELETE_FILE:case l.RENAME:case l.CREATE_DIR:case l.LIST_DIR:case l.DELETE_DIR:a(this,L)[t](n);break;case l.LOG:a(this,A).forEach(o=>o(n));break;case l.PROGRESS:a(this,I).forEach(o=>o(n));break;case l.ERROR:a(this,w)[t](n);break}delete a(this,L)[t],delete a(this,w)[t]})});y(this,h,({type:t,data:r},n=[])=>a(this,d)?new Promise((o,s)=>{const c=ye();a(this,d)&&a(this,d).postMessage({id:c,type:t,data:r},n),a(this,L)[c]=o,a(this,w)[c]=s}):Promise.reject(be));m(this,"load",(t={})=>(a(this,d)||(B(this,d,new Worker(new URL("/dev-sandbox/tools/gifmaker/assets/worker-RjqUVU6j.js",import.meta.url),{type:"module"})),a(this,P).call(this)),a(this,h).call(this,{type:l.LOAD,data:t})));m(this,"exec",(t,r=-1)=>a(this,h).call(this,{type:l.EXEC,data:{args:t,timeout:r}}));m(this,"terminate",()=>{const t=Object.keys(a(this,w));for(const r of t)a(this,w)[r](Le),delete a(this,w)[r],delete a(this,L)[r];a(this,d)&&(a(this,d).terminate(),B(this,d,null),this.loaded=!1)});m(this,"writeFile",(t,r)=>{const n=[];return r instanceof Uint8Array&&n.push(r.buffer),a(this,h).call(this,{type:l.WRITE_FILE,data:{path:t,data:r}},n)});m(this,"readFile",(t,r="binary")=>a(this,h).call(this,{type:l.READ_FILE,data:{path:t,encoding:r}}));m(this,"deleteFile",t=>a(this,h).call(this,{type:l.DELETE_FILE,data:{path:t}}));m(this,"rename",(t,r)=>a(this,h).call(this,{type:l.RENAME,data:{oldPath:t,newPath:r}}));m(this,"createDir",t=>a(this,h).call(this,{type:l.CREATE_DIR,data:{path:t}}));m(this,"listDir",t=>a(this,h).call(this,{type:l.LIST_DIR,data:{path:t}}));m(this,"deleteDir",t=>a(this,h).call(this,{type:l.DELETE_DIR,data:{path:t}}))}on(t,r){t==="log"?a(this,A).push(r):t==="progress"&&a(this,I).push(r)}off(t,r){t==="log"?B(this,A,a(this,A).filter(n=>n!==r)):t==="progress"&&B(this,I,a(this,I).filter(n=>n!==r))}}d=new WeakMap,L=new WeakMap,w=new WeakMap,A=new WeakMap,I=new WeakMap,P=new WeakMap,h=new WeakMap;const K=10*1024*1024,re=500,J="/dev-sandbox/tools/gifmaker/ffmpeg/",ne=`${J}ffmpeg-core.js`,oe=`${J}ffmpeg-core.wasm`,Re=`${J}ffmpeg-core.worker.js`,i={width:document.getElementById("width-range"),fps:document.getElementById("fps-range"),quality:document.getElementById("quality-range"),download:document.getElementById("download-link"),convert:document.getElementById("convert-button"),status:document.getElementById("status"),video:document.getElementById("preview-video"),canvas:document.getElementById("working-canvas")},ae=document.getElementById("width-value"),Fe=document.getElementById("fps-value"),Ae=document.getElementById("quality-value"),M=document.getElementById("dropzone"),Ie=document.getElementById("file-input");let W=null,x=null,b=null,U=null;const v=[],se=e=>{v.push({type:e.type,message:String(e.message??"")}),v.length>re&&v.splice(0,v.length-re)},_e=e=>{var t;for(let r=e.length-1;r>=0;r-=1){const n=e[r];if(n.type!=="stderr")continue;const o=(t=n.message)==null?void 0:t.trim();if(!o)continue;const s=o.toLowerCase();return s.includes("error while opening input")?"動画の読み込みに失敗しました。対応していないコーデックまたはファイル破損の可能性があります。":s.includes("no such filter")?"必要なフィルタが利用できません。ブラウザを更新するかアプリを再読み込みして再試行してください。":s.includes("cannot find a matching stream")?"映像トラックが見つかりませんでした。別の動画ファイルでお試しください。":s.includes("invalid argument")?"FFmpeg のフィルタ指定に無効な値が含まれています。設定値を変更して再試行してください。":s.includes("decoding for stream")?"動画のデコードに失敗しました。形式を変換してから再度お試しください。":`詳細: ${o}`}return null},le=({progress:e})=>{const t=Number.isFinite(e)?e:0;f(`FFmpeg 変換中... ${(t*100).toFixed(1)}%`)},ce=e=>{se(e)},Y=()=>{if(b)try{b.off("progress",le),b.off("log",ce),b.terminate()}catch(e){console.warn("FFmpeg terminate error:",e)}finally{b=null}},De=async()=>{if(!b){if(U){await U;return}U=(async()=>{var r;f("FFmpeg モジュールを読み込んでいます...");const e=new ve;e.on("progress",le),e.on("log",ce),(r=e.setLogger)==null||r.call(e,({type:n,message:o})=>{se({type:n,message:o})}),console.info("[gifmaker] loading ffmpeg",{coreURL:ne,wasmURL:oe});const t={coreURL:ne,wasmURL:oe};t.workerURL=Re,await e.load(t),console.info("[gifmaker] ffmpeg loaded"),b=e})();try{await U}catch(e){throw Y(),e}finally{U=null}}},z=()=>{ae.textContent=`${i.width.value}px`,Fe.textContent=`${i.fps.value}fps`,Ae.textContent=`${i.quality.value}/8`};z();const f=(e,t=!1)=>{i.status.textContent=e,i.status.dataset.state=t?"error":"normal"},Oe=async e=>{if(e instanceof Uint8Array)return e;if(typeof e=="string")return new TextEncoder().encode(e);if(e instanceof Blob){const t=await e.arrayBuffer();return new Uint8Array(t)}if(e instanceof ArrayBuffer)return new Uint8Array(e);if(ArrayBuffer.isView(e))return new Uint8Array(e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength));throw new Error("入力データを Uint8Array に変換できませんでした。")},de=()=>{i.video.removeAttribute("src"),i.video.load(),i.convert.disabled=!0,i.download.setAttribute("aria-disabled","true"),i.download.removeAttribute("href"),f("動画ファイルを読み込んでください。")},fe=e=>{if(!e.type.startsWith("video/")){f("対応していないファイル形式です。動画ファイルを選択してください。",!0);return}W=e,x&&(URL.revokeObjectURL(x),x=null),x=URL.createObjectURL(e),i.video.src=x,i.video.onloadedmetadata=()=>{i.video.currentTime=0,i.convert.disabled=!1;const t=Math.min(960,Math.round(i.video.videoWidth));i.width.max=String(Math.max(160,t)),i.width.value=String(Math.min(t,Number(i.width.value))),ae.textContent=`${i.width.value}px`,f("動画が読み込まれました。設定を調整して「GIF を作成」を押してください。")},i.video.onerror=()=>{f("動画の読み込みに失敗しました。",!0),de()}},xe=e=>{if(!e)return null;if(e.files&&e.files.length>0)return e.files[0]??null;if(e.items){for(const t of Array.from(e.items))if(t.kind==="file"){const r=t.getAsFile();if(r)return r}}return null},Me=e=>{e.preventDefault(),M.classList.remove("drag-over");const t=xe(e.dataTransfer??null);t?fe(t):f("ファイルをドロップしてください。フォルダは利用できません。",!0)},ke=(e,t,r)=>{const n=["none","floyd_steinberg","sierra2","sierra2_4a","bayer:bayer_scale=5:diffusion=1","bayer:bayer_scale=4:diffusion=1","bayer:bayer_scale=3:diffusion=1","bayer:bayer_scale=2:diffusion=1"],o=Math.min(n.length-1,Math.max(0,Math.round(r)-1)),s=n[o];return[`scale=${t}:-1:flags=lanczos`,`fps=${e}`,"format=rgba","split[s0][s1]","[s0]palettegen=stats_mode=full:reserve_transparent=0[p]",`[s1][p]paletteuse=new=1:dither=${s}`].join(",")},$e=async(e,t,r)=>{await De();const n=b;if(!n)throw new Error("FFmpeg の初期化に失敗しました。");const s=Math.max(160,Math.round(t.width)),c=s%2===0?s:s+1,_=Math.max(1,Math.round(t.fps)),R=Math.max(1,Math.round(t.quality)),g=`input-${Date.now()}.mp4`,E=`output-${Date.now()}.gif`;let F=!1;const p=()=>{F=!0,Y()};r.addEventListener("abort",p,{once:!0});try{f("FFmpeg で GIF を生成しています..."),v.length=0;const u=await Oe(e);console.info("[gifmaker] writeFile",{inputName:g,byteLength:u.byteLength}),await n.writeFile(g,u);const D=async(O,S)=>{console.log("[gifmaker] exec",{label:O,args:S});const T=await n.exec(S);if(T!==0){const H=new Error(`FFmpeg の実行に失敗しました (コード: ${T})。`);throw H.ffmpegLabel=O,H.ffmpegArgs=S,H}},N=ke(_,c,R);console.info("[gifmaker] filter",N);const k=`scale=${c}:-1:flags=lanczos,fps=${_}`,Q=Date.now(),q=`probe-${Q}.gif`,j=`tmp-${Q}.mp4`,ue=["-i",g,"-vf",N,"-loop","0",E],me=["-i",g,"-vf",k,"-loop","0",E],he=["-i",g,"-t","2","-vf",k,"-loop","0",q],ge=["-i",g,"-vf",`${k},format=yuv420p`,"-an","-c:v","mpeg4",j],Ee=["-i",j,"-vf",N,"-loop","0",E],G=async O=>{try{await n.deleteFile(O)}catch{}};try{await D("palette",ue)}catch(O){console.warn("[gifmaker] palette pipeline failed, trying simple pipeline",O);try{await D("simple-probe",he),await G(q),await D("simple",me)}catch(S){await G(q),console.warn("[gifmaker] simple pipeline failed, trying transcode fallback",S);try{await D("transcode",ge),await D("palette-from-transcode",Ee)}catch(T){throw console.warn("[gifmaker] transcode fallback failed",T),T}finally{await G(j)}}}const $=await n.readFile(E),Z=$ instanceof Uint8Array?$:new TextEncoder().encode(typeof $=="string"?$:String($)),V=new Uint8Array(Z.byteLength);return V.set(Z),console.info("[gifmaker] readFile",{outputName:E,size:V.byteLength}),new Blob([V.buffer],{type:"image/gif"})}catch(u){throw F?new Error("処理が中断されました。"):(console.error("[gifmaker] ffmpeg error",u),console.warn("[gifmaker] ffmpeg logs",v.length,v),Y(),u)}finally{if(r.removeEventListener("abort",p),n.loaded){try{await n.deleteFile(g)}catch(u){console.warn("Failed to remove input from FFmpeg FS",u)}try{await n.deleteFile(E)}catch(u){console.warn("Failed to remove output from FFmpeg FS",u)}}}},Se=async(e,t,r)=>{let n=Math.max(160,Math.round(t.width)),o=Math.max(1,Math.round(t.fps));const s=Math.max(1,Math.round(t.quality));let c=0,_=null,R=null;const g=()=>n>320?(n=Math.max(160,Math.floor(n*.85)),!0):!1,E=()=>o>5?(o=Math.max(5,o-2),!0):!1;for(;n>=160&&o>=5;){c+=1,f(`変換中... (試行 ${c})`);let F;try{F=await $e(e,{width:n,fps:o,quality:s},r)}catch(p){if(R=p,r.aborted)throw p;const u=p instanceof Error?p.message:String(p);if((u.includes("FFmpeg の実行に失敗しました")||u.includes("Aborted"))&&(g()||E())){console.warn("[gifmaker] retrying with reduced settings",{width:n,fps:o}),await new Promise(k=>setTimeout(k,0));continue}throw p}if(F.size<=K)return{blob:F,width:n,fps:o,iterations:c};if(_=F,!g()&&!E())break}if(_)return{blob:_,width:n,fps:o,iterations:c};throw R?R instanceof Error?R:new Error(String(R)):new Error("出力サイズを 10MB 以下に抑えられませんでした。設定を見直してください。")};let C=null;i.convert.addEventListener("click",async()=>{if(!W||!x)return;C&&C.abort();const e=new AbortController;C=e,i.convert.disabled=!0,i.download.setAttribute("aria-disabled","true"),i.download.removeAttribute("href"),f("変換を開始しました...");try{i.video.pause(),i.video.currentTime=0,await Be(i.video);const t={width:X(i.width.value,i.video.videoWidth||480,160,960),fps:X(i.fps.value,12,1,60),quality:X(i.quality.value,6,1,8)},r=await Se(W,t,e.signal),n=URL.createObjectURL(r.blob);i.download.href=n,i.download.download=`${W.name.replace(/\.[^.]+$/,"")||"output"}.gif`,i.download.setAttribute("aria-disabled","false"),f(r.blob.size<=K?`変換が完了しました！ (${ie(r.blob.size)})`:`変換は完了しましたが 10MB を超えています (${ie(r.blob.size)})。解像度やフレームレートを下げて再試行してください。`,r.blob.size>K)}catch(t){console.error(t);let r=t instanceof Error?t.message:"変換中にエラーが発生しました。";const n=_e(v);n&&(r=`${r} ${n}`),f(r,!0)}finally{C===e&&(C=null),i.convert.disabled=!1}});Ie.addEventListener("change",e=>{var r;const t=e.target;(r=t.files)!=null&&r.length&&fe(t.files[0])});M.addEventListener("dragover",e=>{e.preventDefault(),M.classList.add("drag-over")});M.addEventListener("dragleave",()=>{M.classList.remove("drag-over")});M.addEventListener("drop",Me);i.width.addEventListener("input",z);i.fps.addEventListener("input",z);i.quality.addEventListener("input",z);i.download.addEventListener("click",()=>{i.download.getAttribute("aria-disabled")!=="true"&&f("GIF をダウンロードしています...")});const ie=e=>e<1024?`${e}B`:e<1024*1024?`${(e/1024).toFixed(1)}KB`:`${(e/(1024*1024)).toFixed(2)}MB`,X=(e,t,r=0,n=Number.POSITIVE_INFINITY)=>{const o=Number.parseFloat(e);return Number.isFinite(o)?Math.min(Math.max(o,r),n):t};de();const Te=(e,t)=>new Promise(r=>{const n=o=>{e.removeEventListener(t,n),r(o)};e.addEventListener(t,n,{once:!0})}),Be=async e=>{if(e.readyState<HTMLMediaElement.HAVE_METADATA&&await Te(e,"loadedmetadata"),(e.videoWidth===0||e.videoHeight===0)&&await new Promise(t=>requestAnimationFrame(t)),e.videoWidth===0||e.videoHeight===0)throw new Error("動画のメタデータを取得できませんでした。別のファイルでお試しください。");if(!Number.isFinite(e.duration)||e.duration<=0)throw new Error("動画の長さが不正です。")};
