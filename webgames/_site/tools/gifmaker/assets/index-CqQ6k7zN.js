(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))i(t);new MutationObserver(t=>{for(const a of t)if(a.type==="childList")for(const n of a.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function r(t){const a={};return t.integrity&&(a.integrity=t.integrity),t.referrerPolicy&&(a.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?a.credentials="include":t.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(t){if(t.ep)return;t.ep=!0;const a=r(t);fetch(t.href,a)}})();class k{constructor(){Object.defineProperty(this,"data",{enumerable:!0,configurable:!0,writable:!0,value:[]})}writeByte(e){this.data.push(e&255)}writeUTFBytes(e){for(let r=0;r<e.length;r+=1)this.writeByte(e.charCodeAt(r))}writeBytes(e,r=0,i=e.length){for(let t=r;t<r+i;t+=1)this.writeByte(e[t])}getData(){return Uint8Array.from(this.data)}}class F{constructor(e,r,i,t){Object.defineProperty(this,"imgW",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"imgH",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"pixAry",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"initCodeSize",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"curAccum",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"curBits",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"masks",{enumerable:!0,configurable:!0,writable:!0,value:[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535]}),Object.defineProperty(this,"aCount",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"accum",{enumerable:!0,configurable:!0,writable:!0,value:new Uint8Array(256)}),this.imgW=e,this.imgH=r,this.pixAry=i,this.initCodeSize=Math.max(2,t)}encode(e){e.writeByte(this.initCodeSize),this.compress(this.initCodeSize+1,e),e.writeByte(0)}charOut(e,r){this.accum[this.aCount]=e,this.aCount+=1,this.aCount>=254&&this.flushChar(r)}flushChar(e){this.aCount>0&&(e.writeByte(this.aCount),e.writeBytes(this.accum,0,this.aCount),this.aCount=0)}clBlock(e,r,i,t,a,n){this.resetCodeTable(r),t.value=1<<i-1,a.value=!0;const s=1<<i-1;this.output(s,e,i,a),n.value=this.pixAry[0]&255}resetCodeTable(e){e.fill(-1)}compress(e,r){const t=new Int32Array(5003),a=new Int32Array(5003);this.resetCodeTable(t);let n=this.pixAry[0]&255;Math.max(0,Math.min(8,Math.floor(Math.log(this.initCodeSize)/Math.LN2)));const s=1<<e-1,u=s+1;let h=s+2,d=e,f=(1<<d)-1,c=!1;this.output(s,r,d,{value:c});const w={value:0},b={value:0},p={value:h},y={value:c},g=P=>{let v=P;return v+=v<<8>>>0,v^=v>>4,v%5003};for(let P=1;P<this.pixAry.length;P+=1){const v=this.pixAry[P]&255;w.value=(v<<12)+n;const M=g(w.value);if(b.value=M,t[b.value]===w.value){n=a[b.value];continue}if(t[b.value]>=0){let I=5003-b.value;b.value===0&&(I=1);do if(b.value-=I,b.value<0&&(b.value+=5003),t[b.value]===w.value){n=a[b.value];break}while(t[b.value]>=0);if(t[b.value]===w.value)continue}this.output(n,r,d,y),n=v,p.value<4096?(a[b.value]=p.value,t[b.value]=w.value,p.value+=1):(this.clBlock(r,t,d,p,y,{value:n}),n=v),p.value>f&&d<12&&(d+=1,f=(1<<d)-1)}this.output(n,r,d,y),this.output(u,r,d,y)}output(e,r,i,t){for(this.curAccum&=this.masks[this.curBits],this.curBits>0?this.curAccum|=e<<this.curBits:this.curAccum=e,this.curBits+=i;this.curBits>=8;)this.charOut(this.curAccum&255,r),this.curAccum>>=8,this.curBits-=8;t.value&&(this.curAccum=0,this.curBits=0,t.value=!1)}}class D{constructor(e,r){Object.defineProperty(this,"netsize",{enumerable:!0,configurable:!0,writable:!0,value:256}),Object.defineProperty(this,"network",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"bias",{enumerable:!0,configurable:!0,writable:!0,value:new Int32Array(this.netsize)}),Object.defineProperty(this,"freq",{enumerable:!0,configurable:!0,writable:!0,value:new Int32Array(this.netsize)}),Object.defineProperty(this,"radPower",{enumerable:!0,configurable:!0,writable:!0,value:new Int32Array(this.netsize>>3)}),Object.defineProperty(this,"netIndex",{enumerable:!0,configurable:!0,writable:!0,value:new Int32Array(256)});for(let i=0;i<this.netsize;i+=1){const t=(i<<16)/this.netsize;this.network[i]=[t,t,t],this.freq[i]=65536,this.bias[i]=0}this.learn(e,r),this.buildIndex()}learn(e,r){const i=e.length,t=30+(r-1)/3;let a=i/(3*r),n=0,s=1024,u=(this.netsize>>3)-1;a<this.netsize&&(a=this.netsize);let h=u>>3;h<=1&&(h=0);for(let c=0;c<h;c+=1)this.radPower[c]=s*((h*h-c*c)*256/(h*h));let d=0;i<1509?d=3:i%499!==0?d=499:i%491!==0?d=491:i%487!==0?d=487:d=503;let f=0;for(let c=0;c<a;c+=1){const w=e[f]&255,b=e[f+1]&255,p=e[f+2]&255,y=this.contest(w,b,p);if(this.alterSingle(s,y,w,b,p),h!==0&&this.alterNeigh(h,y,w,b,p),f+=d*3,f>=i&&(f-=i),n+=1,n%100===0){s-=s/t,u-=u/30,h=u>>3,h<=1&&(h=0);for(let g=0;g<h;g+=1)this.radPower[g]=s*((h*h-g*g)*256/(h*h))}}}buildIndex(){let e=0,r=0;for(let i=0;i<this.netsize;i+=1){const t=this.network[i];let a=i,n=t[1];for(let s=i+1;s<this.netsize;s+=1){const u=this.network[s];u[1]<n&&(a=s,n=u[1])}if(i!==a){const s=this.network[a];[this.network[i],this.network[a]]=[s,t]}if(n!==e){this.netIndex[e]=r+i>>1;for(let s=e+1;s<n;s+=1)this.netIndex[s]=i;e=n,r=i}}this.netIndex[e]=r+this.netsize-1>>1;for(let i=e+1;i<256;i+=1)this.netIndex[i]=this.netsize-1}contest(e,r,i){let t=-1,a=1<<31,n=a;for(let s=0;s<this.netsize;s+=1){const u=this.network[s],h=Math.abs(u[0]-e)+Math.abs(u[1]-r)+Math.abs(u[2]-i);h<a&&(a=h,t=s);const d=h-(this.bias[s]>>12);d<n&&(n=d,t=s),this.freq[s]-=this.freq[s]>>10,this.bias[s]+=this.freq[s]<<10}return this.freq[t]+=64,this.bias[t]-=65536,t}alterSingle(e,r,i,t,a){const n=this.network[r];n[0]-=e*(n[0]-i)/1024,n[1]-=e*(n[1]-t)/1024,n[2]-=e*(n[2]-a)/1024}alterNeigh(e,r,i,t,a){let n=Math.max(r-e,0),s=Math.min(r+e,this.netsize-1),u=r+1,h=r-1,d=1;for(;u<=s||h>=n;){const f=this.radPower[d++]/262144;if(u<=s){const c=this.network[u++];c[0]-=f*(c[0]-i),c[1]-=f*(c[1]-t),c[2]-=f*(c[2]-a)}if(h>=n){const c=this.network[h--];c[0]-=f*(c[0]-i),c[1]-=f*(c[1]-t),c[2]-=f*(c[2]-a)}}}map(e,r,i){let t=1073741824,a=-1;for(let n=0;n<this.netsize;n+=1){const s=this.network[n],u=Math.abs(s[0]-e)+Math.abs(s[1]-r)+Math.abs(s[2]-i);u<t&&(t=u,a=n)}return a}colorMap(){const e=new Uint8Array(this.netsize*3);for(let r=0;r<this.netsize;r+=1){const i=this.netIndex[r],t=this.network[i];e[r*3+0]=t[0],e[r*3+1]=t[1],e[r*3+2]=t[2]}return e}}class T{constructor(e,r){Object.defineProperty(this,"width",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"height",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"transparent",{enumerable:!0,configurable:!0,writable:!0,value:-1}),Object.defineProperty(this,"repeat",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"delay",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"started",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"out",{enumerable:!0,configurable:!0,writable:!0,value:new k}),Object.defineProperty(this,"image",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"indexedPixels",{enumerable:!0,configurable:!0,writable:!0,value:new Uint8Array(0)}),Object.defineProperty(this,"colorDepth",{enumerable:!0,configurable:!0,writable:!0,value:8}),Object.defineProperty(this,"colorTab",{enumerable:!0,configurable:!0,writable:!0,value:new Uint8Array(0)}),Object.defineProperty(this,"usedEntry",{enumerable:!0,configurable:!0,writable:!0,value:new Array(256).fill(!1)}),Object.defineProperty(this,"palSize",{enumerable:!0,configurable:!0,writable:!0,value:7}),Object.defineProperty(this,"sample",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(this,"dispose",{enumerable:!0,configurable:!0,writable:!0,value:-1}),Object.defineProperty(this,"firstFrame",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.width=e,this.height=r}setDelay(e){this.delay=Math.round(e/10)}setFrameRate(e){this.delay=Math.round(100/e)}setRepeat(e){this.repeat=e}setTransparent(e){this.transparent=e}setDispose(e){e>=0&&(this.dispose=e)}setQuality(e){e<1&&(e=1),this.sample=e}start(){this.writeString("GIF89a"),this.started=!0}addFrame(e){if(!this.started)throw new Error("Encoder not started.");return this.image=e.getImageData(0,0,this.width,this.height),this.analyzePixels(),this.firstFrame&&(this.writeLSD(),this.writePalette(),this.repeat>=0&&this.writeNetscapeExt()),this.writeGraphicCtrlExt(),this.writeImageDesc(),this.firstFrame||this.writePalette(),this.writePixels(),this.firstFrame=!1,!0}finish(){return this.started?(this.out.writeByte(59),this.started=!1,!0):!1}stream(){return this.out}analyzePixels(){if(!this.image)return;const e=this.image.data.length,r=new Uint8Array(e/4*3),i=this.image.data;let t=0;for(let u=0;u<e;u+=4)r[t++]=i[u],r[t++]=i[u+1],r[t++]=i[u+2];const a=new D(r,this.sample);this.colorTab=a.colorMap(),this.colorDepth=8,this.palSize=7;const n=this.colorTab.length/3;this.usedEntry=new Array(n).fill(!1),this.indexedPixels=new Uint8Array(this.width*this.height);let s=0;for(let u=0;u<this.width*this.height;u+=1){const h=i[s++],d=i[s++],f=i[s++];s++;const c=a.map(h,d,f);this.usedEntry[c]=!0,this.indexedPixels[u]=c}this.image=null}writeGraphicCtrlExt(){this.out.writeByte(33),this.out.writeByte(249),this.out.writeByte(4);let e=0,r=0;this.transparent>=0&&(e=1),this.dispose>=0&&(r=this.dispose&7),r<<=2,this.out.writeByte(r|e),this.writeShort(this.delay),this.out.writeByte(this.transparent>=0?this.transparent:0),this.out.writeByte(0)}writeImageDesc(){this.out.writeByte(44),this.writeShort(0),this.writeShort(0),this.writeShort(this.width),this.writeShort(this.height),this.firstFrame?this.out.writeByte(0):this.out.writeByte(128|this.palSize)}writeLSD(){this.writeShort(this.width),this.writeShort(this.height),this.out.writeByte(240|this.palSize),this.out.writeByte(0),this.out.writeByte(0)}writePalette(){this.out.writeBytes(this.colorTab);const e=3*256-this.colorTab.length;for(let r=0;r<e;r+=1)this.out.writeByte(0)}writePixels(){new F(this.width,this.height,this.indexedPixels,this.colorDepth).encode(this.out)}writeShort(e){this.out.writeByte(e&255),this.out.writeByte(e>>8&255)}writeString(e){this.out.writeUTFBytes(e)}writeNetscapeExt(){this.out.writeByte(33),this.out.writeByte(255),this.out.writeByte(11),this.writeString("NETSCAPE2.0"),this.out.writeByte(3),this.out.writeByte(1),this.writeShort(this.repeat),this.out.writeByte(0)}}const j=10*1024*1024,l={width:document.getElementById("width-range"),fps:document.getElementById("fps-range"),quality:document.getElementById("quality-range"),download:document.getElementById("download-link"),convert:document.getElementById("convert-button"),status:document.getElementById("status"),video:document.getElementById("preview-video"),canvas:document.getElementById("working-canvas")},S=document.getElementById("width-value"),q=document.getElementById("fps-value"),U=document.getElementById("quality-value"),B=document.getElementById("dropzone"),N=document.getElementById("file-input");let A=null,x=null;const O=()=>{S.textContent=`${l.width.value}px`,q.textContent=`${l.fps.value}fps`,U.textContent=`${l.quality.value}/8`};O();const m=(o,e=!1)=>{l.status.textContent=o,l.status.dataset.state=e?"error":"normal"},C=()=>{l.video.removeAttribute("src"),l.video.load(),l.convert.disabled=!0,l.download.setAttribute("aria-disabled","true"),l.download.removeAttribute("href"),m("動画ファイルを読み込んでください。")},L=o=>{if(!o.type.startsWith("video/")){m("対応していないファイル形式です。動画ファイルを選択してください。",!0);return}A=o,x&&(URL.revokeObjectURL(x),x=null),x=URL.createObjectURL(o),l.video.src=x,l.video.onloadedmetadata=()=>{l.video.currentTime=0,l.convert.disabled=!1;const e=Math.min(960,Math.round(l.video.videoWidth));l.width.max=String(Math.max(160,e)),l.width.value=String(Math.min(e,Number(l.width.value))),S.textContent=`${l.width.value}px`,m("動画が読み込まれました。設定を調整して「GIF を作成」を押してください。")},l.video.onerror=()=>{m("動画の読み込みに失敗しました。",!0),C()}},$=o=>{var e,r;o.preventDefault(),B.classList.remove("drag-over"),(r=(e=o.dataTransfer)==null?void 0:e.files)!=null&&r.length&&L(o.dataTransfer.files[0])},R=async(o,e,r)=>{const i=e.width,t=o.videoHeight/o.videoWidth,a=Math.round(i*t);l.canvas.width=i,l.canvas.height=a;const n=l.canvas.getContext("2d");if(!n)throw new Error("Canvas が利用できません。");const s=new T(i,a);s.setRepeat(0),s.setDelay(Math.round(1e3/e.fps)),s.setQuality(e.quality),s.start();const u=o.duration,h=Math.max(1,Math.floor(u*e.fps)),d=Math.round(1e3/e.fps);s.setDelay(d);for(let w=0;w<h;w+=1){if(r.aborted)throw new Error("処理が中断されました。");const b=Math.min(u,w/e.fps);await W(o,b),n.drawImage(o,0,0,i,a),s.addFrame(n),m(`フレームを処理中... (${w+1}/${h})`),await G()}s.finish();const f=s.stream().getData(),c=new Uint8Array(f.length);return c.set(f),new Blob([c.buffer],{type:"image/gif"})},W=(o,e)=>new Promise((r,i)=>{const t=()=>{o.removeEventListener("seeked",t),o.removeEventListener("error",a),r()},a=()=>{o.removeEventListener("seeked",t),o.removeEventListener("error",a),i(new Error("動画のシークに失敗しました。"))};o.addEventListener("seeked",t,{once:!0}),o.addEventListener("error",a,{once:!0}),o.currentTime=e}),G=()=>new Promise(o=>{requestAnimationFrame(()=>o())}),V=async(o,e,r)=>{let i=e.width,t=e.fps,a=0,n=null;for(;i>=160&&t>=5;){a+=1,m(`変換中... (試行 ${a})`);const s=await R(o,{...e,width:i,fps:t},r);if(s.size<=j)return{blob:s,width:i,fps:t,iterations:a};if(n=s,i>320){i=Math.floor(i*.85);continue}t=Math.max(5,t-2)}if(n)return{blob:n,width:i,fps:t,iterations:a};throw new Error("出力サイズを 10MB 以下に抑えられませんでした。設定を見直してください。")};let E=null;l.convert.addEventListener("click",async()=>{if(!(!A||!x)){E&&E.abort(),E=new AbortController,l.convert.disabled=!0,l.download.setAttribute("aria-disabled","true"),l.download.removeAttribute("href"),m("変換を開始しました...");try{l.video.pause(),l.video.currentTime=0;const o={width:Number.parseInt(l.width.value,10),fps:Number.parseInt(l.fps.value,10),quality:Number.parseInt(l.quality.value,10)},e=await V(l.video,o,E.signal),r=URL.createObjectURL(e.blob);l.download.href=r,l.download.download=`${A.name.replace(/\.[^.]+$/,"")||"output"}.gif`,l.download.setAttribute("aria-disabled","false"),m(e.blob.size<=j?`変換が完了しました！ (${z(e.blob.size)})`:`変換は完了しましたが 10MB を超えています (${z(e.blob.size)})。解像度やフレームレートを下げて再試行してください。`,e.blob.size>j)}catch(o){console.error(o),m(o instanceof Error?o.message:"変換中にエラーが発生しました。",!0)}finally{l.convert.disabled=!1,E=null}}});N.addEventListener("change",o=>{var r;const e=o.target;(r=e.files)!=null&&r.length&&L(e.files[0])});B.addEventListener("dragover",o=>{o.preventDefault(),B.classList.add("drag-over")});B.addEventListener("dragleave",()=>{B.classList.remove("drag-over")});B.addEventListener("drop",$);l.width.addEventListener("input",O);l.fps.addEventListener("input",O);l.quality.addEventListener("input",O);l.download.addEventListener("click",()=>{l.download.getAttribute("aria-disabled")!=="true"&&m("GIF をダウンロードしています...")});const z=o=>o<1024?`${o}B`:o<1024*1024?`${(o/1024).toFixed(1)}KB`:`${(o/(1024*1024)).toFixed(2)}MB`;C();
