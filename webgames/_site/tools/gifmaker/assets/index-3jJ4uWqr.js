var T=Object.defineProperty;var q=(a,t,e)=>t in a?T(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e;var c=(a,t,e)=>q(a,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=e(i);fetch(i.href,n)}})();class U{constructor(){c(this,"data",[])}writeByte(t){this.data.push(t&255)}writeUTFBytes(t){for(let e=0;e<t.length;e+=1)this.writeByte(t.charCodeAt(e))}writeBytes(t,e=0,s=t.length){for(let i=e;i<e+s;i+=1)this.writeByte(t[i])}getData(){return Uint8Array.from(this.data)}}class N{constructor(t,e,s,i){c(this,"imgW");c(this,"imgH");c(this,"pixAry");c(this,"initCodeSize");c(this,"curAccum",0);c(this,"curBits",0);c(this,"masks",[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535]);c(this,"aCount",0);c(this,"accum",new Uint8Array(256));this.imgW=t,this.imgH=e,this.pixAry=s,this.initCodeSize=Math.max(2,i)}encode(t){t.writeByte(this.initCodeSize),this.compress(this.initCodeSize+1,t),t.writeByte(0)}charOut(t,e){this.accum[this.aCount]=t,this.aCount+=1,this.aCount>=254&&this.flushChar(e)}flushChar(t){this.aCount>0&&(t.writeByte(this.aCount),t.writeBytes(this.accum,0,this.aCount),this.aCount=0)}clBlock(t,e,s,i,n,o){this.resetCodeTable(e),i.value=1<<s-1,n.value=!0;const r=1<<s-1;this.output(r,t,s,n),o.value=this.pixAry[0]&255}resetCodeTable(t){t.fill(-1)}compress(t,e){const i=new Int32Array(5003),n=new Int32Array(5003);this.resetCodeTable(i);let o=this.pixAry[0]&255;Math.max(0,Math.min(8,Math.floor(Math.log(this.initCodeSize)/Math.LN2)));const r=1<<t-1,h=r+1;let d=r+2,f=t,w=(1<<f)-1,u=!1;this.output(r,e,f,{value:u});const p={value:0},m={value:0},v={value:d},b={value:u},B=I=>{let g=I;return g+=g<<8>>>0,g^=g>>4,g%5003};for(let I=1;I<this.pixAry.length;I+=1){const g=this.pixAry[I]&255;p.value=(g<<12)+o;const D=B(p.value);if(m.value=D,i[m.value]===p.value){o=n[m.value];continue}if(i[m.value]>=0){let L=5003-m.value;m.value===0&&(L=1);do if(m.value-=L,m.value<0&&(m.value+=5003),i[m.value]===p.value){o=n[m.value];break}while(i[m.value]>=0);if(i[m.value]===p.value)continue}this.output(o,e,f,b),o=g,v.value<4096?(n[m.value]=v.value,i[m.value]=p.value,v.value+=1):(this.clBlock(e,i,f,v,b,{value:o}),o=g),v.value>w&&f<12&&(f+=1,w=(1<<f)-1)}this.output(o,e,f,b),this.output(h,e,f,b)}output(t,e,s,i){for(this.curAccum&=this.masks[this.curBits],this.curBits>0?this.curAccum|=t<<this.curBits:this.curAccum=t,this.curBits+=s;this.curBits>=8;)this.charOut(this.curAccum&255,e),this.curAccum>>=8,this.curBits-=8;i.value&&(this.curAccum=0,this.curBits=0,i.value=!1)}}class ${constructor(t,e){c(this,"netsize",256);c(this,"network",[]);c(this,"bias",new Int32Array(this.netsize));c(this,"freq",new Int32Array(this.netsize));c(this,"radPower",new Int32Array(this.netsize>>3));c(this,"netIndex",new Int32Array(256));for(let s=0;s<this.netsize;s+=1){const i=(s<<16)/this.netsize;this.network[s]=[i,i,i],this.freq[s]=65536,this.bias[s]=0}this.learn(t,e),this.buildIndex()}learn(t,e){const s=t.length,i=30+(e-1)/3;let n=s/(3*e),o=0,r=1024,h=(this.netsize>>3)-1;n<this.netsize&&(n=this.netsize);let d=h>>3;d<=1&&(d=0);for(let u=0;u<d;u+=1)this.radPower[u]=r*((d*d-u*u)*256/(d*d));let f=0;s<1509?f=3:s%499!==0?f=499:s%491!==0?f=491:s%487!==0?f=487:f=503;let w=0;for(let u=0;u<n;u+=1){const p=t[w]&255,m=t[w+1]&255,v=t[w+2]&255,b=this.contest(p,m,v);if(this.alterSingle(r,b,p,m,v),d!==0&&this.alterNeigh(d,b,p,m,v),w+=f*3,w>=s&&(w-=s),o+=1,o%100===0){r-=r/i,h-=h/30,d=h>>3,d<=1&&(d=0);for(let B=0;B<d;B+=1)this.radPower[B]=r*((d*d-B*B)*256/(d*d))}}}buildIndex(){let t=0,e=0;for(let s=0;s<this.netsize;s+=1){const i=this.network[s];let n=s,o=i[1];for(let r=s+1;r<this.netsize;r+=1){const h=this.network[r];h[1]<o&&(n=r,o=h[1])}if(s!==n){const r=this.network[n];[this.network[s],this.network[n]]=[r,i]}if(o!==t){this.netIndex[t]=e+s>>1;for(let r=t+1;r<o;r+=1)this.netIndex[r]=s;t=o,e=s}}this.netIndex[t]=e+this.netsize-1>>1;for(let s=t+1;s<256;s+=1)this.netIndex[s]=this.netsize-1}contest(t,e,s){let i=-1,n=1<<31,o=n;for(let r=0;r<this.netsize;r+=1){const h=this.network[r],d=Math.abs(h[0]-t)+Math.abs(h[1]-e)+Math.abs(h[2]-s);d<n&&(n=d,i=r);const f=d-(this.bias[r]>>12);f<o&&(o=f,i=r),this.freq[r]-=this.freq[r]>>10,this.bias[r]+=this.freq[r]<<10}return this.freq[i]+=64,this.bias[i]-=65536,i}alterSingle(t,e,s,i,n){const o=this.network[e];o[0]-=t*(o[0]-s)/1024,o[1]-=t*(o[1]-i)/1024,o[2]-=t*(o[2]-n)/1024}alterNeigh(t,e,s,i,n){let o=Math.max(e-t,0),r=Math.min(e+t,this.netsize-1),h=e+1,d=e-1,f=1;for(;h<=r||d>=o;){const w=this.radPower[f++]/262144;if(h<=r){const u=this.network[h++];u[0]-=w*(u[0]-s),u[1]-=w*(u[1]-i),u[2]-=w*(u[2]-n)}if(d>=o){const u=this.network[d--];u[0]-=w*(u[0]-s),u[1]-=w*(u[1]-i),u[2]-=w*(u[2]-n)}}}map(t,e,s){let i=1073741824,n=-1;for(let o=0;o<this.netsize;o+=1){const r=this.network[o],h=Math.abs(r[0]-t)+Math.abs(r[1]-e)+Math.abs(r[2]-s);h<i&&(i=h,n=o)}return n}colorMap(){const t=new Uint8Array(this.netsize*3);for(let e=0;e<this.netsize;e+=1){const s=this.netIndex[e],i=this.network[s];t[e*3+0]=i[0],t[e*3+1]=i[1],t[e*3+2]=i[2]}return t}}class O{constructor(t,e){c(this,"width");c(this,"height");c(this,"transparent",-1);c(this,"repeat",0);c(this,"delay",0);c(this,"started",!1);c(this,"out",new U);c(this,"image",null);c(this,"indexedPixels",new Uint8Array(0));c(this,"colorDepth",8);c(this,"colorTab",new Uint8Array(0));c(this,"usedEntry",new Array(256).fill(!1));c(this,"palSize",7);c(this,"sample",10);c(this,"dispose",-1);c(this,"firstFrame",!0);this.width=t,this.height=e}setDelay(t){this.delay=Math.round(t/10)}setFrameRate(t){this.delay=Math.round(100/t)}setRepeat(t){this.repeat=t}setTransparent(t){this.transparent=t}setDispose(t){t>=0&&(this.dispose=t)}setQuality(t){t<1&&(t=1),this.sample=t}start(){this.writeString("GIF89a"),this.started=!0}addFrame(t){if(!this.started)throw new Error("Encoder not started.");return this.image=t.getImageData(0,0,this.width,this.height),this.analyzePixels(),this.firstFrame&&(this.writeLSD(),this.writePalette(),this.repeat>=0&&this.writeNetscapeExt()),this.writeGraphicCtrlExt(),this.writeImageDesc(),this.firstFrame||this.writePalette(),this.writePixels(),this.firstFrame=!1,!0}finish(){return this.started?(this.out.writeByte(59),this.started=!1,!0):!1}stream(){return this.out}analyzePixels(){if(!this.image)return;const t=this.image.data.length,e=new Uint8Array(t/4*3),s=this.image.data;let i=0;for(let h=0;h<t;h+=4)e[i++]=s[h],e[i++]=s[h+1],e[i++]=s[h+2];const n=new $(e,this.sample);this.colorTab=n.colorMap(),this.colorDepth=8,this.palSize=7;const o=this.colorTab.length/3;this.usedEntry=new Array(o).fill(!1),this.indexedPixels=new Uint8Array(this.width*this.height);let r=0;for(let h=0;h<this.width*this.height;h+=1){const d=s[r++],f=s[r++],w=s[r++];r++;const u=n.map(d,f,w);this.usedEntry[u]=!0,this.indexedPixels[h]=u}this.image=null}writeGraphicCtrlExt(){this.out.writeByte(33),this.out.writeByte(249),this.out.writeByte(4);let t=0,e=0;this.transparent>=0&&(t=1),this.dispose>=0&&(e=this.dispose&7),e<<=2,this.out.writeByte(e|t),this.writeShort(this.delay),this.out.writeByte(this.transparent>=0?this.transparent:0),this.out.writeByte(0)}writeImageDesc(){this.out.writeByte(44),this.writeShort(0),this.writeShort(0),this.writeShort(this.width),this.writeShort(this.height),this.firstFrame?this.out.writeByte(0):this.out.writeByte(128|this.palSize)}writeLSD(){this.writeShort(this.width),this.writeShort(this.height),this.out.writeByte(240|this.palSize),this.out.writeByte(0),this.out.writeByte(0)}writePalette(){this.out.writeBytes(this.colorTab);const t=3*256-this.colorTab.length;for(let e=0;e<t;e+=1)this.out.writeByte(0)}writePixels(){new N(this.width,this.height,this.indexedPixels,this.colorDepth).encode(this.out)}writeShort(t){this.out.writeByte(t&255),this.out.writeByte(t>>8&255)}writeString(t){this.out.writeUTFBytes(t)}writeNetscapeExt(){this.out.writeByte(33),this.out.writeByte(255),this.out.writeByte(11),this.writeString("NETSCAPE2.0"),this.out.writeByte(3),this.out.writeByte(1),this.writeShort(this.repeat),this.out.writeByte(0)}}const S=10*1024*1024,l={width:document.getElementById("width-range"),fps:document.getElementById("fps-range"),quality:document.getElementById("quality-range"),download:document.getElementById("download-link"),convert:document.getElementById("convert-button"),status:document.getElementById("status"),video:document.getElementById("preview-video"),canvas:document.getElementById("working-canvas")},P=document.getElementById("width-value"),j=document.getElementById("fps-value"),R=document.getElementById("quality-value"),E=document.getElementById("dropzone"),W=document.getElementById("file-input");let C=null,x=null;const z=()=>{P.textContent=`${l.width.value}px`,j.textContent=`${l.fps.value}fps`,R.textContent=`${l.quality.value}/8`};z();const y=(a,t=!1)=>{l.status.textContent=a,l.status.dataset.state=t?"error":"normal"},k=()=>{l.video.removeAttribute("src"),l.video.load(),l.convert.disabled=!0,l.download.setAttribute("aria-disabled","true"),l.download.removeAttribute("href"),y("動画ファイルを読み込んでください。")},F=a=>{if(!a.type.startsWith("video/")){y("対応していないファイル形式です。動画ファイルを選択してください。",!0);return}C=a,x&&(URL.revokeObjectURL(x),x=null),x=URL.createObjectURL(a),l.video.src=x,l.video.onloadedmetadata=()=>{l.video.currentTime=0,l.convert.disabled=!1;const t=Math.min(960,Math.round(l.video.videoWidth));l.width.max=String(Math.max(160,t)),l.width.value=String(Math.min(t,Number(l.width.value))),P.textContent=`${l.width.value}px`,y("動画が読み込まれました。設定を調整して「GIF を作成」を押してください。")},l.video.onerror=()=>{y("動画の読み込みに失敗しました。",!0),k()}},G=a=>{var t,e;a.preventDefault(),E.classList.remove("drag-over"),(e=(t=a.dataTransfer)==null?void 0:t.files)!=null&&e.length&&F(a.dataTransfer.files[0])},V=async(a,t,e)=>{const s=t.width,i=a.videoHeight/a.videoWidth,n=Math.round(s*i);l.canvas.width=s,l.canvas.height=n;const o=l.canvas.getContext("2d");if(!o)throw new Error("Canvas が利用できません。");const r=new O(s,n);r.setRepeat(0),r.setDelay(Math.round(1e3/t.fps)),r.setQuality(t.quality),r.start();const h=a.duration,d=Math.max(1,Math.floor(h*t.fps)),f=Math.round(1e3/t.fps);r.setDelay(f);for(let u=0;u<d;u+=1){if(e.aborted)throw new Error("処理が中断されました。");const p=Math.min(h,u/t.fps);await H(a,p),o.drawImage(a,0,0,s,n),r.addFrame(o),y(`フレームを処理中... (${u+1}/${d})`),await Q()}r.finish();const w=r.stream().getData();return new Blob([w],{type:"image/gif"})},H=(a,t)=>new Promise((e,s)=>{const i=()=>{a.removeEventListener("seeked",i),a.removeEventListener("error",n),e()},n=()=>{a.removeEventListener("seeked",i),a.removeEventListener("error",n),s(new Error("動画のシークに失敗しました。"))};a.addEventListener("seeked",i,{once:!0}),a.addEventListener("error",n,{once:!0}),a.currentTime=t}),Q=()=>new Promise(a=>{requestAnimationFrame(()=>a())}),K=async(a,t,e)=>{let s=t.width,i=t.fps,n=0,o=null;for(;s>=160&&i>=5;){n+=1,y(`変換中... (試行 ${n})`);const r=await V(a,{...t,width:s,fps:i},e);if(r.size<=S)return{blob:r,width:s,fps:i,iterations:n};if(o=r,s>320){s=Math.floor(s*.85);continue}i=Math.max(5,i-2)}if(o)return{blob:o,width:s,fps:i,iterations:n};throw new Error("出力サイズを 10MB 以下に抑えられませんでした。設定を見直してください。")};let A=null;l.convert.addEventListener("click",async()=>{if(!(!C||!x)){A&&A.abort(),A=new AbortController,l.convert.disabled=!0,l.download.setAttribute("aria-disabled","true"),l.download.removeAttribute("href"),y("変換を開始しました...");try{l.video.pause(),l.video.currentTime=0;const a={width:Number.parseInt(l.width.value,10),fps:Number.parseInt(l.fps.value,10),quality:Number.parseInt(l.quality.value,10)},t=await K(l.video,a,A.signal),e=URL.createObjectURL(t.blob);l.download.href=e,l.download.download=`${C.name.replace(/\.[^.]+$/,"")||"output"}.gif`,l.download.setAttribute("aria-disabled","false"),y(t.blob.size<=S?`変換が完了しました！ (${M(t.blob.size)})`:`変換は完了しましたが 10MB を超えています (${M(t.blob.size)})。解像度やフレームレートを下げて再試行してください。`,t.blob.size>S)}catch(a){console.error(a),y(a instanceof Error?a.message:"変換中にエラーが発生しました。",!0)}finally{l.convert.disabled=!1,A=null}}});W.addEventListener("change",a=>{var e;const t=a.target;(e=t.files)!=null&&e.length&&F(t.files[0])});E.addEventListener("dragover",a=>{a.preventDefault(),E.classList.add("drag-over")});E.addEventListener("dragleave",()=>{E.classList.remove("drag-over")});E.addEventListener("drop",G);l.width.addEventListener("input",z);l.fps.addEventListener("input",z);l.quality.addEventListener("input",z);l.download.addEventListener("click",()=>{l.download.getAttribute("aria-disabled")!=="true"&&y("GIF をダウンロードしています...")});const M=a=>a<1024?`${a}B`:a<1024*1024?`${(a/1024).toFixed(1)}KB`:`${(a/(1024*1024)).toFixed(2)}MB`;k();
