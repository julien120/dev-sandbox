(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function a(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(n){if(n.ep)return;n.ep=!0;const s=a(n);fetch(n.href,s)}})();const P="modulepreload",C=function(e){return"/dev-sandbox/tools/gifmaker/"+e},I={},T=function(t,a,o){let n=Promise.resolve();if(a&&a.length>0){document.getElementsByTagName("link");const i=document.querySelector("meta[property=csp-nonce]"),l=(i==null?void 0:i.nonce)||(i==null?void 0:i.getAttribute("nonce"));n=Promise.allSettled(a.map(d=>{if(d=C(d),d in I)return;I[d]=!0;const f=d.endsWith(".css"),v=f?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${d}"]${v}`))return;const c=document.createElement("link");if(c.rel=f?"stylesheet":P,f||(c.as="script"),c.crossOrigin="",c.href=d,l&&c.setAttribute("nonce",l),document.head.appendChild(c),f)return new Promise((L,b)=>{c.addEventListener("load",L),c.addEventListener("error",()=>b(new Error(`Unable to preload CSS for ${d}`)))})}))}function s(i){const l=new Event("vite:preloadError",{cancelable:!0});if(l.payload=i,window.dispatchEvent(l),!l.defaultPrevented)throw i}return n.then(i=>{for(const l of i||[])l.status==="rejected"&&s(l.reason);return t().catch(s)})},x=10*1024*1024,B="/dev-sandbox/tools/gifmaker/ffmpeg/",q=`${B}ffmpeg-core.js`,N=`${B}ffmpeg-core.wasm`,z=`${B}ffmpeg-core.worker.js`,r={width:document.getElementById("width-range"),fps:document.getElementById("fps-range"),quality:document.getElementById("quality-range"),download:document.getElementById("download-link"),convert:document.getElementById("convert-button"),status:document.getElementById("status"),video:document.getElementById("preview-video"),canvas:document.getElementById("working-canvas")},$=document.getElementById("width-value"),W=document.getElementById("fps-value"),k=document.getElementById("quality-value"),w=document.getElementById("dropzone"),D=document.getElementById("file-input");let E=null,h=null,m=null,y=null;const R=({progress:e})=>{const t=Number.isFinite(e)?e:0;u(`FFmpeg 変換中... ${(t*100).toFixed(1)}%`)},M=()=>{if(m)try{m.off("progress",R),m.terminate()}catch(e){console.warn("FFmpeg terminate error:",e)}finally{m=null}},V=async()=>{if(!m){if(y){await y;return}y=(async()=>{u("FFmpeg モジュールを読み込んでいます...");const{FFmpeg:e}=await T(async()=>{const{FFmpeg:a}=await import("./index-xBFhFHq3.js");return{FFmpeg:a}},[]);if(typeof e!="function")throw new Error("FFmpeg クラスが見つかりませんでした。");const t=new e;t.on("progress",R),await t.load({coreURL:q,wasmURL:N,workerURL:z}),m=t})();try{await y}catch(e){throw M(),e}finally{y=null}}},F=()=>{$.textContent=`${r.width.value}px`,W.textContent=`${r.fps.value}fps`,k.textContent=`${r.quality.value}/8`};F();const u=(e,t=!1)=>{r.status.textContent=e,r.status.dataset.state=t?"error":"normal"},j=async e=>{if(e instanceof Uint8Array)return e;if(typeof e=="string")return new TextEncoder().encode(e);if(e instanceof Blob){const t=await e.arrayBuffer();return new Uint8Array(t)}if(e instanceof ArrayBuffer)return new Uint8Array(e);if(ArrayBuffer.isView(e))return new Uint8Array(e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength));throw new Error("入力データを Uint8Array に変換できませんでした。")},U=()=>{r.video.removeAttribute("src"),r.video.load(),r.convert.disabled=!0,r.download.setAttribute("aria-disabled","true"),r.download.removeAttribute("href"),u("動画ファイルを読み込んでください。")},S=e=>{if(!e.type.startsWith("video/")){u("対応していないファイル形式です。動画ファイルを選択してください。",!0);return}E=e,h&&(URL.revokeObjectURL(h),h=null),h=URL.createObjectURL(e),r.video.src=h,r.video.onloadedmetadata=()=>{r.video.currentTime=0,r.convert.disabled=!1;const t=Math.min(960,Math.round(r.video.videoWidth));r.width.max=String(Math.max(160,t)),r.width.value=String(Math.min(t,Number(r.width.value))),$.textContent=`${r.width.value}px`,u("動画が読み込まれました。設定を調整して「GIF を作成」を押してください。")},r.video.onerror=()=>{u("動画の読み込みに失敗しました。",!0),U()}},H=e=>{if(!e)return null;if(e.files&&e.files.length>0)return e.files[0]??null;if(e.items){for(const t of Array.from(e.items))if(t.kind==="file"){const a=t.getAsFile();if(a)return a}}return null},G=e=>{e.preventDefault(),w.classList.remove("drag-over");const t=H(e.dataTransfer??null);t?S(t):u("ファイルをドロップしてください。フォルダは利用できません。",!0)},K=(e,t,a)=>{const o=["none","floyd_steinberg","sierra2","sierra2_4a","bayer:bayer_scale=5:diffusion=1","bayer:bayer_scale=4:diffusion=1","bayer:bayer_scale=3:diffusion=1","bayer:bayer_scale=2:diffusion=1"],n=Math.min(o.length-1,Math.max(0,Math.round(a)-1)),s=o[n];return`fps=${e},scale=${t}:-1:flags=lanczos,split[a][b];[a]palettegen=stats_mode=full[p];[b][p]paletteuse=dither=${s}`},Y=async(e,t,a)=>{await V();const o=m;if(!o)throw new Error("FFmpeg の初期化に失敗しました。");const n=Math.max(160,Math.round(t.width)),s=Math.max(1,Math.round(t.fps)),i=Math.max(1,Math.round(t.quality)),l=`input-${Date.now()}.mp4`,d=`output-${Date.now()}.gif`;let f=!1;const v=()=>{f=!0,M()};a.addEventListener("abort",v,{once:!0});try{u("FFmpeg で GIF を生成しています...");const c=await j(e);await o.writeFile(l,c);const L=K(s,n,i),b=await o.exec(["-i",l,"-vf",L,"-loop","0",d]);if(b!==0)throw new Error(`FFmpeg の実行に失敗しました (コード: ${b})。`);const g=await o.readFile(d),O=g instanceof Uint8Array?g:new TextEncoder().encode(typeof g=="string"?g:String(g));return new Blob([O],{type:"image/gif"})}catch(c){throw f?new Error("処理が中断されました。"):(M(),c)}finally{if(a.removeEventListener("abort",v),o.loaded){try{await o.deleteFile(l)}catch(c){console.warn("Failed to remove input from FFmpeg FS",c)}try{await o.deleteFile(d)}catch(c){console.warn("Failed to remove output from FFmpeg FS",c)}}}},J=async(e,t,a)=>{let o=Math.max(160,Math.round(t.width)),n=Math.max(1,Math.round(t.fps));const s=Math.max(1,Math.round(t.quality));let i=0,l=null;for(;o>=160&&n>=5;){i+=1,u(`変換中... (試行 ${i})`);const d=await Y(e,{width:o,fps:n,quality:s},a);if(d.size<=x)return{blob:d,width:o,fps:n,iterations:i};if(l=d,o>320){o=Math.max(160,Math.floor(o*.85));continue}n=Math.max(5,n-2)}if(l)return{blob:l,width:o,fps:n,iterations:i};throw new Error("出力サイズを 10MB 以下に抑えられませんでした。設定を見直してください。")};let p=null;r.convert.addEventListener("click",async()=>{if(!(!E||!h)){p&&p.abort(),p=new AbortController,r.convert.disabled=!0,r.download.setAttribute("aria-disabled","true"),r.download.removeAttribute("href"),u("変換を開始しました...");try{r.video.pause(),r.video.currentTime=0,await X(r.video);const e={width:A(r.width.value,r.video.videoWidth||480,160,960),fps:A(r.fps.value,12,1,60),quality:A(r.quality.value,6,1,8)},t=await J(E,e,p.signal),a=URL.createObjectURL(t.blob);r.download.href=a,r.download.download=`${E.name.replace(/\.[^.]+$/,"")||"output"}.gif`,r.download.setAttribute("aria-disabled","false"),u(t.blob.size<=x?`変換が完了しました！ (${_(t.blob.size)})`:`変換は完了しましたが 10MB を超えています (${_(t.blob.size)})。解像度やフレームレートを下げて再試行してください。`,t.blob.size>x)}catch(e){console.error(e),u(e instanceof Error?e.message:"変換中にエラーが発生しました。",!0)}finally{r.convert.disabled=!1,p=null}}});D.addEventListener("change",e=>{var a;const t=e.target;(a=t.files)!=null&&a.length&&S(t.files[0])});w.addEventListener("dragover",e=>{e.preventDefault(),w.classList.add("drag-over")});w.addEventListener("dragleave",()=>{w.classList.remove("drag-over")});w.addEventListener("drop",G);r.width.addEventListener("input",F);r.fps.addEventListener("input",F);r.quality.addEventListener("input",F);r.download.addEventListener("click",()=>{r.download.getAttribute("aria-disabled")!=="true"&&u("GIF をダウンロードしています...")});const _=e=>e<1024?`${e}B`:e<1024*1024?`${(e/1024).toFixed(1)}KB`:`${(e/(1024*1024)).toFixed(2)}MB`,A=(e,t,a=0,o=Number.POSITIVE_INFINITY)=>{const n=Number.parseFloat(e);return Number.isFinite(n)?Math.min(Math.max(n,a),o):t};U();const Q=(e,t)=>new Promise(a=>{const o=n=>{e.removeEventListener(t,o),a(n)};e.addEventListener(t,o,{once:!0})}),X=async e=>{if(e.readyState<HTMLMediaElement.HAVE_METADATA&&await Q(e,"loadedmetadata"),(e.videoWidth===0||e.videoHeight===0)&&await new Promise(t=>requestAnimationFrame(t)),e.videoWidth===0||e.videoHeight===0)throw new Error("動画のメタデータを取得できませんでした。別のファイルでお試しください。");if(!Number.isFinite(e.duration)||e.duration<=0)throw new Error("動画の長さが不正です。")};
