var T=Object.defineProperty;var q=(o,t,e)=>t in o?T(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var u=(o,t,e)=>q(o,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function e(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(s){if(s.ep)return;s.ep=!0;const r=e(s);fetch(s.href,r)}})();class U{constructor(){u(this,"data",[])}writeByte(t){this.data.push(t&255)}writeUTFBytes(t){for(let e=0;e<t.length;e+=1)this.writeByte(t.charCodeAt(e))}writeBytes(t,e=0,i=t.length){for(let s=e;s<e+i;s+=1)this.writeByte(t[s])}getData(){return Uint8Array.from(this.data)}}class N{constructor(t,e,i,s){u(this,"imgW");u(this,"imgH");u(this,"pixAry");u(this,"initCodeSize");u(this,"curAccum",0);u(this,"curBits",0);u(this,"masks",[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535]);u(this,"aCount",0);u(this,"accum",new Uint8Array(256));this.imgW=t,this.imgH=e,this.pixAry=i,this.initCodeSize=Math.max(2,s)}encode(t){t.writeByte(this.initCodeSize),this.compress(this.initCodeSize+1,t),t.writeByte(0)}charOut(t,e){this.accum[this.aCount]=t,this.aCount+=1,this.aCount>=254&&this.flushChar(e)}flushChar(t){this.aCount>0&&(t.writeByte(this.aCount),t.writeBytes(this.accum,0,this.aCount),this.aCount=0)}clBlock(t,e,i,s,r,a){this.resetCodeTable(e),s.value=1<<i-1,r.value=!0;const n=1<<i-1;this.output(n,t,i,r),a.value=this.pixAry[0]&255}resetCodeTable(t){t.fill(-1)}compress(t,e){const s=new Int32Array(5003),r=new Int32Array(5003);this.resetCodeTable(s);let a=this.pixAry[0]&255;Math.max(0,Math.min(8,Math.floor(Math.log(this.initCodeSize)/Math.LN2)));const n=1<<t-1,l=n+1;let d=n+2,f=t,w=(1<<f)-1,c=!1;this.output(n,e,f,{value:c});const p={value:0},m={value:0},v={value:d},b={value:c},B=I=>{let g=I;return g+=g<<8>>>0,g^=g>>4,g%5003};for(let I=1;I<this.pixAry.length;I+=1){const g=this.pixAry[I]&255;p.value=(g<<12)+a;const D=B(p.value);if(m.value=D,s[m.value]===p.value){a=r[m.value];continue}if(s[m.value]>=0){let C=5003-m.value;m.value===0&&(C=1);do if(m.value-=C,m.value<0&&(m.value+=5003),s[m.value]===p.value){a=r[m.value];break}while(s[m.value]>=0);if(s[m.value]===p.value)continue}this.output(a,e,f,b),a=g,v.value<4096?(r[m.value]=v.value,s[m.value]=p.value,v.value+=1):(this.clBlock(e,s,f,v,b,{value:a}),a=g),v.value>w&&f<12&&(f+=1,w=(1<<f)-1)}this.output(a,e,f,b),this.output(l,e,f,b)}output(t,e,i,s){for(this.curAccum&=this.masks[this.curBits],this.curBits>0?this.curAccum|=t<<this.curBits:this.curAccum=t,this.curBits+=i;this.curBits>=8;)this.charOut(this.curAccum&255,e),this.curAccum>>=8,this.curBits-=8;s.value&&(this.curAccum=0,this.curBits=0,s.value=!1)}}class ${constructor(t,e){u(this,"netsize",256);u(this,"network",[]);u(this,"bias",new Int32Array(this.netsize));u(this,"freq",new Int32Array(this.netsize));u(this,"radPower",new Int32Array(this.netsize>>3));u(this,"netIndex",new Int32Array(256));for(let i=0;i<this.netsize;i+=1){const s=(i<<16)/this.netsize;this.network[i]=[s,s,s],this.freq[i]=65536,this.bias[i]=0}this.learn(t,e),this.buildIndex()}learn(t,e){const i=t.length,s=30+(e-1)/3;let r=i/(3*e),a=0,n=1024,l=(this.netsize>>3)-1;r<this.netsize&&(r=this.netsize);let d=l>>3;d<=1&&(d=0);for(let c=0;c<d;c+=1)this.radPower[c]=n*((d*d-c*c)*256/(d*d));let f=0;i<1509?f=3:i%499!==0?f=499:i%491!==0?f=491:i%487!==0?f=487:f=503;let w=0;for(let c=0;c<r;c+=1){const p=t[w]&255,m=t[w+1]&255,v=t[w+2]&255,b=this.contest(p,m,v);if(this.alterSingle(n,b,p,m,v),d!==0&&this.alterNeigh(d,b,p,m,v),w+=f*3,w>=i&&(w-=i),a+=1,a%100===0){n-=n/s,l-=l/30,d=l>>3,d<=1&&(d=0);for(let B=0;B<d;B+=1)this.radPower[B]=n*((d*d-B*B)*256/(d*d))}}}buildIndex(){let t=0,e=0;for(let i=0;i<this.netsize;i+=1){const s=this.network[i];let r=i,a=s[1];for(let n=i+1;n<this.netsize;n+=1){const l=this.network[n];l[1]<a&&(r=n,a=l[1])}if(i!==r){const n=this.network[r];[this.network[i],this.network[r]]=[n,s]}if(a!==t){this.netIndex[t]=e+i>>1;for(let n=t+1;n<a;n+=1)this.netIndex[n]=i;t=a,e=i}}this.netIndex[t]=e+this.netsize-1>>1;for(let i=t+1;i<256;i+=1)this.netIndex[i]=this.netsize-1}contest(t,e,i){let s=-1,r=1<<31,a=r;for(let n=0;n<this.netsize;n+=1){const l=this.network[n],d=Math.abs(l[0]-t)+Math.abs(l[1]-e)+Math.abs(l[2]-i);d<r&&(r=d,s=n);const f=d-(this.bias[n]>>12);f<a&&(a=f,s=n),this.freq[n]-=this.freq[n]>>10,this.bias[n]+=this.freq[n]<<10}return this.freq[s]+=64,this.bias[s]-=65536,s}alterSingle(t,e,i,s,r){const a=this.network[e];a[0]-=t*(a[0]-i)/1024,a[1]-=t*(a[1]-s)/1024,a[2]-=t*(a[2]-r)/1024}alterNeigh(t,e,i,s,r){let a=Math.max(e-t,0),n=Math.min(e+t,this.netsize-1),l=e+1,d=e-1,f=1;for(;l<=n||d>=a;){const w=this.radPower[f++]/262144;if(l<=n){const c=this.network[l++];c[0]-=w*(c[0]-i),c[1]-=w*(c[1]-s),c[2]-=w*(c[2]-r)}if(d>=a){const c=this.network[d--];c[0]-=w*(c[0]-i),c[1]-=w*(c[1]-s),c[2]-=w*(c[2]-r)}}}map(t,e,i){let s=1073741824,r=-1;for(let a=0;a<this.netsize;a+=1){const n=this.network[a],l=Math.abs(n[0]-t)+Math.abs(n[1]-e)+Math.abs(n[2]-i);l<s&&(s=l,r=a)}return r}colorMap(){const t=new Uint8Array(this.netsize*3);for(let e=0;e<this.netsize;e+=1){const i=this.netIndex[e],s=Number.isInteger(i)&&i>=0&&i<this.netsize?i:e,r=this.network[s]??this.network[e]??[0,0,0],a=e*3;t[a]=Math.max(0,Math.min(255,Math.round(r[0]))),t[a+1]=Math.max(0,Math.min(255,Math.round(r[1]))),t[a+2]=Math.max(0,Math.min(255,Math.round(r[2])))}return t}}class O{constructor(t,e){u(this,"width");u(this,"height");u(this,"transparent",-1);u(this,"repeat",0);u(this,"delay",0);u(this,"started",!1);u(this,"out",new U);u(this,"image",null);u(this,"indexedPixels",new Uint8Array(0));u(this,"colorDepth",8);u(this,"colorTab",new Uint8Array(0));u(this,"usedEntry",new Array(256).fill(!1));u(this,"palSize",7);u(this,"sample",10);u(this,"dispose",-1);u(this,"firstFrame",!0);this.width=t,this.height=e}setDelay(t){this.delay=Math.round(t/10)}setFrameRate(t){this.delay=Math.round(100/t)}setRepeat(t){this.repeat=t}setTransparent(t){this.transparent=t}setDispose(t){t>=0&&(this.dispose=t)}setQuality(t){t<1&&(t=1),this.sample=t}start(){this.writeString("GIF89a"),this.started=!0}addFrame(t){if(!this.started)throw new Error("Encoder not started.");return this.image=t.getImageData(0,0,this.width,this.height),this.analyzePixels(),this.firstFrame&&(this.writeLSD(),this.writePalette(),this.repeat>=0&&this.writeNetscapeExt()),this.writeGraphicCtrlExt(),this.writeImageDesc(),this.firstFrame||this.writePalette(),this.writePixels(),this.firstFrame=!1,!0}finish(){return this.started?(this.out.writeByte(59),this.started=!1,!0):!1}stream(){return this.out}analyzePixels(){if(!this.image)return;const t=this.image.data.length,e=new Uint8Array(t/4*3),i=this.image.data;let s=0;for(let l=0;l<t;l+=4)e[s++]=i[l],e[s++]=i[l+1],e[s++]=i[l+2];const r=new $(e,this.sample);this.colorTab=r.colorMap(),this.colorDepth=8,this.palSize=7;const a=this.colorTab.length/3;this.usedEntry=new Array(a).fill(!1),this.indexedPixels=new Uint8Array(this.width*this.height);let n=0;for(let l=0;l<this.width*this.height;l+=1){const d=i[n++],f=i[n++],w=i[n++];n++;const c=r.map(d,f,w);this.usedEntry[c]=!0,this.indexedPixels[l]=c}this.image=null}writeGraphicCtrlExt(){this.out.writeByte(33),this.out.writeByte(249),this.out.writeByte(4);let t=0,e=0;this.transparent>=0&&(t=1),this.dispose>=0&&(e=this.dispose&7),e<<=2,this.out.writeByte(e|t),this.writeShort(this.delay),this.out.writeByte(this.transparent>=0?this.transparent:0),this.out.writeByte(0)}writeImageDesc(){this.out.writeByte(44),this.writeShort(0),this.writeShort(0),this.writeShort(this.width),this.writeShort(this.height),this.firstFrame?this.out.writeByte(0):this.out.writeByte(128|this.palSize)}writeLSD(){this.writeShort(this.width),this.writeShort(this.height),this.out.writeByte(240|this.palSize),this.out.writeByte(0),this.out.writeByte(0)}writePalette(){this.out.writeBytes(this.colorTab);const t=3*256-this.colorTab.length;for(let e=0;e<t;e+=1)this.out.writeByte(0)}writePixels(){new N(this.width,this.height,this.indexedPixels,this.colorDepth).encode(this.out)}writeShort(t){this.out.writeByte(t&255),this.out.writeByte(t>>8&255)}writeString(t){this.out.writeUTFBytes(t)}writeNetscapeExt(){this.out.writeByte(33),this.out.writeByte(255),this.out.writeByte(11),this.writeString("NETSCAPE2.0"),this.out.writeByte(3),this.out.writeByte(1),this.writeShort(this.repeat),this.out.writeByte(0)}}const z=10*1024*1024,h={width:document.getElementById("width-range"),fps:document.getElementById("fps-range"),quality:document.getElementById("quality-range"),download:document.getElementById("download-link"),convert:document.getElementById("convert-button"),status:document.getElementById("status"),video:document.getElementById("preview-video"),canvas:document.getElementById("working-canvas")},k=document.getElementById("width-value"),R=document.getElementById("fps-value"),j=document.getElementById("quality-value"),E=document.getElementById("dropzone"),W=document.getElementById("file-input");let S=null,x=null;const A=()=>{k.textContent=`${h.width.value}px`,R.textContent=`${h.fps.value}fps`,j.textContent=`${h.quality.value}/8`};A();const y=(o,t=!1)=>{h.status.textContent=o,h.status.dataset.state=t?"error":"normal"},P=()=>{h.video.removeAttribute("src"),h.video.load(),h.convert.disabled=!0,h.download.setAttribute("aria-disabled","true"),h.download.removeAttribute("href"),y("動画ファイルを読み込んでください。")},F=o=>{if(!o.type.startsWith("video/")){y("対応していないファイル形式です。動画ファイルを選択してください。",!0);return}S=o,x&&(URL.revokeObjectURL(x),x=null),x=URL.createObjectURL(o),h.video.src=x,h.video.onloadedmetadata=()=>{h.video.currentTime=0,h.convert.disabled=!1;const t=Math.min(960,Math.round(h.video.videoWidth));h.width.max=String(Math.max(160,t)),h.width.value=String(Math.min(t,Number(h.width.value))),k.textContent=`${h.width.value}px`,y("動画が読み込まれました。設定を調整して「GIF を作成」を押してください。")},h.video.onerror=()=>{y("動画の読み込みに失敗しました。",!0),P()}},G=o=>{var t,e;o.preventDefault(),E.classList.remove("drag-over"),(e=(t=o.dataTransfer)==null?void 0:t.files)!=null&&e.length&&F(o.dataTransfer.files[0])},V=async(o,t,e)=>{const i=t.width,s=o.videoHeight/o.videoWidth,r=Math.round(i*s);h.canvas.width=i,h.canvas.height=r;const a=h.canvas.getContext("2d");if(!a)throw new Error("Canvas が利用できません。");const n=new O(i,r);n.setRepeat(0),n.setDelay(Math.round(1e3/t.fps)),n.setQuality(t.quality),n.start();const l=o.duration,d=Math.max(1,Math.floor(l*t.fps)),f=Math.round(1e3/t.fps);n.setDelay(f);for(let p=0;p<d;p+=1){if(e.aborted)throw new Error("処理が中断されました。");const m=Math.min(l,p/t.fps);await H(o,m),a.drawImage(o,0,0,i,r),n.addFrame(a),y(`フレームを処理中... (${p+1}/${d})`),await Q()}n.finish();const w=n.stream().getData(),c=new Uint8Array(w.length);return c.set(w),new Blob([c.buffer],{type:"image/gif"})},H=(o,t)=>new Promise((e,i)=>{const s=()=>{o.removeEventListener("seeked",s),o.removeEventListener("error",r),e()},r=()=>{o.removeEventListener("seeked",s),o.removeEventListener("error",r),i(new Error("動画のシークに失敗しました。"))};o.addEventListener("seeked",s,{once:!0}),o.addEventListener("error",r,{once:!0}),o.currentTime=t}),Q=()=>new Promise(o=>{requestAnimationFrame(()=>o())}),K=async(o,t,e)=>{let i=t.width,s=t.fps,r=0,a=null;for(;i>=160&&s>=5;){r+=1,y(`変換中... (試行 ${r})`);const n=await V(o,{...t,width:i,fps:s},e);if(n.size<=z)return{blob:n,width:i,fps:s,iterations:r};if(a=n,i>320){i=Math.floor(i*.85);continue}s=Math.max(5,s-2)}if(a)return{blob:a,width:i,fps:s,iterations:r};throw new Error("出力サイズを 10MB 以下に抑えられませんでした。設定を見直してください。")};let M=null;h.convert.addEventListener("click",async()=>{if(!(!S||!x)){M&&M.abort(),M=new AbortController,h.convert.disabled=!0,h.download.setAttribute("aria-disabled","true"),h.download.removeAttribute("href"),y("変換を開始しました...");try{h.video.pause(),h.video.currentTime=0;const o={width:Number.parseInt(h.width.value,10),fps:Number.parseInt(h.fps.value,10),quality:Number.parseInt(h.quality.value,10)},t=await K(h.video,o,M.signal),e=URL.createObjectURL(t.blob);h.download.href=e,h.download.download=`${S.name.replace(/\.[^.]+$/,"")||"output"}.gif`,h.download.setAttribute("aria-disabled","false"),y(t.blob.size<=z?`変換が完了しました！ (${L(t.blob.size)})`:`変換は完了しましたが 10MB を超えています (${L(t.blob.size)})。解像度やフレームレートを下げて再試行してください。`,t.blob.size>z)}catch(o){console.error(o),y(o instanceof Error?o.message:"変換中にエラーが発生しました。",!0)}finally{h.convert.disabled=!1,M=null}}});W.addEventListener("change",o=>{var e;const t=o.target;(e=t.files)!=null&&e.length&&F(t.files[0])});E.addEventListener("dragover",o=>{o.preventDefault(),E.classList.add("drag-over")});E.addEventListener("dragleave",()=>{E.classList.remove("drag-over")});E.addEventListener("drop",G);h.width.addEventListener("input",A);h.fps.addEventListener("input",A);h.quality.addEventListener("input",A);h.download.addEventListener("click",()=>{h.download.getAttribute("aria-disabled")!=="true"&&y("GIF をダウンロードしています...")});const L=o=>o<1024?`${o}B`:o<1024*1024?`${(o/1024).toFixed(1)}KB`:`${(o/(1024*1024)).toFixed(2)}MB`;P();
