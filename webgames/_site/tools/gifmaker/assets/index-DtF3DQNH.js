(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const n of a.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function t(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(r){if(r.ep)return;r.ep=!0;const a=t(r);fetch(r.href,a)}})();class k{constructor(){Object.defineProperty(this,"data",{enumerable:!0,configurable:!0,writable:!0,value:[]})}writeByte(e){this.data.push(e&255)}writeUTFBytes(e){for(let t=0;t<e.length;t+=1)this.writeByte(e.charCodeAt(t))}writeBytes(e,t=0,i=e.length){for(let r=t;r<t+i;r+=1)this.writeByte(e[r])}getData(){return Uint8Array.from(this.data)}}class F{constructor(e,t,i,r){Object.defineProperty(this,"imgW",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"imgH",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"pixAry",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"initCodeSize",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"curAccum",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"curBits",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"masks",{enumerable:!0,configurable:!0,writable:!0,value:[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535]}),Object.defineProperty(this,"aCount",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"accum",{enumerable:!0,configurable:!0,writable:!0,value:new Uint8Array(256)}),this.imgW=e,this.imgH=t,this.pixAry=i,this.initCodeSize=Math.max(2,r)}encode(e){e.writeByte(this.initCodeSize),this.compress(this.initCodeSize+1,e),e.writeByte(0)}charOut(e,t){this.accum[this.aCount]=e,this.aCount+=1,this.aCount>=254&&this.flushChar(t)}flushChar(e){this.aCount>0&&(e.writeByte(this.aCount),e.writeBytes(this.accum,0,this.aCount),this.aCount=0)}clBlock(e,t,i,r,a,n){this.resetCodeTable(t),r.value=1<<i-1,a.value=!0;const s=1<<i-1;this.output(s,e,i,a),n.value=this.pixAry[0]&255}resetCodeTable(e){e.fill(-1)}compress(e,t){const r=new Int32Array(5003),a=new Int32Array(5003);this.resetCodeTable(r);let n=this.pixAry[0]&255;Math.max(0,Math.min(8,Math.floor(Math.log(this.initCodeSize)/Math.LN2)));const s=1<<e-1,u=s+1;let h=s+2,d=e,f=(1<<d)-1,c=!1;this.output(s,t,d,{value:c});const w={value:0},b={value:0},p={value:h},y={value:c},g=P=>{let v=P;return v+=v<<8>>>0,v^=v>>4,v%5003};for(let P=1;P<this.pixAry.length;P+=1){const v=this.pixAry[P]&255;w.value=(v<<12)+n;const L=g(w.value);if(b.value=L,r[b.value]===w.value){n=a[b.value];continue}if(r[b.value]>=0){let A=5003-b.value;b.value===0&&(A=1);do if(b.value-=A,b.value<0&&(b.value+=5003),r[b.value]===w.value){n=a[b.value];break}while(r[b.value]>=0);if(r[b.value]===w.value)continue}this.output(n,t,d,y),n=v,p.value<4096?(a[b.value]=p.value,r[b.value]=w.value,p.value+=1):(this.clBlock(t,r,d,p,y,{value:n}),n=v),p.value>f&&d<12&&(d+=1,f=(1<<d)-1)}this.output(n,t,d,y),this.output(u,t,d,y)}output(e,t,i,r){for(this.curAccum&=this.masks[this.curBits],this.curBits>0?this.curAccum|=e<<this.curBits:this.curAccum=e,this.curBits+=i;this.curBits>=8;)this.charOut(this.curAccum&255,t),this.curAccum>>=8,this.curBits-=8;r.value&&(this.curAccum=0,this.curBits=0,r.value=!1)}}class D{constructor(e,t){Object.defineProperty(this,"netsize",{enumerable:!0,configurable:!0,writable:!0,value:256}),Object.defineProperty(this,"network",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"bias",{enumerable:!0,configurable:!0,writable:!0,value:new Int32Array(this.netsize)}),Object.defineProperty(this,"freq",{enumerable:!0,configurable:!0,writable:!0,value:new Int32Array(this.netsize)}),Object.defineProperty(this,"radPower",{enumerable:!0,configurable:!0,writable:!0,value:new Int32Array(this.netsize>>3)}),Object.defineProperty(this,"netIndex",{enumerable:!0,configurable:!0,writable:!0,value:new Int32Array(256)});for(let i=0;i<this.netsize;i+=1){const r=(i<<16)/this.netsize;this.network[i]=[r,r,r],this.freq[i]=65536,this.bias[i]=0}this.learn(e,t),this.buildIndex()}learn(e,t){const i=e.length,r=30+(t-1)/3;let a=i/(3*t),n=0,s=1024,u=(this.netsize>>3)-1;a<this.netsize&&(a=this.netsize);let h=u>>3;h<=1&&(h=0);for(let c=0;c<h;c+=1)this.radPower[c]=s*((h*h-c*c)*256/(h*h));let d=0;i<1509?d=3:i%499!==0?d=499:i%491!==0?d=491:i%487!==0?d=487:d=503;let f=0;for(let c=0;c<a;c+=1){const w=e[f]&255,b=e[f+1]&255,p=e[f+2]&255,y=this.contest(w,b,p);if(this.alterSingle(s,y,w,b,p),h!==0&&this.alterNeigh(h,y,w,b,p),f+=d*3,f>=i&&(f-=i),n+=1,n%100===0){s-=s/r,u-=u/30,h=u>>3,h<=1&&(h=0);for(let g=0;g<h;g+=1)this.radPower[g]=s*((h*h-g*g)*256/(h*h))}}}buildIndex(){let e=0,t=0;for(let i=0;i<this.netsize;i+=1){const r=this.network[i];let a=i,n=r[1];for(let s=i+1;s<this.netsize;s+=1){const u=this.network[s];u[1]<n&&(a=s,n=u[1])}if(i!==a){const s=this.network[a];[this.network[i],this.network[a]]=[s,r]}if(n!==e){this.netIndex[e]=t+i>>1;for(let s=e+1;s<n;s+=1)this.netIndex[s]=i;e=n,t=i}}this.netIndex[e]=t+this.netsize-1>>1;for(let i=e+1;i<256;i+=1)this.netIndex[i]=this.netsize-1}contest(e,t,i){let r=-1,a=1<<31,n=a;for(let s=0;s<this.netsize;s+=1){const u=this.network[s],h=Math.abs(u[0]-e)+Math.abs(u[1]-t)+Math.abs(u[2]-i);h<a&&(a=h,r=s);const d=h-(this.bias[s]>>12);d<n&&(n=d,r=s),this.freq[s]-=this.freq[s]>>10,this.bias[s]+=this.freq[s]<<10}return this.freq[r]+=64,this.bias[r]-=65536,r}alterSingle(e,t,i,r,a){const n=this.network[t];n[0]-=e*(n[0]-i)/1024,n[1]-=e*(n[1]-r)/1024,n[2]-=e*(n[2]-a)/1024}alterNeigh(e,t,i,r,a){let n=Math.max(t-e,0),s=Math.min(t+e,this.netsize-1),u=t+1,h=t-1,d=1;for(;u<=s||h>=n;){const f=this.radPower[d++]/262144;if(u<=s){const c=this.network[u++];c[0]-=f*(c[0]-i),c[1]-=f*(c[1]-r),c[2]-=f*(c[2]-a)}if(h>=n){const c=this.network[h--];c[0]-=f*(c[0]-i),c[1]-=f*(c[1]-r),c[2]-=f*(c[2]-a)}}}map(e,t,i){let r=1073741824,a=-1;for(let n=0;n<this.netsize;n+=1){const s=this.network[n],u=Math.abs(s[0]-e)+Math.abs(s[1]-t)+Math.abs(s[2]-i);u<r&&(r=u,a=n)}return a}colorMap(){const e=new Uint8Array(this.netsize*3);for(let t=0;t<this.netsize;t+=1){const i=this.netIndex[t]??t,r=this.network[i]??this.network[t]??[0,0,0];e[t*3+0]=Math.max(0,Math.min(255,Math.round(r[0]))),e[t*3+1]=Math.max(0,Math.min(255,Math.round(r[1]))),e[t*3+2]=Math.max(0,Math.min(255,Math.round(r[2])))}return e}}class T{constructor(e,t){Object.defineProperty(this,"width",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"height",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"transparent",{enumerable:!0,configurable:!0,writable:!0,value:-1}),Object.defineProperty(this,"repeat",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"delay",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"started",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"out",{enumerable:!0,configurable:!0,writable:!0,value:new k}),Object.defineProperty(this,"image",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"indexedPixels",{enumerable:!0,configurable:!0,writable:!0,value:new Uint8Array(0)}),Object.defineProperty(this,"colorDepth",{enumerable:!0,configurable:!0,writable:!0,value:8}),Object.defineProperty(this,"colorTab",{enumerable:!0,configurable:!0,writable:!0,value:new Uint8Array(0)}),Object.defineProperty(this,"usedEntry",{enumerable:!0,configurable:!0,writable:!0,value:new Array(256).fill(!1)}),Object.defineProperty(this,"palSize",{enumerable:!0,configurable:!0,writable:!0,value:7}),Object.defineProperty(this,"sample",{enumerable:!0,configurable:!0,writable:!0,value:10}),Object.defineProperty(this,"dispose",{enumerable:!0,configurable:!0,writable:!0,value:-1}),Object.defineProperty(this,"firstFrame",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.width=e,this.height=t}setDelay(e){this.delay=Math.round(e/10)}setFrameRate(e){this.delay=Math.round(100/e)}setRepeat(e){this.repeat=e}setTransparent(e){this.transparent=e}setDispose(e){e>=0&&(this.dispose=e)}setQuality(e){e<1&&(e=1),this.sample=e}start(){this.writeString("GIF89a"),this.started=!0}addFrame(e){if(!this.started)throw new Error("Encoder not started.");return this.image=e.getImageData(0,0,this.width,this.height),this.analyzePixels(),this.firstFrame&&(this.writeLSD(),this.writePalette(),this.repeat>=0&&this.writeNetscapeExt()),this.writeGraphicCtrlExt(),this.writeImageDesc(),this.firstFrame||this.writePalette(),this.writePixels(),this.firstFrame=!1,!0}finish(){return this.started?(this.out.writeByte(59),this.started=!1,!0):!1}stream(){return this.out}analyzePixels(){if(!this.image)return;const e=this.image.data.length,t=new Uint8Array(e/4*3),i=this.image.data;let r=0;for(let u=0;u<e;u+=4)t[r++]=i[u],t[r++]=i[u+1],t[r++]=i[u+2];const a=new D(t,this.sample);this.colorTab=a.colorMap(),this.colorDepth=8,this.palSize=7;const n=this.colorTab.length/3;this.usedEntry=new Array(n).fill(!1),this.indexedPixels=new Uint8Array(this.width*this.height);let s=0;for(let u=0;u<this.width*this.height;u+=1){const h=i[s++],d=i[s++],f=i[s++];s++;const c=a.map(h,d,f);this.usedEntry[c]=!0,this.indexedPixels[u]=c}this.image=null}writeGraphicCtrlExt(){this.out.writeByte(33),this.out.writeByte(249),this.out.writeByte(4);let e=0,t=0;this.transparent>=0&&(e=1),this.dispose>=0&&(t=this.dispose&7),t<<=2,this.out.writeByte(t|e),this.writeShort(this.delay),this.out.writeByte(this.transparent>=0?this.transparent:0),this.out.writeByte(0)}writeImageDesc(){this.out.writeByte(44),this.writeShort(0),this.writeShort(0),this.writeShort(this.width),this.writeShort(this.height),this.firstFrame?this.out.writeByte(0):this.out.writeByte(128|this.palSize)}writeLSD(){this.writeShort(this.width),this.writeShort(this.height),this.out.writeByte(240|this.palSize),this.out.writeByte(0),this.out.writeByte(0)}writePalette(){this.out.writeBytes(this.colorTab);const e=3*256-this.colorTab.length;for(let t=0;t<e;t+=1)this.out.writeByte(0)}writePixels(){new F(this.width,this.height,this.indexedPixels,this.colorDepth).encode(this.out)}writeShort(e){this.out.writeByte(e&255),this.out.writeByte(e>>8&255)}writeString(e){this.out.writeUTFBytes(e)}writeNetscapeExt(){this.out.writeByte(33),this.out.writeByte(255),this.out.writeByte(11),this.writeString("NETSCAPE2.0"),this.out.writeByte(3),this.out.writeByte(1),this.writeShort(this.repeat),this.out.writeByte(0)}}const O=10*1024*1024,l={width:document.getElementById("width-range"),fps:document.getElementById("fps-range"),quality:document.getElementById("quality-range"),download:document.getElementById("download-link"),convert:document.getElementById("convert-button"),status:document.getElementById("status"),video:document.getElementById("preview-video"),canvas:document.getElementById("working-canvas")},z=document.getElementById("width-value"),q=document.getElementById("fps-value"),U=document.getElementById("quality-value"),B=document.getElementById("dropzone"),N=document.getElementById("file-input");let j=null,x=null;const M=()=>{z.textContent=`${l.width.value}px`,q.textContent=`${l.fps.value}fps`,U.textContent=`${l.quality.value}/8`};M();const m=(o,e=!1)=>{l.status.textContent=o,l.status.dataset.state=e?"error":"normal"},S=()=>{l.video.removeAttribute("src"),l.video.load(),l.convert.disabled=!0,l.download.setAttribute("aria-disabled","true"),l.download.removeAttribute("href"),m("動画ファイルを読み込んでください。")},C=o=>{if(!o.type.startsWith("video/")){m("対応していないファイル形式です。動画ファイルを選択してください。",!0);return}j=o,x&&(URL.revokeObjectURL(x),x=null),x=URL.createObjectURL(o),l.video.src=x,l.video.onloadedmetadata=()=>{l.video.currentTime=0,l.convert.disabled=!1;const e=Math.min(960,Math.round(l.video.videoWidth));l.width.max=String(Math.max(160,e)),l.width.value=String(Math.min(e,Number(l.width.value))),z.textContent=`${l.width.value}px`,m("動画が読み込まれました。設定を調整して「GIF を作成」を押してください。")},l.video.onerror=()=>{m("動画の読み込みに失敗しました。",!0),S()}},$=o=>{var e,t;o.preventDefault(),B.classList.remove("drag-over"),(t=(e=o.dataTransfer)==null?void 0:e.files)!=null&&t.length&&C(o.dataTransfer.files[0])},R=async(o,e,t)=>{const i=e.width,r=o.videoHeight/o.videoWidth,a=Math.round(i*r);l.canvas.width=i,l.canvas.height=a;const n=l.canvas.getContext("2d");if(!n)throw new Error("Canvas が利用できません。");const s=new T(i,a);s.setRepeat(0),s.setDelay(Math.round(1e3/e.fps)),s.setQuality(e.quality),s.start();const u=o.duration,h=Math.max(1,Math.floor(u*e.fps)),d=Math.round(1e3/e.fps);s.setDelay(d);for(let w=0;w<h;w+=1){if(t.aborted)throw new Error("処理が中断されました。");const b=Math.min(u,w/e.fps);await W(o,b),n.drawImage(o,0,0,i,a),s.addFrame(n),m(`フレームを処理中... (${w+1}/${h})`),await G()}s.finish();const f=s.stream().getData(),c=new Uint8Array(f.length);return c.set(f),new Blob([c.buffer],{type:"image/gif"})},W=(o,e)=>new Promise((t,i)=>{const r=()=>{o.removeEventListener("seeked",r),o.removeEventListener("error",a),t()},a=()=>{o.removeEventListener("seeked",r),o.removeEventListener("error",a),i(new Error("動画のシークに失敗しました。"))};o.addEventListener("seeked",r,{once:!0}),o.addEventListener("error",a,{once:!0}),o.currentTime=e}),G=()=>new Promise(o=>{requestAnimationFrame(()=>o())}),V=async(o,e,t)=>{let i=e.width,r=e.fps,a=0,n=null;for(;i>=160&&r>=5;){a+=1,m(`変換中... (試行 ${a})`);const s=await R(o,{...e,width:i,fps:r},t);if(s.size<=O)return{blob:s,width:i,fps:r,iterations:a};if(n=s,i>320){i=Math.floor(i*.85);continue}r=Math.max(5,r-2)}if(n)return{blob:n,width:i,fps:r,iterations:a};throw new Error("出力サイズを 10MB 以下に抑えられませんでした。設定を見直してください。")};let E=null;l.convert.addEventListener("click",async()=>{if(!(!j||!x)){E&&E.abort(),E=new AbortController,l.convert.disabled=!0,l.download.setAttribute("aria-disabled","true"),l.download.removeAttribute("href"),m("変換を開始しました...");try{l.video.pause(),l.video.currentTime=0;const o={width:Number.parseInt(l.width.value,10),fps:Number.parseInt(l.fps.value,10),quality:Number.parseInt(l.quality.value,10)},e=await V(l.video,o,E.signal),t=URL.createObjectURL(e.blob);l.download.href=t,l.download.download=`${j.name.replace(/\.[^.]+$/,"")||"output"}.gif`,l.download.setAttribute("aria-disabled","false"),m(e.blob.size<=O?`変換が完了しました！ (${I(e.blob.size)})`:`変換は完了しましたが 10MB を超えています (${I(e.blob.size)})。解像度やフレームレートを下げて再試行してください。`,e.blob.size>O)}catch(o){console.error(o),m(o instanceof Error?o.message:"変換中にエラーが発生しました。",!0)}finally{l.convert.disabled=!1,E=null}}});N.addEventListener("change",o=>{var t;const e=o.target;(t=e.files)!=null&&t.length&&C(e.files[0])});B.addEventListener("dragover",o=>{o.preventDefault(),B.classList.add("drag-over")});B.addEventListener("dragleave",()=>{B.classList.remove("drag-over")});B.addEventListener("drop",$);l.width.addEventListener("input",M);l.fps.addEventListener("input",M);l.quality.addEventListener("input",M);l.download.addEventListener("click",()=>{l.download.getAttribute("aria-disabled")!=="true"&&m("GIF をダウンロードしています...")});const I=o=>o<1024?`${o}B`:o<1024*1024?`${(o/1024).toFixed(1)}KB`:`${(o/(1024*1024)).toFixed(2)}MB`;S();
