var q=Object.defineProperty;var N=(r,t,e)=>t in r?q(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var d=(r,t,e)=>N(r,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function e(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=e(s);fetch(s.href,n)}})();class U{constructor(){d(this,"data",[])}writeByte(t){this.data.push(t&255)}writeUTFBytes(t){for(let e=0;e<t.length;e+=1)this.writeByte(t.charCodeAt(e))}writeBytes(t,e=0,i=t.length){for(let s=e;s<e+i;s+=1)this.writeByte(t[s])}getData(){return Uint8Array.from(this.data)}}class ${constructor(t,e,i,s){d(this,"imgW");d(this,"imgH");d(this,"pixAry");d(this,"initCodeSize");d(this,"curAccum",0);d(this,"curBits",0);d(this,"masks",[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535]);d(this,"aCount",0);d(this,"accum",new Uint8Array(256));this.imgW=t,this.imgH=e,this.pixAry=i,this.initCodeSize=Math.max(2,s)}encode(t){t.writeByte(this.initCodeSize),this.compress(this.initCodeSize+1,t),t.writeByte(0)}charOut(t,e){this.accum[this.aCount]=t,this.aCount+=1,this.aCount>=254&&this.flushChar(e)}flushChar(t){this.aCount>0&&(t.writeByte(this.aCount),t.writeBytes(this.accum,0,this.aCount),this.aCount=0)}clBlock(t,e,i,s,n,a){this.resetCodeTable(e),s.value=1<<i-1,n.value=!0;const o=1<<i-1;this.output(o,t,i,n),a.value=this.pixAry[0]&255}resetCodeTable(t){t.fill(-1)}compress(t,e){const s=new Int32Array(5003),n=new Int32Array(5003);this.resetCodeTable(s);let a=this.pixAry[0]&255;Math.max(0,Math.min(8,Math.floor(Math.log(this.initCodeSize)/Math.LN2)));const o=1<<t-1,h=o+1;let u=o+2,w=t,f=(1<<w)-1,c=!1;this.output(o,e,w,{value:c});const y={value:0},m={value:0},g={value:u},p={value:c},b=M=>{let B=M;return B+=B<<8>>>0,B^=B>>4,B%5003};for(let M=1;M<this.pixAry.length;M+=1){const B=this.pixAry[M]&255;y.value=(B<<12)+a;const D=b(y.value);if(m.value=D,s[m.value]===y.value){a=n[m.value];continue}if(s[m.value]>=0){let C=5003-m.value;m.value===0&&(C=1);do if(m.value-=C,m.value<0&&(m.value+=5003),s[m.value]===y.value){a=n[m.value];break}while(s[m.value]>=0);if(s[m.value]===y.value)continue}this.output(a,e,w,p),a=B,g.value<4096?(n[m.value]=g.value,s[m.value]=y.value,g.value+=1):(this.clBlock(e,s,w,g,p,{value:a}),a=B),g.value>f&&w<12&&(w+=1,f=(1<<w)-1)}this.output(a,e,w,p),this.output(h,e,w,p)}output(t,e,i,s){for(this.curAccum&=this.masks[this.curBits],this.curBits>0?this.curAccum|=t<<this.curBits:this.curAccum=t,this.curBits+=i;this.curBits>=8;)this.charOut(this.curAccum&255,e),this.curAccum>>=8,this.curBits-=8;s.value&&(this.curAccum=0,this.curBits=0,s.value=!1)}}class R{constructor(t,e){d(this,"netsize",256);d(this,"network",[]);d(this,"bias",new Int32Array(this.netsize));d(this,"freq",new Int32Array(this.netsize));d(this,"radPower",new Int32Array(this.netsize>>3));d(this,"netIndex",new Int32Array(256));for(let i=0;i<this.netsize;i+=1){const s=(i<<16)/this.netsize;this.network[i]=[s,s,s],this.freq[i]=65536,this.bias[i]=0}this.learn(t,e),this.buildIndex()}learn(t,e){const i=t.length,s=30+(e-1)/3;let n=i/(3*e),a=0,o=1024,h=(this.netsize>>3)-1;n<this.netsize&&(n=this.netsize);let u=h>>3;u<=1&&(u=0);for(let c=0;c<u;c+=1)this.radPower[c]=o*((u*u-c*c)*256/(u*u));let w=0;i<1509?w=3:i%499!==0?w=499:i%491!==0?w=491:i%487!==0?w=487:w=503;let f=0;for(let c=0;c<n;c+=1){const y=t[f]&255,m=t[f+1]&255,g=t[f+2]&255,p=this.contest(y,m,g);if(this.alterSingle(o,p,y,m,g),u!==0&&this.alterNeigh(u,p,y,m,g),f+=w*3,f>=i&&(f-=i),a+=1,a%100===0){o-=o/s,h-=h/30,u=h>>3,u<=1&&(u=0);for(let b=0;b<u;b+=1)this.radPower[b]=o*((u*u-b*b)*256/(u*u))}}}buildIndex(){let t=0,e=0;for(let i=0;i<this.netsize;i+=1){const s=this.network[i];let n=i,a=s[1];for(let o=i+1;o<this.netsize;o+=1){const h=this.network[o];h[1]<a&&(n=o,a=h[1])}if(i!==n){const o=this.network[n];[this.network[i],this.network[n]]=[o,s]}if(a!==t){this.netIndex[t]=e+i>>1;for(let o=t+1;o<a;o+=1)this.netIndex[o]=i;t=a,e=i}}this.netIndex[t]=e+this.netsize-1>>1;for(let i=t+1;i<256;i+=1)this.netIndex[i]=this.netsize-1}contest(t,e,i){let s=-1,n=1<<31,a=n;for(let o=0;o<this.netsize;o+=1){const h=this.network[o],u=Math.abs(h[0]-t)+Math.abs(h[1]-e)+Math.abs(h[2]-i);u<n&&(n=u,s=o);const w=u-(this.bias[o]>>12);w<a&&(a=w,s=o),this.freq[o]-=this.freq[o]>>10,this.bias[o]+=this.freq[o]<<10}return this.freq[s]+=64,this.bias[s]-=65536,s}alterSingle(t,e,i,s,n){const a=this.network[e];a[0]-=t*(a[0]-i)/1024,a[1]-=t*(a[1]-s)/1024,a[2]-=t*(a[2]-n)/1024}alterNeigh(t,e,i,s,n){let a=Math.max(e-t,0),o=Math.min(e+t,this.netsize-1),h=e+1,u=e-1,w=1;for(;h<=o||u>=a;){const f=this.radPower[w++]/262144;if(h<=o){const c=this.network[h++];c[0]-=f*(c[0]-i),c[1]-=f*(c[1]-s),c[2]-=f*(c[2]-n)}if(u>=a){const c=this.network[u--];c[0]-=f*(c[0]-i),c[1]-=f*(c[1]-s),c[2]-=f*(c[2]-n)}}}map(t,e,i){let s=1073741824,n=-1;for(let a=0;a<this.netsize;a+=1){const o=this.network[a],h=Math.abs(o[0]-t)+Math.abs(o[1]-e)+Math.abs(o[2]-i);h<s&&(s=h,n=a)}return n}colorMap(){const t=new Uint8Array(this.netsize*3);for(let e=0;e<this.netsize;e+=1){const i=this.netIndex[e],s=Number.isInteger(i)&&i>=0&&i<this.netsize?i:e,n=this.network[s]??this.network[e]??[0,0,0],a=e*3;t[a]=Math.max(0,Math.min(255,Math.round(n[0]))),t[a+1]=Math.max(0,Math.min(255,Math.round(n[1]))),t[a+2]=Math.max(0,Math.min(255,Math.round(n[2])))}return t}}class O{constructor(t,e){d(this,"width");d(this,"height");d(this,"transparent",-1);d(this,"repeat",0);d(this,"delay",0);d(this,"started",!1);d(this,"out",new U);d(this,"image",null);d(this,"indexedPixels",new Uint8Array(0));d(this,"colorDepth",8);d(this,"colorTab",new Uint8Array(0));d(this,"usedEntry",new Array(256).fill(!1));d(this,"palSize",7);d(this,"sample",10);d(this,"dispose",-1);d(this,"firstFrame",!0);this.width=t,this.height=e}setDelay(t){this.delay=Math.round(t/10)}setFrameRate(t){this.delay=Math.round(100/t)}setRepeat(t){this.repeat=t}setTransparent(t){this.transparent=t}setDispose(t){t>=0&&(this.dispose=t)}setQuality(t){t<1&&(t=1),this.sample=t}start(){this.writeString("GIF89a"),this.started=!0}addFrame(t){if(!this.started)throw new Error("Encoder not started.");return this.image=t.getImageData(0,0,this.width,this.height),this.analyzePixels(),this.firstFrame&&(this.writeLSD(),this.writePalette(),this.repeat>=0&&this.writeNetscapeExt()),this.writeGraphicCtrlExt(),this.writeImageDesc(),this.firstFrame||this.writePalette(),this.writePixels(),this.firstFrame=!1,!0}finish(){return this.started?(this.out.writeByte(59),this.started=!1,!0):!1}stream(){return this.out}analyzePixels(){if(!this.image)return;const t=this.image.data.length,e=new Uint8Array(t/4*3),i=this.image.data;let s=0;for(let h=0;h<t;h+=4)e[s++]=i[h],e[s++]=i[h+1],e[s++]=i[h+2];const n=new R(e,this.sample);this.colorTab=n.colorMap(),this.colorDepth=8,this.palSize=7;const a=this.colorTab.length/3;this.usedEntry=new Array(a).fill(!1),this.indexedPixels=new Uint8Array(this.width*this.height);let o=0;for(let h=0;h<this.width*this.height;h+=1){const u=i[o++],w=i[o++],f=i[o++];o++;const c=n.map(u,w,f);this.usedEntry[c]=!0,this.indexedPixels[h]=c}this.image=null}writeGraphicCtrlExt(){this.out.writeByte(33),this.out.writeByte(249),this.out.writeByte(4);let t=0,e=0;this.transparent>=0&&(t=1),this.dispose>=0&&(e=this.dispose&7),e<<=2,this.out.writeByte(e|t),this.writeShort(this.delay),this.out.writeByte(this.transparent>=0?this.transparent:0),this.out.writeByte(0)}writeImageDesc(){this.out.writeByte(44),this.writeShort(0),this.writeShort(0),this.writeShort(this.width),this.writeShort(this.height),this.firstFrame?this.out.writeByte(0):this.out.writeByte(128|this.palSize)}writeLSD(){this.writeShort(this.width),this.writeShort(this.height),this.out.writeByte(240|this.palSize),this.out.writeByte(0),this.out.writeByte(0)}writePalette(){this.out.writeBytes(this.colorTab);const t=3*256-this.colorTab.length;for(let e=0;e<t;e+=1)this.out.writeByte(0)}writePixels(){new $(this.width,this.height,this.indexedPixels,this.colorDepth).encode(this.out)}writeShort(t){this.out.writeByte(t&255),this.out.writeByte(t>>8&255)}writeString(t){this.out.writeUTFBytes(t)}writeNetscapeExt(){this.out.writeByte(33),this.out.writeByte(255),this.out.writeByte(11),this.writeString("NETSCAPE2.0"),this.out.writeByte(3),this.out.writeByte(1),this.writeShort(this.repeat),this.out.writeByte(0)}}const z=10*1024*1024,l={width:document.getElementById("width-range"),fps:document.getElementById("fps-range"),quality:document.getElementById("quality-range"),download:document.getElementById("download-link"),convert:document.getElementById("convert-button"),status:document.getElementById("status"),video:document.getElementById("preview-video"),canvas:document.getElementById("working-canvas")},F=document.getElementById("width-value"),W=document.getElementById("fps-value"),j=document.getElementById("quality-value"),E=document.getElementById("dropzone"),G=document.getElementById("file-input");let S=null,x=null;const I=()=>{F.textContent=`${l.width.value}px`,W.textContent=`${l.fps.value}fps`,j.textContent=`${l.quality.value}/8`};I();const v=(r,t=!1)=>{l.status.textContent=r,l.status.dataset.state=t?"error":"normal"},k=()=>{l.video.removeAttribute("src"),l.video.load(),l.convert.disabled=!0,l.download.setAttribute("aria-disabled","true"),l.download.removeAttribute("href"),v("動画ファイルを読み込んでください。")},P=r=>{if(!r.type.startsWith("video/")){v("対応していないファイル形式です。動画ファイルを選択してください。",!0);return}S=r,x&&(URL.revokeObjectURL(x),x=null),x=URL.createObjectURL(r),l.video.src=x,l.video.onloadedmetadata=()=>{l.video.currentTime=0,l.convert.disabled=!1;const t=Math.min(960,Math.round(l.video.videoWidth));l.width.max=String(Math.max(160,t)),l.width.value=String(Math.min(t,Number(l.width.value))),F.textContent=`${l.width.value}px`,v("動画が読み込まれました。設定を調整して「GIF を作成」を押してください。")},l.video.onerror=()=>{v("動画の読み込みに失敗しました。",!0),k()}},H=r=>{if(!r)return null;if(r.files&&r.files.length>0)return r.files[0]??null;if(r.items){for(const t of Array.from(r.items))if(t.kind==="file"){const e=t.getAsFile();if(e)return e}}return null},V=r=>{r.preventDefault(),E.classList.remove("drag-over");const t=H(r.dataTransfer??null);t?P(t):v("ファイルをドロップしてください。フォルダは利用できません。",!0)},T=(r,t)=>new Promise(e=>{const i=s=>{r.removeEventListener(t,i),e(s)};r.addEventListener(t,i,{once:!0})}),Q=async r=>{if(r.readyState<HTMLMediaElement.HAVE_METADATA&&await T(r,"loadedmetadata"),(r.videoWidth===0||r.videoHeight===0)&&await new Promise(t=>requestAnimationFrame(t)),r.videoWidth===0||r.videoHeight===0)throw new Error("動画のメタデータを取得できませんでした。別のファイルでお試しください。");if(!Number.isFinite(r.duration)||r.duration<=0)throw new Error("動画の長さが不正です。")},_=async(r,t,e,i)=>{await Q(r);const s=Math.max(1,t),n=r.duration;if(!Number.isFinite(n)||n<=0)throw new Error("動画の長さが不正です。");const a=document.createElement("canvas"),o=Math.max(1,e)/r.videoWidth,h=Math.max(1,Math.round(r.videoWidth*o)),u=Math.max(1,Math.round(r.videoHeight*o));a.width=h,a.height=u;const w=a.getContext("2d",{willReadFrequently:!0});if(!w)throw new Error("Canvas が利用できません。");const f=[],c=1/s;for(let y=0;y<n;y+=c){if(i.aborted)throw f.forEach(p=>{var b;return(b=p.close)==null?void 0:b.call(p)}),new Error("処理が中断されました。");const m=Math.min(y,n-1e-4);await Z(r,m),w.drawImage(r,0,0,h,u);const g=await createImageBitmap(a);f.push(g)}if(f.length===0)throw new Error("GIF に変換できるフレームが生成されませんでした。");return{bitmaps:f,width:h,height:u}},K=async(r,t,e)=>{const i=Math.max(1,t.fps),{bitmaps:s,width:n,height:a}=await _(r,i,t.width,e);l.canvas.width=n,l.canvas.height=a;const o=l.canvas.getContext("2d");if(!o)throw s.forEach(f=>{var c;return(c=f.close)==null?void 0:c.call(f)}),new Error("Canvas が利用できません。");const h=new O(n,a);h.setRepeat(0),h.setDelay(Math.round(1e3/i)),h.setQuality(t.quality),h.start(),s.forEach((f,c)=>{var y;o.drawImage(f,0,0,n,a),h.addFrame(o),(y=f.close)==null||y.call(f),v(`フレームを処理中... (${c+1}/${s.length})`)}),h.finish();const u=h.stream().getData(),w=new Uint8Array(u.length);return w.set(u),new Blob([w.buffer],{type:"image/gif"})},Z=async(r,t)=>{r.currentTime=t,await T(r,"seeked").catch(()=>{throw new Error("動画のシークに失敗しました。")})},X=async(r,t,e)=>{let i=t.width,s=t.fps,n=0,a=null;for(;i>=160&&s>=5;){n+=1,v(`変換中... (試行 ${n})`);const o=await K(r,{...t,width:i,fps:s},e);if(o.size<=z)return{blob:o,width:i,fps:s,iterations:n};if(a=o,i>320){i=Math.floor(i*.85);continue}s=Math.max(5,s-2)}if(a)return{blob:a,width:i,fps:s,iterations:n};throw new Error("出力サイズを 10MB 以下に抑えられませんでした。設定を見直してください。")};let A=null;l.convert.addEventListener("click",async()=>{if(!(!S||!x)){A&&A.abort(),A=new AbortController,l.convert.disabled=!0,l.download.setAttribute("aria-disabled","true"),l.download.removeAttribute("href"),v("変換を開始しました...");try{l.video.pause(),l.video.currentTime=0;const r={width:Number.parseInt(l.width.value,10),fps:Number.parseInt(l.fps.value,10),quality:Number.parseInt(l.quality.value,10)},t=await X(l.video,r,A.signal),e=URL.createObjectURL(t.blob);l.download.href=e,l.download.download=`${S.name.replace(/\.[^.]+$/,"")||"output"}.gif`,l.download.setAttribute("aria-disabled","false"),v(t.blob.size<=z?`変換が完了しました！ (${L(t.blob.size)})`:`変換は完了しましたが 10MB を超えています (${L(t.blob.size)})。解像度やフレームレートを下げて再試行してください。`,t.blob.size>z)}catch(r){console.error(r),v(r instanceof Error?r.message:"変換中にエラーが発生しました。",!0)}finally{l.convert.disabled=!1,A=null}}});G.addEventListener("change",r=>{var e;const t=r.target;(e=t.files)!=null&&e.length&&P(t.files[0])});E.addEventListener("dragover",r=>{r.preventDefault(),E.classList.add("drag-over")});E.addEventListener("dragleave",()=>{E.classList.remove("drag-over")});E.addEventListener("drop",V);l.width.addEventListener("input",I);l.fps.addEventListener("input",I);l.quality.addEventListener("input",I);l.download.addEventListener("click",()=>{l.download.getAttribute("aria-disabled")!=="true"&&v("GIF をダウンロードしています...")});const L=r=>r<1024?`${r}B`:r<1024*1024?`${(r/1024).toFixed(1)}KB`:`${(r/(1024*1024)).toFixed(2)}MB`;k();
