(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const l of a.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&i(l)}).observe(document,{childList:!0,subtree:!0});function o(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(r){if(r.ep)return;r.ep=!0;const a=o(r);fetch(r.href,a)}})();const q="modulepreload",z=function(e){return"/dev-sandbox/tools/gifmaker/"+e},I={},N=function(t,o,i){let r=Promise.resolve();if(o&&o.length>0){document.getElementsByTagName("link");const l=document.querySelector("meta[property=csp-nonce]"),s=(l==null?void 0:l.nonce)||(l==null?void 0:l.getAttribute("nonce"));r=Promise.allSettled(o.map(d=>{if(d=z(d),d in I)return;I[d]=!0;const c=d.endsWith(".css"),y=c?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${d}"]${y}`))return;const f=document.createElement("link");if(f.rel=c?"stylesheet":q,c||(f.as="script"),f.crossOrigin="",f.href=d,s&&f.setAttribute("nonce",s),document.head.appendChild(f),c)return new Promise((m,v)=>{f.addEventListener("load",m),f.addEventListener("error",()=>v(new Error(`Unable to preload CSS for ${d}`)))})}))}function a(l){const s=new Event("vite:preloadError",{cancelable:!0});if(s.payload=l,window.dispatchEvent(s),!s.defaultPrevented)throw l}return r.then(l=>{for(const s of l||[])s.status==="rejected"&&a(s.reason);return t().catch(a)})},x=10*1024*1024,n={width:document.getElementById("width-range"),fps:document.getElementById("fps-range"),quality:document.getElementById("quality-range"),download:document.getElementById("download-link"),convert:document.getElementById("convert-button"),status:document.getElementById("status"),video:document.getElementById("preview-video"),canvas:document.getElementById("working-canvas")},A=document.getElementById("width-value"),O=document.getElementById("fps-value"),T=document.getElementById("quality-value"),p=document.getElementById("dropzone"),R=document.getElementById("file-input");let b=null,h=null,F=null,M=null,g=null;const B=()=>{F=null,M=null},C=async()=>{if(!F){if(g){await g;return}g=(async()=>{var i;u("FFmpeg モジュールを読み込んでいます...");const{createFFmpeg:e,fetchFile:t}=await N(async()=>{const{createFFmpeg:r,fetchFile:a}=await import("https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.9/dist/esm/index.js");return{createFFmpeg:r,fetchFile:a}},[]);M=t;const o=e({log:!1});(i=o.setProgress)==null||i.call(o,({ratio:r})=>{u(`FFmpeg 変換中... ${(r*100).toFixed(1)}%`)}),await o.load(),F=o})();try{await g}finally{g=null}}},E=()=>{A.textContent=`${n.width.value}px`,O.textContent=`${n.fps.value}fps`,T.textContent=`${n.quality.value}/8`};E();const u=(e,t=!1)=>{n.status.textContent=e,n.status.dataset.state=t?"error":"normal"},S=()=>{n.video.removeAttribute("src"),n.video.load(),n.convert.disabled=!0,n.download.setAttribute("aria-disabled","true"),n.download.removeAttribute("href"),u("動画ファイルを読み込んでください。")},P=e=>{if(!e.type.startsWith("video/")){u("対応していないファイル形式です。動画ファイルを選択してください。",!0);return}b=e,h&&(URL.revokeObjectURL(h),h=null),h=URL.createObjectURL(e),n.video.src=h,n.video.onloadedmetadata=()=>{n.video.currentTime=0,n.convert.disabled=!1;const t=Math.min(960,Math.round(n.video.videoWidth));n.width.max=String(Math.max(160,t)),n.width.value=String(Math.min(t,Number(n.width.value))),A.textContent=`${n.width.value}px`,u("動画が読み込まれました。設定を調整して「GIF を作成」を押してください。")},n.video.onerror=()=>{u("動画の読み込みに失敗しました。",!0),S()}},U=e=>{if(!e)return null;if(e.files&&e.files.length>0)return e.files[0]??null;if(e.items){for(const t of Array.from(e.items))if(t.kind==="file"){const o=t.getAsFile();if(o)return o}}return null},W=e=>{e.preventDefault(),p.classList.remove("drag-over");const t=U(e.dataTransfer??null);t?P(t):u("ファイルをドロップしてください。フォルダは利用できません。",!0)},k=(e,t)=>new Promise(o=>{const i=r=>{e.removeEventListener(t,i),o(r)};e.addEventListener(t,i,{once:!0})}),D=async e=>{if(e.readyState<HTMLMediaElement.HAVE_METADATA&&await k(e,"loadedmetadata"),(e.videoWidth===0||e.videoHeight===0)&&await new Promise(t=>requestAnimationFrame(t)),e.videoWidth===0||e.videoHeight===0)throw new Error("動画のメタデータを取得できませんでした。別のファイルでお試しください。");if(!Number.isFinite(e.duration)||e.duration<=0)throw new Error("動画の長さが不正です。")},V=(e,t,o)=>{const i=["none","floyd_steinberg","sierra2","sierra2_4a","bayer:bayer_scale=5:diffusion=1","bayer:bayer_scale=4:diffusion=1","bayer:bayer_scale=3:diffusion=1","bayer:bayer_scale=2:diffusion=1"],r=Math.min(i.length-1,Math.max(0,Math.round(o)-1)),a=i[r];return`fps=${e},scale=${t}:-1:flags=lanczos,split[a][b];[a]palettegen=stats_mode=full[p];[b][p]paletteuse=dither=${a}`},j=async(e,t,o)=>{await C();const i=F,r=M;if(!i||!r)throw new Error("FFmpeg の初期化に失敗しました。");const a=Math.max(160,Math.round(t.width)),l=Math.max(1,Math.round(t.fps)),s=Math.max(1,Math.round(t.quality)),d=`input-${Date.now()}.mp4`,c=`output-${Date.now()}.gif`;let y=!1;const f=()=>{y=!0;try{i.exit()}catch(m){console.warn("FFmpeg exit error:",m)}B()};o.addEventListener("abort",f,{once:!0});try{u("FFmpeg で GIF を生成しています...");const m=await r(e);i.FS("writeFile",d,m);const v=V(l,a,s);await i.run("-i",d,"-vf",v,"-loop","0",c);const _=i.FS("readFile",c);return new Blob([_],{type:"image/gif"})}catch(m){if(y)throw new Error("処理が中断されました。");try{i.exit()}catch(v){console.warn("FFmpeg exit error:",v)}throw B(),m}finally{o.removeEventListener("abort",f);try{i.FS("unlink",d)}catch(m){console.warn("Failed to remove input from FFmpeg FS",m)}try{i.FS("unlink",c)}catch(m){console.warn("Failed to remove output from FFmpeg FS",m)}}},H=async(e,t,o,i)=>{await D(t);let r=Math.max(160,Math.round(o.width)),a=Math.max(1,Math.round(o.fps));const l=Math.max(1,Math.round(o.quality));let s=0,d=null;for(;r>=160&&a>=5;){s+=1,u(`変換中... (試行 ${s})`);const c=await j(e,{width:r,fps:a,quality:l},i);if(c.size<=x)return{blob:c,width:r,fps:a,iterations:s};if(d=c,r>320){r=Math.max(160,Math.floor(r*.85));continue}a=Math.max(5,a-2)}if(d)return{blob:d,width:r,fps:a,iterations:s};throw new Error("出力サイズを 10MB 以下に抑えられませんでした。設定を見直してください。")};let w=null;n.convert.addEventListener("click",async()=>{if(!(!b||!h)){w&&w.abort(),w=new AbortController,n.convert.disabled=!0,n.download.setAttribute("aria-disabled","true"),n.download.removeAttribute("href"),u("変換を開始しました...");try{n.video.pause(),n.video.currentTime=0;const e={width:L(n.width.value,n.video.videoWidth||480,160,960),fps:L(n.fps.value,12,1,60),quality:L(n.quality.value,6,1,8)},t=await H(b,n.video,e,w.signal),o=URL.createObjectURL(t.blob);n.download.href=o,n.download.download=`${b.name.replace(/\.[^.]+$/,"")||"output"}.gif`,n.download.setAttribute("aria-disabled","false"),u(t.blob.size<=x?`変換が完了しました！ (${$(t.blob.size)})`:`変換は完了しましたが 10MB を超えています (${$(t.blob.size)})。解像度やフレームレートを下げて再試行してください。`,t.blob.size>x)}catch(e){console.error(e),u(e instanceof Error?e.message:"変換中にエラーが発生しました。",!0)}finally{n.convert.disabled=!1,w=null}}});R.addEventListener("change",e=>{var o;const t=e.target;(o=t.files)!=null&&o.length&&P(t.files[0])});p.addEventListener("dragover",e=>{e.preventDefault(),p.classList.add("drag-over")});p.addEventListener("dragleave",()=>{p.classList.remove("drag-over")});p.addEventListener("drop",W);n.width.addEventListener("input",E);n.fps.addEventListener("input",E);n.quality.addEventListener("input",E);n.download.addEventListener("click",()=>{n.download.getAttribute("aria-disabled")!=="true"&&u("GIF をダウンロードしています...")});const $=e=>e<1024?`${e}B`:e<1024*1024?`${(e/1024).toFixed(1)}KB`:`${(e/(1024*1024)).toFixed(2)}MB`,L=(e,t,o=0,i=Number.POSITIVE_INFINITY)=>{const r=Number.parseFloat(e);return Number.isFinite(r)?Math.min(Math.max(r,o),i):t};S();
