(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const l of n)if(l.type==="childList")for(const i of l.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function a(n){const l={};return n.integrity&&(l.integrity=n.integrity),n.referrerPolicy&&(l.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?l.credentials="include":n.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function o(n){if(n.ep)return;n.ep=!0;const l=a(n);fetch(n.href,l)}})();const q="modulepreload",O=function(e){return"/dev-sandbox/tools/gifmaker/"+e},I={},T=function(t,a,o){let n=Promise.resolve();if(a&&a.length>0){document.getElementsByTagName("link");const i=document.querySelector("meta[property=csp-nonce]"),s=(i==null?void 0:i.nonce)||(i==null?void 0:i.getAttribute("nonce"));n=Promise.allSettled(a.map(d=>{if(d=O(d),d in I)return;I[d]=!0;const m=d.endsWith(".css"),y=m?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${d}"]${y}`))return;const u=document.createElement("link");if(u.rel=m?"stylesheet":q,m||(u.as="script"),u.crossOrigin="",u.href=d,s&&u.setAttribute("nonce",s),document.head.appendChild(u),m)return new Promise((f,g)=>{u.addEventListener("load",f),u.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${d}`)))})}))}function l(i){const s=new Event("vite:preloadError",{cancelable:!0});if(s.payload=i,window.dispatchEvent(s),!s.defaultPrevented)throw i}return n.then(i=>{for(const s of i||[])s.status==="rejected"&&l(s.reason);return t().catch(l)})},x=10*1024*1024,r={width:document.getElementById("width-range"),fps:document.getElementById("fps-range"),quality:document.getElementById("quality-range"),download:document.getElementById("download-link"),convert:document.getElementById("convert-button"),status:document.getElementById("status"),video:document.getElementById("preview-video"),canvas:document.getElementById("working-canvas")},$=document.getElementById("width-value"),z=document.getElementById("fps-value"),N=document.getElementById("quality-value"),p=document.getElementById("dropzone"),R=document.getElementById("file-input");let b=null,h=null,F=null,M=null,v=null;const C="https://cdnjs.cloudflare.com/ajax/libs/ffmpeg/0.12.15/ffmpeg-core.js",B=()=>{F=null,M=null},U=async()=>{if(!F){if(v){await v;return}v=(async()=>{var n,l,i;c("FFmpeg モジュールを読み込んでいます...");const e=await T(()=>import("https://cdnjs.cloudflare.com/ajax/libs/ffmpeg/0.12.15/esm/index.js"),[]),t=e.createFFmpeg??((n=e.default)==null?void 0:n.createFFmpeg),a=e.fetchFile??((l=e.default)==null?void 0:l.fetchFile);if(!t||!a)throw new Error("FFmpeg モジュールの読み込みに失敗しました");M=a;const o=t({log:!1,corePath:C});(i=o.setProgress)==null||i.call(o,({ratio:s})=>{c(`FFmpeg 変換中... ${(s*100).toFixed(1)}%`)}),await o.load(),F=o})();try{await v}finally{v=null}}},E=()=>{$.textContent=`${r.width.value}px`,z.textContent=`${r.fps.value}fps`,N.textContent=`${r.quality.value}/8`};E();const c=(e,t=!1)=>{r.status.textContent=e,r.status.dataset.state=t?"error":"normal"},P=()=>{r.video.removeAttribute("src"),r.video.load(),r.convert.disabled=!0,r.download.setAttribute("aria-disabled","true"),r.download.removeAttribute("href"),c("動画ファイルを読み込んでください。")},S=e=>{if(!e.type.startsWith("video/")){c("対応していないファイル形式です。動画ファイルを選択してください。",!0);return}b=e,h&&(URL.revokeObjectURL(h),h=null),h=URL.createObjectURL(e),r.video.src=h,r.video.onloadedmetadata=()=>{r.video.currentTime=0,r.convert.disabled=!1;const t=Math.min(960,Math.round(r.video.videoWidth));r.width.max=String(Math.max(160,t)),r.width.value=String(Math.min(t,Number(r.width.value))),$.textContent=`${r.width.value}px`,c("動画が読み込まれました。設定を調整して「GIF を作成」を押してください。")},r.video.onerror=()=>{c("動画の読み込みに失敗しました。",!0),P()}},W=e=>{if(!e)return null;if(e.files&&e.files.length>0)return e.files[0]??null;if(e.items){for(const t of Array.from(e.items))if(t.kind==="file"){const a=t.getAsFile();if(a)return a}}return null},j=e=>{e.preventDefault(),p.classList.remove("drag-over");const t=W(e.dataTransfer??null);t?S(t):c("ファイルをドロップしてください。フォルダは利用できません。",!0)},k=(e,t,a)=>{const o=["none","floyd_steinberg","sierra2","sierra2_4a","bayer:bayer_scale=5:diffusion=1","bayer:bayer_scale=4:diffusion=1","bayer:bayer_scale=3:diffusion=1","bayer:bayer_scale=2:diffusion=1"],n=Math.min(o.length-1,Math.max(0,Math.round(a)-1)),l=o[n];return`fps=${e},scale=${t}:-1:flags=lanczos,split[a][b];[a]palettegen=stats_mode=full[p];[b][p]paletteuse=dither=${l}`},D=async(e,t,a)=>{await U();const o=F,n=M;if(!o||!n)throw new Error("FFmpeg の初期化に失敗しました。");const l=Math.max(160,Math.round(t.width)),i=Math.max(1,Math.round(t.fps)),s=Math.max(1,Math.round(t.quality)),d=`input-${Date.now()}.mp4`,m=`output-${Date.now()}.gif`;let y=!1;const u=()=>{y=!0;try{o.exit()}catch(f){console.warn("FFmpeg exit error:",f)}B()};a.addEventListener("abort",u,{once:!0});try{c("FFmpeg で GIF を生成しています...");const f=await n(e);o.FS("writeFile",d,f);const g=k(i,l,s);await o.run("-i",d,"-vf",g,"-loop","0",m);const _=o.FS("readFile",m);return new Blob([_],{type:"image/gif"})}catch(f){if(y)throw new Error("処理が中断されました。");try{o.exit()}catch(g){console.warn("FFmpeg exit error:",g)}throw B(),f}finally{a.removeEventListener("abort",u);try{o.FS("unlink",d)}catch(f){console.warn("Failed to remove input from FFmpeg FS",f)}try{o.FS("unlink",m)}catch(f){console.warn("Failed to remove output from FFmpeg FS",f)}}},V=async(e,t,a)=>{let o=Math.max(160,Math.round(t.width)),n=Math.max(1,Math.round(t.fps));const l=Math.max(1,Math.round(t.quality));let i=0,s=null;for(;o>=160&&n>=5;){i+=1,c(`変換中... (試行 ${i})`);const d=await D(e,{width:o,fps:n,quality:l},a);if(d.size<=x)return{blob:d,width:o,fps:n,iterations:i};if(s=d,o>320){o=Math.max(160,Math.floor(o*.85));continue}n=Math.max(5,n-2)}if(s)return{blob:s,width:o,fps:n,iterations:i};throw new Error("出力サイズを 10MB 以下に抑えられませんでした。設定を見直してください。")};let w=null;r.convert.addEventListener("click",async()=>{if(!(!b||!h)){w&&w.abort(),w=new AbortController,r.convert.disabled=!0,r.download.setAttribute("aria-disabled","true"),r.download.removeAttribute("href"),c("変換を開始しました...");try{r.video.pause(),r.video.currentTime=0,await G(r.video);const e={width:L(r.width.value,r.video.videoWidth||480,160,960),fps:L(r.fps.value,12,1,60),quality:L(r.quality.value,6,1,8)},t=await V(b,e,w.signal),a=URL.createObjectURL(t.blob);r.download.href=a,r.download.download=`${b.name.replace(/\.[^.]+$/,"")||"output"}.gif`,r.download.setAttribute("aria-disabled","false"),c(t.blob.size<=x?`変換が完了しました！ (${A(t.blob.size)})`:`変換は完了しましたが 10MB を超えています (${A(t.blob.size)})。解像度やフレームレートを下げて再試行してください。`,t.blob.size>x)}catch(e){console.error(e),c(e instanceof Error?e.message:"変換中にエラーが発生しました。",!0)}finally{r.convert.disabled=!1,w=null}}});R.addEventListener("change",e=>{var a;const t=e.target;(a=t.files)!=null&&a.length&&S(t.files[0])});p.addEventListener("dragover",e=>{e.preventDefault(),p.classList.add("drag-over")});p.addEventListener("dragleave",()=>{p.classList.remove("drag-over")});p.addEventListener("drop",j);r.width.addEventListener("input",E);r.fps.addEventListener("input",E);r.quality.addEventListener("input",E);r.download.addEventListener("click",()=>{r.download.getAttribute("aria-disabled")!=="true"&&c("GIF をダウンロードしています...")});const A=e=>e<1024?`${e}B`:e<1024*1024?`${(e/1024).toFixed(1)}KB`:`${(e/(1024*1024)).toFixed(2)}MB`,L=(e,t,a=0,o=Number.POSITIVE_INFINITY)=>{const n=Number.parseFloat(e);return Number.isFinite(n)?Math.min(Math.max(n,a),o):t};P();const H=(e,t)=>new Promise(a=>{const o=n=>{e.removeEventListener(t,o),a(n)};e.addEventListener(t,o,{once:!0})}),G=async e=>{if(e.readyState<HTMLMediaElement.HAVE_METADATA&&await H(e,"loadedmetadata"),(e.videoWidth===0||e.videoHeight===0)&&await new Promise(t=>requestAnimationFrame(t)),e.videoWidth===0||e.videoHeight===0)throw new Error("動画のメタデータを取得できませんでした。別のファイルでお試しください。");if(!Number.isFinite(e.duration)||e.duration<=0)throw new Error("動画の長さが不正です。")};
