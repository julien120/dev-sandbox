var re=Object.defineProperty;var G=e=>{throw TypeError(e)};var ne=(e,t,r)=>t in e?re(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var u=(e,t,r)=>ne(e,typeof t!="symbol"?t+"":t,r),V=(e,t,r)=>t.has(e)||G("Cannot "+r);var i=(e,t,r)=>(V(e,t,"read from private field"),r?r.call(e):t.get(e)),g=(e,t,r)=>t.has(e)?G("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,r),D=(e,t,r,n)=>(V(e,t,"write to private field"),n?n.call(e,r):t.set(e,r),r);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const l of o)if(l.type==="childList")for(const d of l.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&n(d)}).observe(document,{childList:!0,subtree:!0});function r(o){const l={};return o.integrity&&(l.integrity=o.integrity),o.referrerPolicy&&(l.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?l.credentials="include":o.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function n(o){if(o.ep)return;o.ep=!0;const l=r(o);fetch(o.href,l)}})();var s;(function(e){e.LOAD="LOAD",e.EXEC="EXEC",e.WRITE_FILE="WRITE_FILE",e.READ_FILE="READ_FILE",e.DELETE_FILE="DELETE_FILE",e.RENAME="RENAME",e.CREATE_DIR="CREATE_DIR",e.LIST_DIR="LIST_DIR",e.DELETE_DIR="DELETE_DIR",e.ERROR="ERROR",e.DOWNLOAD="DOWNLOAD",e.PROGRESS="PROGRESS",e.LOG="LOG"})(s||(s={}));const oe=(()=>{let e=0;return()=>e++})(),ae=new Error("ffmpeg is not loaded, call `await ffmpeg.load()` first"),ie=new Error("called FFmpeg.terminate()");var c,y,E,b,L,S,m;class se{constructor(){g(this,c,null);g(this,y,{});g(this,E,{});g(this,b,[]);g(this,L,[]);u(this,"loaded",!1);g(this,S,()=>{i(this,c)&&(i(this,c).onmessage=({data:{id:t,type:r,data:n}})=>{switch(r){case s.LOAD:this.loaded=!0,i(this,y)[t](n);break;case s.EXEC:case s.WRITE_FILE:case s.READ_FILE:case s.DELETE_FILE:case s.RENAME:case s.CREATE_DIR:case s.LIST_DIR:case s.DELETE_DIR:i(this,y)[t](n);break;case s.LOG:i(this,b).forEach(o=>o(n));break;case s.PROGRESS:i(this,L).forEach(o=>o(n));break;case s.ERROR:i(this,E)[t](n);break}delete i(this,y)[t],delete i(this,E)[t]})});g(this,m,({type:t,data:r},n=[])=>i(this,c)?new Promise((o,l)=>{const d=oe();i(this,c)&&i(this,c).postMessage({id:d,type:t,data:r},n),i(this,y)[d]=o,i(this,E)[d]=l}):Promise.reject(ae));u(this,"load",(t={})=>(i(this,c)||(D(this,c,new Worker(new URL("/dev-sandbox/tools/gifmaker/assets/worker-RjqUVU6j.js",import.meta.url),{type:"module"})),i(this,S).call(this)),i(this,m).call(this,{type:s.LOAD,data:t})));u(this,"exec",(t,r=-1)=>i(this,m).call(this,{type:s.EXEC,data:{args:t,timeout:r}}));u(this,"terminate",()=>{const t=Object.keys(i(this,E));for(const r of t)i(this,E)[r](ie),delete i(this,E)[r],delete i(this,y)[r];i(this,c)&&(i(this,c).terminate(),D(this,c,null),this.loaded=!1)});u(this,"writeFile",(t,r)=>{const n=[];return r instanceof Uint8Array&&n.push(r.buffer),i(this,m).call(this,{type:s.WRITE_FILE,data:{path:t,data:r}},n)});u(this,"readFile",(t,r="binary")=>i(this,m).call(this,{type:s.READ_FILE,data:{path:t,encoding:r}}));u(this,"deleteFile",t=>i(this,m).call(this,{type:s.DELETE_FILE,data:{path:t}}));u(this,"rename",(t,r)=>i(this,m).call(this,{type:s.RENAME,data:{oldPath:t,newPath:r}}));u(this,"createDir",t=>i(this,m).call(this,{type:s.CREATE_DIR,data:{path:t}}));u(this,"listDir",t=>i(this,m).call(this,{type:s.LIST_DIR,data:{path:t}}));u(this,"deleteDir",t=>i(this,m).call(this,{type:s.DELETE_DIR,data:{path:t}}))}on(t,r){t==="log"?i(this,b).push(r):t==="progress"&&i(this,L).push(r)}off(t,r){t==="log"?D(this,b,i(this,b).filter(n=>n!==r)):t==="progress"&&D(this,L,i(this,L).filter(n=>n!==r))}}c=new WeakMap,y=new WeakMap,E=new WeakMap,b=new WeakMap,L=new WeakMap,S=new WeakMap,m=new WeakMap;const C=10*1024*1024,N="/dev-sandbox/tools/gifmaker/ffmpeg/",H=`${N}ffmpeg-core.js`,X=`${N}ffmpeg-core.wasm`,a={width:document.getElementById("width-range"),fps:document.getElementById("fps-range"),quality:document.getElementById("quality-range"),download:document.getElementById("download-link"),convert:document.getElementById("convert-button"),status:document.getElementById("status"),video:document.getElementById("preview-video"),canvas:document.getElementById("working-canvas")},Y=document.getElementById("width-value"),le=document.getElementById("fps-value"),de=document.getElementById("quality-value"),R=document.getElementById("dropzone"),ce=document.getElementById("file-input");let M=null,v=null,w=null,_=null;const p=[],J=({progress:e})=>{const t=Number.isFinite(e)?e:0;f(`FFmpeg 変換中... ${(t*100).toFixed(1)}%`)},Q=e=>{p.push(e),p.length>200&&p.shift()},k=()=>{if(w)try{w.off("progress",J),w.off("log",Q),w.terminate()}catch(e){console.warn("FFmpeg terminate error:",e)}finally{w=null}},fe=async()=>{if(!w){if(_){await _;return}_=(async()=>{f("FFmpeg モジュールを読み込んでいます...");const e=new se;e.on("progress",J),e.on("log",Q),console.info("[gifmaker] loading ffmpeg",{coreURL:H,wasmURL:X});const t={coreURL:H,wasmURL:X};typeof SharedArrayBuffer<"u"&&!!(window!=null&&window.crossOriginIsolated)&&(t.workerURL=`${N}ffmpeg-core.worker.js`),await e.load(t),console.info("[gifmaker] ffmpeg loaded"),w=e})();try{await _}catch(e){throw k(),e}finally{_=null}}},T=()=>{Y.textContent=`${a.width.value}px`,le.textContent=`${a.fps.value}fps`,de.textContent=`${a.quality.value}/8`};T();const f=(e,t=!1)=>{a.status.textContent=e,a.status.dataset.state=t?"error":"normal"},ue=async e=>{if(e instanceof Uint8Array)return e;if(typeof e=="string")return new TextEncoder().encode(e);if(e instanceof Blob){const t=await e.arrayBuffer();return new Uint8Array(t)}if(e instanceof ArrayBuffer)return new Uint8Array(e);if(ArrayBuffer.isView(e))return new Uint8Array(e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength));throw new Error("入力データを Uint8Array に変換できませんでした。")},Z=()=>{a.video.removeAttribute("src"),a.video.load(),a.convert.disabled=!0,a.download.setAttribute("aria-disabled","true"),a.download.removeAttribute("href"),f("動画ファイルを読み込んでください。")},ee=e=>{if(!e.type.startsWith("video/")){f("対応していないファイル形式です。動画ファイルを選択してください。",!0);return}M=e,v&&(URL.revokeObjectURL(v),v=null),v=URL.createObjectURL(e),a.video.src=v,a.video.onloadedmetadata=()=>{a.video.currentTime=0,a.convert.disabled=!1;const t=Math.min(960,Math.round(a.video.videoWidth));a.width.max=String(Math.max(160,t)),a.width.value=String(Math.min(t,Number(a.width.value))),Y.textContent=`${a.width.value}px`,f("動画が読み込まれました。設定を調整して「GIF を作成」を押してください。")},a.video.onerror=()=>{f("動画の読み込みに失敗しました。",!0),Z()}},me=e=>{if(!e)return null;if(e.files&&e.files.length>0)return e.files[0]??null;if(e.items){for(const t of Array.from(e.items))if(t.kind==="file"){const r=t.getAsFile();if(r)return r}}return null},he=e=>{e.preventDefault(),R.classList.remove("drag-over");const t=me(e.dataTransfer??null);t?ee(t):f("ファイルをドロップしてください。フォルダは利用できません。",!0)},Ee=(e,t,r)=>{const n=["none","floyd_steinberg","sierra2","sierra2_4a","bayer:bayer_scale=5:diffusion=1","bayer:bayer_scale=4:diffusion=1","bayer:bayer_scale=3:diffusion=1","bayer:bayer_scale=2:diffusion=1"],o=Math.min(n.length-1,Math.max(0,Math.round(r)-1)),l=n[o];return`fps=${e},scale=${t}:-2:flags=lanczos,split[a][b];[a]palettegen=stats_mode=full[p];[b][p]paletteuse=dither=${l}`},ge=async(e,t,r)=>{await fe();const n=w;if(!n)throw new Error("FFmpeg の初期化に失敗しました。");const l=Math.max(160,Math.round(t.width)),d=l%2===0?l:l+1,I=Math.max(1,Math.round(t.fps)),A=Math.max(1,Math.round(t.quality)),x=`input-${Date.now()}.mp4`,B=`output-${Date.now()}.gif`;let W=!1;const P=()=>{W=!0,k()};r.addEventListener("abort",P,{once:!0});try{f("FFmpeg で GIF を生成しています..."),p.length=0;const h=await ue(e);console.info("[gifmaker] writeFile",{inputName:x,byteLength:h.byteLength}),await n.writeFile(x,h);const te=Ee(I,d,A),q=["-i",x,"-vf",te,"-loop","0",B];console.info("[gifmaker] exec",{args:q});const z=await n.exec(q);if(z!==0)throw new Error(`FFmpeg の実行に失敗しました (コード: ${z})。`);const F=await n.readFile(B),j=F instanceof Uint8Array?F:new TextEncoder().encode(typeof F=="string"?F:String(F)),U=new Uint8Array(j.byteLength);return U.set(j),console.info("[gifmaker] readFile",{outputName:B,size:U.byteLength}),new Blob([U.buffer],{type:"image/gif"})}catch(h){throw W?new Error("処理が中断されました。"):(console.error("[gifmaker] ffmpeg error",h),p.length>0&&console.error("[gifmaker] ffmpeg logs",p),k(),h)}finally{if(r.removeEventListener("abort",P),n.loaded){try{await n.deleteFile(x)}catch(h){console.warn("Failed to remove input from FFmpeg FS",h)}try{await n.deleteFile(B)}catch(h){console.warn("Failed to remove output from FFmpeg FS",h)}}}},we=async(e,t,r)=>{let n=Math.max(160,Math.round(t.width)),o=Math.max(1,Math.round(t.fps));const l=Math.max(1,Math.round(t.quality));let d=0,I=null;for(;n>=160&&o>=5;){d+=1,f(`変換中... (試行 ${d})`);const A=await ge(e,{width:n,fps:o,quality:l},r);if(A.size<=C)return{blob:A,width:n,fps:o,iterations:d};if(I=A,n>320){n=Math.max(160,Math.floor(n*.85));continue}o=Math.max(5,o-2)}if(I)return{blob:I,width:n,fps:o,iterations:d};throw new Error("出力サイズを 10MB 以下に抑えられませんでした。設定を見直してください。")};let O=null;a.convert.addEventListener("click",async()=>{if(!M||!v)return;O&&O.abort();const e=new AbortController;O=e,a.convert.disabled=!0,a.download.setAttribute("aria-disabled","true"),a.download.removeAttribute("href"),f("変換を開始しました...");try{a.video.pause(),a.video.currentTime=0,await pe(a.video);const t={width:$(a.width.value,a.video.videoWidth||480,160,960),fps:$(a.fps.value,12,1,60),quality:$(a.quality.value,6,1,8)},r=await we(M,t,e.signal),n=URL.createObjectURL(r.blob);a.download.href=n,a.download.download=`${M.name.replace(/\.[^.]+$/,"")||"output"}.gif`,a.download.setAttribute("aria-disabled","false"),f(r.blob.size<=C?`変換が完了しました！ (${K(r.blob.size)})`:`変換は完了しましたが 10MB を超えています (${K(r.blob.size)})。解像度やフレームレートを下げて再試行してください。`,r.blob.size>C)}catch(t){console.error(t);let r=t instanceof Error?t.message:"変換中にエラーが発生しました。";for(let n=p.length-1;n>=0;n-=1){const o=p[n];if(o.type==="stderr"&&o.message.trim()){r=`${r} 詳細: ${o.message.trim()}`;break}}f(r,!0)}finally{O===e&&(O=null),a.convert.disabled=!1}});ce.addEventListener("change",e=>{var r;const t=e.target;(r=t.files)!=null&&r.length&&ee(t.files[0])});R.addEventListener("dragover",e=>{e.preventDefault(),R.classList.add("drag-over")});R.addEventListener("dragleave",()=>{R.classList.remove("drag-over")});R.addEventListener("drop",he);a.width.addEventListener("input",T);a.fps.addEventListener("input",T);a.quality.addEventListener("input",T);a.download.addEventListener("click",()=>{a.download.getAttribute("aria-disabled")!=="true"&&f("GIF をダウンロードしています...")});const K=e=>e<1024?`${e}B`:e<1024*1024?`${(e/1024).toFixed(1)}KB`:`${(e/(1024*1024)).toFixed(2)}MB`,$=(e,t,r=0,n=Number.POSITIVE_INFINITY)=>{const o=Number.parseFloat(e);return Number.isFinite(o)?Math.min(Math.max(o,r),n):t};Z();const ye=(e,t)=>new Promise(r=>{const n=o=>{e.removeEventListener(t,n),r(o)};e.addEventListener(t,n,{once:!0})}),pe=async e=>{if(e.readyState<HTMLMediaElement.HAVE_METADATA&&await ye(e,"loadedmetadata"),(e.videoWidth===0||e.videoHeight===0)&&await new Promise(t=>requestAnimationFrame(t)),e.videoWidth===0||e.videoHeight===0)throw new Error("動画のメタデータを取得できませんでした。別のファイルでお試しください。");if(!Number.isFinite(e.duration)||e.duration<=0)throw new Error("動画の長さが不正です。")};
