var ne=Object.defineProperty;var G=e=>{throw TypeError(e)};var oe=(e,t,r)=>t in e?ne(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var u=(e,t,r)=>oe(e,typeof t!="symbol"?t+"":t,r),V=(e,t,r)=>t.has(e)||G("Cannot "+r);var a=(e,t,r)=>(V(e,t,"read from private field"),r?r.call(e):t.get(e)),g=(e,t,r)=>t.has(e)?G("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,r),D=(e,t,r,n)=>(V(e,t,"write to private field"),n?n.call(e,r):t.set(e,r),r);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const l of o)if(l.type==="childList")for(const d of l.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&n(d)}).observe(document,{childList:!0,subtree:!0});function r(o){const l={};return o.integrity&&(l.integrity=o.integrity),o.referrerPolicy&&(l.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?l.credentials="include":o.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function n(o){if(o.ep)return;o.ep=!0;const l=r(o);fetch(o.href,l)}})();var s;(function(e){e.LOAD="LOAD",e.EXEC="EXEC",e.WRITE_FILE="WRITE_FILE",e.READ_FILE="READ_FILE",e.DELETE_FILE="DELETE_FILE",e.RENAME="RENAME",e.CREATE_DIR="CREATE_DIR",e.LIST_DIR="LIST_DIR",e.DELETE_DIR="DELETE_DIR",e.ERROR="ERROR",e.DOWNLOAD="DOWNLOAD",e.PROGRESS="PROGRESS",e.LOG="LOG"})(s||(s={}));const ie=(()=>{let e=0;return()=>e++})(),ae=new Error("ffmpeg is not loaded, call `await ffmpeg.load()` first"),se=new Error("called FFmpeg.terminate()");var c,p,E,b,L,B,m;class le{constructor(){g(this,c,null);g(this,p,{});g(this,E,{});g(this,b,[]);g(this,L,[]);u(this,"loaded",!1);g(this,B,()=>{a(this,c)&&(a(this,c).onmessage=({data:{id:t,type:r,data:n}})=>{switch(r){case s.LOAD:this.loaded=!0,a(this,p)[t](n);break;case s.EXEC:case s.WRITE_FILE:case s.READ_FILE:case s.DELETE_FILE:case s.RENAME:case s.CREATE_DIR:case s.LIST_DIR:case s.DELETE_DIR:a(this,p)[t](n);break;case s.LOG:a(this,b).forEach(o=>o(n));break;case s.PROGRESS:a(this,L).forEach(o=>o(n));break;case s.ERROR:a(this,E)[t](n);break}delete a(this,p)[t],delete a(this,E)[t]})});g(this,m,({type:t,data:r},n=[])=>a(this,c)?new Promise((o,l)=>{const d=ie();a(this,c)&&a(this,c).postMessage({id:d,type:t,data:r},n),a(this,p)[d]=o,a(this,E)[d]=l}):Promise.reject(ae));u(this,"load",(t={})=>(a(this,c)||(D(this,c,new Worker(new URL("/dev-sandbox/tools/gifmaker/assets/worker-RjqUVU6j.js",import.meta.url),{type:"module"})),a(this,B).call(this)),a(this,m).call(this,{type:s.LOAD,data:t})));u(this,"exec",(t,r=-1)=>a(this,m).call(this,{type:s.EXEC,data:{args:t,timeout:r}}));u(this,"terminate",()=>{const t=Object.keys(a(this,E));for(const r of t)a(this,E)[r](se),delete a(this,E)[r],delete a(this,p)[r];a(this,c)&&(a(this,c).terminate(),D(this,c,null),this.loaded=!1)});u(this,"writeFile",(t,r)=>{const n=[];return r instanceof Uint8Array&&n.push(r.buffer),a(this,m).call(this,{type:s.WRITE_FILE,data:{path:t,data:r}},n)});u(this,"readFile",(t,r="binary")=>a(this,m).call(this,{type:s.READ_FILE,data:{path:t,encoding:r}}));u(this,"deleteFile",t=>a(this,m).call(this,{type:s.DELETE_FILE,data:{path:t}}));u(this,"rename",(t,r)=>a(this,m).call(this,{type:s.RENAME,data:{oldPath:t,newPath:r}}));u(this,"createDir",t=>a(this,m).call(this,{type:s.CREATE_DIR,data:{path:t}}));u(this,"listDir",t=>a(this,m).call(this,{type:s.LIST_DIR,data:{path:t}}));u(this,"deleteDir",t=>a(this,m).call(this,{type:s.DELETE_DIR,data:{path:t}}))}on(t,r){t==="log"?a(this,b).push(r):t==="progress"&&a(this,L).push(r)}off(t,r){t==="log"?D(this,b,a(this,b).filter(n=>n!==r)):t==="progress"&&D(this,L,a(this,L).filter(n=>n!==r))}}c=new WeakMap,p=new WeakMap,E=new WeakMap,b=new WeakMap,L=new WeakMap,B=new WeakMap,m=new WeakMap;const k=10*1024*1024,N="/dev-sandbox/tools/gifmaker/ffmpeg/",H=`${N}ffmpeg-core.js`,X=`${N}ffmpeg-core.wasm`,K=`${N}ffmpeg-core.worker.js`,i={width:document.getElementById("width-range"),fps:document.getElementById("fps-range"),quality:document.getElementById("quality-range"),download:document.getElementById("download-link"),convert:document.getElementById("convert-button"),status:document.getElementById("status"),video:document.getElementById("preview-video"),canvas:document.getElementById("working-canvas")},J=document.getElementById("width-value"),de=document.getElementById("fps-value"),ce=document.getElementById("quality-value"),v=document.getElementById("dropzone"),fe=document.getElementById("file-input");let U=null,R=null,w=null,_=null;const y=[],Q=({progress:e})=>{const t=Number.isFinite(e)?e:0;f(`FFmpeg 変換中... ${(t*100).toFixed(1)}%`)},Z=e=>{y.push(e),y.length>200&&y.shift()},C=()=>{if(w)try{w.off("progress",Q),w.off("log",Z),w.terminate()}catch(e){console.warn("FFmpeg terminate error:",e)}finally{w=null}},ue=async()=>{if(!w){if(_){await _;return}_=(async()=>{f("FFmpeg モジュールを読み込んでいます...");const e=new le;e.on("progress",Q),e.on("log",Z),console.info("[gifmaker] loading ffmpeg",{coreURL:H,wasmURL:X,workerURL:K}),await e.load({coreURL:H,wasmURL:X,workerURL:K}),console.info("[gifmaker] ffmpeg loaded"),w=e})();try{await _}catch(e){throw C(),e}finally{_=null}}},S=()=>{J.textContent=`${i.width.value}px`,de.textContent=`${i.fps.value}fps`,ce.textContent=`${i.quality.value}/8`};S();const f=(e,t=!1)=>{i.status.textContent=e,i.status.dataset.state=t?"error":"normal"},me=async e=>{if(e instanceof Uint8Array)return e;if(typeof e=="string")return new TextEncoder().encode(e);if(e instanceof Blob){const t=await e.arrayBuffer();return new Uint8Array(t)}if(e instanceof ArrayBuffer)return new Uint8Array(e);if(ArrayBuffer.isView(e))return new Uint8Array(e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength));throw new Error("入力データを Uint8Array に変換できませんでした。")},ee=()=>{i.video.removeAttribute("src"),i.video.load(),i.convert.disabled=!0,i.download.setAttribute("aria-disabled","true"),i.download.removeAttribute("href"),f("動画ファイルを読み込んでください。")},te=e=>{if(!e.type.startsWith("video/")){f("対応していないファイル形式です。動画ファイルを選択してください。",!0);return}U=e,R&&(URL.revokeObjectURL(R),R=null),R=URL.createObjectURL(e),i.video.src=R,i.video.onloadedmetadata=()=>{i.video.currentTime=0,i.convert.disabled=!1;const t=Math.min(960,Math.round(i.video.videoWidth));i.width.max=String(Math.max(160,t)),i.width.value=String(Math.min(t,Number(i.width.value))),J.textContent=`${i.width.value}px`,f("動画が読み込まれました。設定を調整して「GIF を作成」を押してください。")},i.video.onerror=()=>{f("動画の読み込みに失敗しました。",!0),ee()}},he=e=>{if(!e)return null;if(e.files&&e.files.length>0)return e.files[0]??null;if(e.items){for(const t of Array.from(e.items))if(t.kind==="file"){const r=t.getAsFile();if(r)return r}}return null},Ee=e=>{e.preventDefault(),v.classList.remove("drag-over");const t=he(e.dataTransfer??null);t?te(t):f("ファイルをドロップしてください。フォルダは利用できません。",!0)},ge=(e,t,r)=>{const n=["none","floyd_steinberg","sierra2","sierra2_4a","bayer:bayer_scale=5:diffusion=1","bayer:bayer_scale=4:diffusion=1","bayer:bayer_scale=3:diffusion=1","bayer:bayer_scale=2:diffusion=1"],o=Math.min(n.length-1,Math.max(0,Math.round(r)-1)),l=n[o];return`fps=${e},scale=${t}:-2:flags=lanczos,split[a][b];[a]palettegen=stats_mode=full[p];[b][p]paletteuse=dither=${l}`},we=async(e,t,r)=>{await ue();const n=w;if(!n)throw new Error("FFmpeg の初期化に失敗しました。");const l=Math.max(160,Math.round(t.width)),d=l%2===0?l:l+1,I=Math.max(1,Math.round(t.fps)),A=Math.max(1,Math.round(t.quality)),x=`input-${Date.now()}.mp4`,M=`output-${Date.now()}.gif`;let W=!1;const P=()=>{W=!0,C()};r.addEventListener("abort",P,{once:!0});try{f("FFmpeg で GIF を生成しています..."),y.length=0;const h=await me(e);console.info("[gifmaker] writeFile",{inputName:x,byteLength:h.byteLength}),await n.writeFile(x,h);const re=ge(I,d,A),q=["-i",x,"-vf",re,"-loop","0",M];console.info("[gifmaker] exec",{args:q});const z=await n.exec(q);if(z!==0)throw new Error(`FFmpeg の実行に失敗しました (コード: ${z})。`);const F=await n.readFile(M),j=F instanceof Uint8Array?F:new TextEncoder().encode(typeof F=="string"?F:String(F)),T=new Uint8Array(j.byteLength);return T.set(j),console.info("[gifmaker] readFile",{outputName:M,size:T.byteLength}),new Blob([T.buffer],{type:"image/gif"})}catch(h){throw W?new Error("処理が中断されました。"):(console.error("[gifmaker] ffmpeg error",h),y.length>0&&console.error("[gifmaker] ffmpeg logs",y),C(),h)}finally{if(r.removeEventListener("abort",P),n.loaded){try{await n.deleteFile(x)}catch(h){console.warn("Failed to remove input from FFmpeg FS",h)}try{await n.deleteFile(M)}catch(h){console.warn("Failed to remove output from FFmpeg FS",h)}}}},pe=async(e,t,r)=>{let n=Math.max(160,Math.round(t.width)),o=Math.max(1,Math.round(t.fps));const l=Math.max(1,Math.round(t.quality));let d=0,I=null;for(;n>=160&&o>=5;){d+=1,f(`変換中... (試行 ${d})`);const A=await we(e,{width:n,fps:o,quality:l},r);if(A.size<=k)return{blob:A,width:n,fps:o,iterations:d};if(I=A,n>320){n=Math.max(160,Math.floor(n*.85));continue}o=Math.max(5,o-2)}if(I)return{blob:I,width:n,fps:o,iterations:d};throw new Error("出力サイズを 10MB 以下に抑えられませんでした。設定を見直してください。")};let O=null;i.convert.addEventListener("click",async()=>{if(!U||!R)return;O&&O.abort();const e=new AbortController;O=e,i.convert.disabled=!0,i.download.setAttribute("aria-disabled","true"),i.download.removeAttribute("href"),f("変換を開始しました...");try{i.video.pause(),i.video.currentTime=0,await be(i.video);const t={width:$(i.width.value,i.video.videoWidth||480,160,960),fps:$(i.fps.value,12,1,60),quality:$(i.quality.value,6,1,8)},r=await pe(U,t,e.signal),n=URL.createObjectURL(r.blob);i.download.href=n,i.download.download=`${U.name.replace(/\.[^.]+$/,"")||"output"}.gif`,i.download.setAttribute("aria-disabled","false"),f(r.blob.size<=k?`変換が完了しました！ (${Y(r.blob.size)})`:`変換は完了しましたが 10MB を超えています (${Y(r.blob.size)})。解像度やフレームレートを下げて再試行してください。`,r.blob.size>k)}catch(t){console.error(t);let r=t instanceof Error?t.message:"変換中にエラーが発生しました。";for(let n=y.length-1;n>=0;n-=1){const o=y[n];if(o.type==="stderr"&&o.message.trim()){r=`${r} 詳細: ${o.message.trim()}`;break}}f(r,!0)}finally{O===e&&(O=null),i.convert.disabled=!1}});fe.addEventListener("change",e=>{var r;const t=e.target;(r=t.files)!=null&&r.length&&te(t.files[0])});v.addEventListener("dragover",e=>{e.preventDefault(),v.classList.add("drag-over")});v.addEventListener("dragleave",()=>{v.classList.remove("drag-over")});v.addEventListener("drop",Ee);i.width.addEventListener("input",S);i.fps.addEventListener("input",S);i.quality.addEventListener("input",S);i.download.addEventListener("click",()=>{i.download.getAttribute("aria-disabled")!=="true"&&f("GIF をダウンロードしています...")});const Y=e=>e<1024?`${e}B`:e<1024*1024?`${(e/1024).toFixed(1)}KB`:`${(e/(1024*1024)).toFixed(2)}MB`,$=(e,t,r=0,n=Number.POSITIVE_INFINITY)=>{const o=Number.parseFloat(e);return Number.isFinite(o)?Math.min(Math.max(o,r),n):t};ee();const ye=(e,t)=>new Promise(r=>{const n=o=>{e.removeEventListener(t,n),r(o)};e.addEventListener(t,n,{once:!0})}),be=async e=>{if(e.readyState<HTMLMediaElement.HAVE_METADATA&&await ye(e,"loadedmetadata"),(e.videoWidth===0||e.videoHeight===0)&&await new Promise(t=>requestAnimationFrame(t)),e.videoWidth===0||e.videoHeight===0)throw new Error("動画のメタデータを取得できませんでした。別のファイルでお試しください。");if(!Number.isFinite(e.duration)||e.duration<=0)throw new Error("動画の長さが不正です。")};
