var re=Object.defineProperty;var V=e=>{throw TypeError(e)};var ne=(e,t,r)=>t in e?re(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var m=(e,t,r)=>ne(e,typeof t!="symbol"?t+"":t,r),H=(e,t,r)=>t.has(e)||V("Cannot "+r);var a=(e,t,r)=>(H(e,t,"read from private field"),r?r.call(e):t.get(e)),w=(e,t,r)=>t.has(e)?V("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,r),M=(e,t,r,n)=>(H(e,t,"write to private field"),n?n.call(e,r):t.set(e,r),r);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const l of o)if(l.type==="childList")for(const d of l.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&n(d)}).observe(document,{childList:!0,subtree:!0});function r(o){const l={};return o.integrity&&(l.integrity=o.integrity),o.referrerPolicy&&(l.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?l.credentials="include":o.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function n(o){if(o.ep)return;o.ep=!0;const l=r(o);fetch(o.href,l)}})();var s;(function(e){e.LOAD="LOAD",e.EXEC="EXEC",e.WRITE_FILE="WRITE_FILE",e.READ_FILE="READ_FILE",e.DELETE_FILE="DELETE_FILE",e.RENAME="RENAME",e.CREATE_DIR="CREATE_DIR",e.LIST_DIR="LIST_DIR",e.DELETE_DIR="DELETE_DIR",e.ERROR="ERROR",e.DOWNLOAD="DOWNLOAD",e.PROGRESS="PROGRESS",e.LOG="LOG"})(s||(s={}));const oe=(()=>{let e=0;return()=>e++})(),ie=new Error("ffmpeg is not loaded, call `await ffmpeg.load()` first"),ae=new Error("called FFmpeg.terminate()");var c,p,g,A,F,k,h;class se{constructor(){w(this,c,null);w(this,p,{});w(this,g,{});w(this,A,[]);w(this,F,[]);m(this,"loaded",!1);w(this,k,()=>{a(this,c)&&(a(this,c).onmessage=({data:{id:t,type:r,data:n}})=>{switch(r){case s.LOAD:this.loaded=!0,a(this,p)[t](n);break;case s.EXEC:case s.WRITE_FILE:case s.READ_FILE:case s.DELETE_FILE:case s.RENAME:case s.CREATE_DIR:case s.LIST_DIR:case s.DELETE_DIR:a(this,p)[t](n);break;case s.LOG:a(this,A).forEach(o=>o(n));break;case s.PROGRESS:a(this,F).forEach(o=>o(n));break;case s.ERROR:a(this,g)[t](n);break}delete a(this,p)[t],delete a(this,g)[t]})});w(this,h,({type:t,data:r},n=[])=>a(this,c)?new Promise((o,l)=>{const d=oe();a(this,c)&&a(this,c).postMessage({id:d,type:t,data:r},n),a(this,p)[d]=o,a(this,g)[d]=l}):Promise.reject(ie));m(this,"load",(t={})=>(a(this,c)||(M(this,c,new Worker(new URL("/dev-sandbox/tools/gifmaker/assets/worker-RjqUVU6j.js",import.meta.url),{type:"module"})),a(this,k).call(this)),a(this,h).call(this,{type:s.LOAD,data:t})));m(this,"exec",(t,r=-1)=>a(this,h).call(this,{type:s.EXEC,data:{args:t,timeout:r}}));m(this,"terminate",()=>{const t=Object.keys(a(this,g));for(const r of t)a(this,g)[r](ae),delete a(this,g)[r],delete a(this,p)[r];a(this,c)&&(a(this,c).terminate(),M(this,c,null),this.loaded=!1)});m(this,"writeFile",(t,r)=>{const n=[];return r instanceof Uint8Array&&n.push(r.buffer),a(this,h).call(this,{type:s.WRITE_FILE,data:{path:t,data:r}},n)});m(this,"readFile",(t,r="binary")=>a(this,h).call(this,{type:s.READ_FILE,data:{path:t,encoding:r}}));m(this,"deleteFile",t=>a(this,h).call(this,{type:s.DELETE_FILE,data:{path:t}}));m(this,"rename",(t,r)=>a(this,h).call(this,{type:s.RENAME,data:{oldPath:t,newPath:r}}));m(this,"createDir",t=>a(this,h).call(this,{type:s.CREATE_DIR,data:{path:t}}));m(this,"listDir",t=>a(this,h).call(this,{type:s.LIST_DIR,data:{path:t}}));m(this,"deleteDir",t=>a(this,h).call(this,{type:s.DELETE_DIR,data:{path:t}}))}on(t,r){t==="log"?a(this,A).push(r):t==="progress"&&a(this,F).push(r)}off(t,r){t==="log"?M(this,A,a(this,A).filter(n=>n!==r)):t==="progress"&&M(this,F,a(this,F).filter(n=>n!==r))}}c=new WeakMap,p=new WeakMap,g=new WeakMap,A=new WeakMap,F=new WeakMap,k=new WeakMap,h=new WeakMap;const P=10*1024*1024,z="/dev-sandbox/tools/gifmaker/ffmpeg/",X=`${z}ffmpeg-core.js`,K=`${z}ffmpeg-core.wasm`,le=`${z}ffmpeg-core.worker.js`,i={width:document.getElementById("width-range"),fps:document.getElementById("fps-range"),quality:document.getElementById("quality-range"),download:document.getElementById("download-link"),convert:document.getElementById("convert-button"),status:document.getElementById("status"),video:document.getElementById("preview-video"),canvas:document.getElementById("working-canvas")},J=document.getElementById("width-value"),de=document.getElementById("fps-value"),ce=document.getElementById("quality-value"),_=document.getElementById("dropzone"),fe=document.getElementById("file-input");let U=null,D=null,y=null,S=null;const b=[],Q=({progress:e})=>{const t=Number.isFinite(e)?e:0;f(`FFmpeg 変換中... ${(t*100).toFixed(1)}%`)},Z=e=>{b.push(e),b.length>200&&b.shift()},q=()=>{if(y)try{y.off("progress",Q),y.off("log",Z),y.terminate()}catch(e){console.warn("FFmpeg terminate error:",e)}finally{y=null}},ue=async()=>{if(!y){if(S){await S;return}S=(async()=>{f("FFmpeg モジュールを読み込んでいます...");const e=new se;e.on("progress",Q),e.on("log",Z),console.info("[gifmaker] loading ffmpeg",{coreURL:X,wasmURL:K});const t={coreURL:X,wasmURL:K};t.workerURL=le,await e.load(t),console.info("[gifmaker] ffmpeg loaded"),y=e})();try{await S}catch(e){throw q(),e}finally{S=null}}},$=()=>{J.textContent=`${i.width.value}px`,de.textContent=`${i.fps.value}fps`,ce.textContent=`${i.quality.value}/8`};$();const f=(e,t=!1)=>{i.status.textContent=e,i.status.dataset.state=t?"error":"normal"},me=async e=>{if(e instanceof Uint8Array)return e;if(typeof e=="string")return new TextEncoder().encode(e);if(e instanceof Blob){const t=await e.arrayBuffer();return new Uint8Array(t)}if(e instanceof ArrayBuffer)return new Uint8Array(e);if(ArrayBuffer.isView(e))return new Uint8Array(e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength));throw new Error("入力データを Uint8Array に変換できませんでした。")},ee=()=>{i.video.removeAttribute("src"),i.video.load(),i.convert.disabled=!0,i.download.setAttribute("aria-disabled","true"),i.download.removeAttribute("href"),f("動画ファイルを読み込んでください。")},te=e=>{if(!e.type.startsWith("video/")){f("対応していないファイル形式です。動画ファイルを選択してください。",!0);return}U=e,D&&(URL.revokeObjectURL(D),D=null),D=URL.createObjectURL(e),i.video.src=D,i.video.onloadedmetadata=()=>{i.video.currentTime=0,i.convert.disabled=!1;const t=Math.min(960,Math.round(i.video.videoWidth));i.width.max=String(Math.max(160,t)),i.width.value=String(Math.min(t,Number(i.width.value))),J.textContent=`${i.width.value}px`,f("動画が読み込まれました。設定を調整して「GIF を作成」を押してください。")},i.video.onerror=()=>{f("動画の読み込みに失敗しました。",!0),ee()}},he=e=>{if(!e)return null;if(e.files&&e.files.length>0)return e.files[0]??null;if(e.items){for(const t of Array.from(e.items))if(t.kind==="file"){const r=t.getAsFile();if(r)return r}}return null},Ee=e=>{e.preventDefault(),_.classList.remove("drag-over");const t=he(e.dataTransfer??null);t?te(t):f("ファイルをドロップしてください。フォルダは利用できません。",!0)},ge=(e,t,r)=>{const n=["none","floyd_steinberg","sierra2","sierra2_4a","bayer:bayer_scale=5:diffusion=1","bayer:bayer_scale=4:diffusion=1","bayer:bayer_scale=3:diffusion=1","bayer:bayer_scale=2:diffusion=1"],o=Math.min(n.length-1,Math.max(0,Math.round(r)-1)),l=n[o];return`fps=${e},scale=${t}:-2:flags=lanczos,split[a][b];[a]palettegen=stats_mode=full[p];[b][p]paletteuse=dither=${l}`},we=async(e,t,r)=>{await ue();const n=y;if(!n)throw new Error("FFmpeg の初期化に失敗しました。");const l=Math.max(160,Math.round(t.width)),d=l%2===0?l:l+1,O=Math.max(1,Math.round(t.fps)),L=Math.max(1,Math.round(t.quality)),R=`input-${Date.now()}.mp4`,v=`output-${Date.now()}.gif`;let I=!1;const E=()=>{I=!0,q()};r.addEventListener("abort",E,{once:!0});try{f("FFmpeg で GIF を生成しています..."),b.length=0;const u=await me(e);console.info("[gifmaker] writeFile",{inputName:R,byteLength:u.byteLength}),await n.writeFile(R,u);const j=ge(O,d,L),C=["-i",R,"-vf",j,"-loop","0",v];console.info("[gifmaker] exec",{args:C});const T=await n.exec(C);if(T!==0)throw new Error(`FFmpeg の実行に失敗しました (コード: ${T})。`);const x=await n.readFile(v),G=x instanceof Uint8Array?x:new TextEncoder().encode(typeof x=="string"?x:String(x)),N=new Uint8Array(G.byteLength);return N.set(G),console.info("[gifmaker] readFile",{outputName:v,size:N.byteLength}),new Blob([N.buffer],{type:"image/gif"})}catch(u){throw I?new Error("処理が中断されました。"):(console.error("[gifmaker] ffmpeg error",u),b.length>0&&console.error("[gifmaker] ffmpeg logs",b),q(),u)}finally{if(r.removeEventListener("abort",E),n.loaded){try{await n.deleteFile(R)}catch(u){console.warn("Failed to remove input from FFmpeg FS",u)}try{await n.deleteFile(v)}catch(u){console.warn("Failed to remove output from FFmpeg FS",u)}}}},ye=async(e,t,r)=>{let n=Math.max(160,Math.round(t.width)),o=Math.max(1,Math.round(t.fps));const l=Math.max(1,Math.round(t.quality));let d=0,O=null,L=null;const R=()=>n>320?(n=Math.max(160,Math.floor(n*.85)),!0):!1,v=()=>o>5?(o=Math.max(5,o-2),!0):!1;for(;n>=160&&o>=5;){d+=1,f(`変換中... (試行 ${d})`);let I;try{I=await we(e,{width:n,fps:o,quality:l},r)}catch(E){if(L=E,r.aborted)throw E;const u=E instanceof Error?E.message:String(E);if((u.includes("FFmpeg の実行に失敗しました")||u.includes("Aborted"))&&(R()||v())){console.warn("[gifmaker] retrying with reduced settings",{width:n,fps:o}),await new Promise(T=>setTimeout(T,0));continue}throw E}if(I.size<=P)return{blob:I,width:n,fps:o,iterations:d};if(O=I,!R()&&!v())break}if(O)return{blob:O,width:n,fps:o,iterations:d};throw L?L instanceof Error?L:new Error(String(L)):new Error("出力サイズを 10MB 以下に抑えられませんでした。設定を見直してください。")};let B=null;i.convert.addEventListener("click",async()=>{if(!U||!D)return;B&&B.abort();const e=new AbortController;B=e,i.convert.disabled=!0,i.download.setAttribute("aria-disabled","true"),i.download.removeAttribute("href"),f("変換を開始しました...");try{i.video.pause(),i.video.currentTime=0,await be(i.video);const t={width:W(i.width.value,i.video.videoWidth||480,160,960),fps:W(i.fps.value,12,1,60),quality:W(i.quality.value,6,1,8)},r=await ye(U,t,e.signal),n=URL.createObjectURL(r.blob);i.download.href=n,i.download.download=`${U.name.replace(/\.[^.]+$/,"")||"output"}.gif`,i.download.setAttribute("aria-disabled","false"),f(r.blob.size<=P?`変換が完了しました！ (${Y(r.blob.size)})`:`変換は完了しましたが 10MB を超えています (${Y(r.blob.size)})。解像度やフレームレートを下げて再試行してください。`,r.blob.size>P)}catch(t){console.error(t);let r=t instanceof Error?t.message:"変換中にエラーが発生しました。";for(let n=b.length-1;n>=0;n-=1){const o=b[n];if(o.type==="stderr"&&o.message.trim()){r=`${r} 詳細: ${o.message.trim()}`;break}}f(r,!0)}finally{B===e&&(B=null),i.convert.disabled=!1}});fe.addEventListener("change",e=>{var r;const t=e.target;(r=t.files)!=null&&r.length&&te(t.files[0])});_.addEventListener("dragover",e=>{e.preventDefault(),_.classList.add("drag-over")});_.addEventListener("dragleave",()=>{_.classList.remove("drag-over")});_.addEventListener("drop",Ee);i.width.addEventListener("input",$);i.fps.addEventListener("input",$);i.quality.addEventListener("input",$);i.download.addEventListener("click",()=>{i.download.getAttribute("aria-disabled")!=="true"&&f("GIF をダウンロードしています...")});const Y=e=>e<1024?`${e}B`:e<1024*1024?`${(e/1024).toFixed(1)}KB`:`${(e/(1024*1024)).toFixed(2)}MB`,W=(e,t,r=0,n=Number.POSITIVE_INFINITY)=>{const o=Number.parseFloat(e);return Number.isFinite(o)?Math.min(Math.max(o,r),n):t};ee();const pe=(e,t)=>new Promise(r=>{const n=o=>{e.removeEventListener(t,n),r(o)};e.addEventListener(t,n,{once:!0})}),be=async e=>{if(e.readyState<HTMLMediaElement.HAVE_METADATA&&await pe(e,"loadedmetadata"),(e.videoWidth===0||e.videoHeight===0)&&await new Promise(t=>requestAnimationFrame(t)),e.videoWidth===0||e.videoHeight===0)throw new Error("動画のメタデータを取得できませんでした。別のファイルでお試しください。");if(!Number.isFinite(e.duration)||e.duration<=0)throw new Error("動画の長さが不正です。")};
