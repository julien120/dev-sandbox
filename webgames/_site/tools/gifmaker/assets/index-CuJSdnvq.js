(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const l of a.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&o(l)}).observe(document,{childList:!0,subtree:!0});function i(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(n){if(n.ep)return;n.ep=!0;const a=i(n);fetch(n.href,a)}})();const E=10*1024*1024,r={width:document.getElementById("width-range"),fps:document.getElementById("fps-range"),quality:document.getElementById("quality-range"),download:document.getElementById("download-link"),convert:document.getElementById("convert-button"),status:document.getElementById("status"),video:document.getElementById("preview-video"),canvas:document.getElementById("working-canvas")},$=document.getElementById("width-value"),N=document.getElementById("fps-value"),z=document.getElementById("quality-value"),m=document.getElementById("dropzone"),P=document.getElementById("file-input");let w=null,f=null,F=null,L=null,h=null;const _=[{module:"https://unpkg.com/@ffmpeg/ffmpeg@0.12.6/dist/ffmpeg.min.js",core:"https://unpkg.com/@ffmpeg/core@0.12.6/dist/ffmpeg-core.js"},{module:"https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.6/dist/ffmpeg.min.js",core:"https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.6/dist/ffmpeg-core.js"}],M=()=>{F=null,L=null},O=async()=>{if(!F){if(h){await h;return}h=(async()=>{var t,i,o;let e=null;for(const n of _)try{d("FFmpeg モジュールを読み込んでいます...");const a=await import(n.module),l=a.createFFmpeg??((t=a.default)==null?void 0:t.createFFmpeg),c=a.fetchFile??((i=a.default)==null?void 0:i.fetchFile);if(typeof l!="function"||typeof c!="function")throw console.warn("FFmpeg module shape:",a),new Error("createFFmpeg / fetchFile が見つかりません");L=c;const s=l({log:!1,corePath:n.core});(o=s.setProgress)==null||o.call(s,({ratio:p})=>{d(`FFmpeg 変換中... ${(p*100).toFixed(1)}%`)}),await s.load(),F=s;return}catch(a){console.warn("FFmpeg load failed for",n.module,a),e=a,M()}throw e??new Error("FFmpeg モジュールの読み込みに失敗しました")})();try{await h}finally{h=null}}},v=()=>{$.textContent=`${r.width.value}px`,N.textContent=`${r.fps.value}fps`,z.textContent=`${r.quality.value}/8`};v();const d=(e,t=!1)=>{r.status.textContent=e,r.status.dataset.state=t?"error":"normal"},A=()=>{r.video.removeAttribute("src"),r.video.load(),r.convert.disabled=!0,r.download.setAttribute("aria-disabled","true"),r.download.removeAttribute("href"),d("動画ファイルを読み込んでください。")},S=e=>{if(!e.type.startsWith("video/")){d("対応していないファイル形式です。動画ファイルを選択してください。",!0);return}w=e,f&&(URL.revokeObjectURL(f),f=null),f=URL.createObjectURL(e),r.video.src=f,r.video.onloadedmetadata=()=>{r.video.currentTime=0,r.convert.disabled=!1;const t=Math.min(960,Math.round(r.video.videoWidth));r.width.max=String(Math.max(160,t)),r.width.value=String(Math.min(t,Number(r.width.value))),$.textContent=`${r.width.value}px`,d("動画が読み込まれました。設定を調整して「GIF を作成」を押してください。")},r.video.onerror=()=>{d("動画の読み込みに失敗しました。",!0),A()}},j=e=>{if(!e)return null;if(e.files&&e.files.length>0)return e.files[0]??null;if(e.items){for(const t of Array.from(e.items))if(t.kind==="file"){const i=t.getAsFile();if(i)return i}}return null},T=e=>{e.preventDefault(),m.classList.remove("drag-over");const t=j(e.dataTransfer??null);t?S(t):d("ファイルをドロップしてください。フォルダは利用できません。",!0)},R=(e,t,i)=>{const o=["none","floyd_steinberg","sierra2","sierra2_4a","bayer:bayer_scale=5:diffusion=1","bayer:bayer_scale=4:diffusion=1","bayer:bayer_scale=3:diffusion=1","bayer:bayer_scale=2:diffusion=1"],n=Math.min(o.length-1,Math.max(0,Math.round(i)-1)),a=o[n];return`fps=${e},scale=${t}:-1:flags=lanczos,split[a][b];[a]palettegen=stats_mode=full[p];[b][p]paletteuse=dither=${a}`},C=async(e,t,i)=>{await O();const o=F,n=L;if(!o||!n)throw new Error("FFmpeg の初期化に失敗しました。");const a=Math.max(160,Math.round(t.width)),l=Math.max(1,Math.round(t.fps)),c=Math.max(1,Math.round(t.quality)),s=`input-${Date.now()}.mp4`,p=`output-${Date.now()}.gif`;let x=!1;const I=()=>{x=!0;try{o.exit()}catch(u){console.warn("FFmpeg exit error:",u)}M()};i.addEventListener("abort",I,{once:!0});try{d("FFmpeg で GIF を生成しています...");const u=await n(e);o.FS("writeFile",s,u);const y=R(l,a,c);await o.run("-i",s,"-vf",y,"-loop","0",p);const q=o.FS("readFile",p);return new Blob([q],{type:"image/gif"})}catch(u){if(x)throw new Error("処理が中断されました。");try{o.exit()}catch(y){console.warn("FFmpeg exit error:",y)}throw M(),u}finally{i.removeEventListener("abort",I);try{o.FS("unlink",s)}catch(u){console.warn("Failed to remove input from FFmpeg FS",u)}try{o.FS("unlink",p)}catch(u){console.warn("Failed to remove output from FFmpeg FS",u)}}},U=async(e,t,i)=>{let o=Math.max(160,Math.round(t.width)),n=Math.max(1,Math.round(t.fps));const a=Math.max(1,Math.round(t.quality));let l=0,c=null;for(;o>=160&&n>=5;){l+=1,d(`変換中... (試行 ${l})`);const s=await C(e,{width:o,fps:n,quality:a},i);if(s.size<=E)return{blob:s,width:o,fps:n,iterations:l};if(c=s,o>320){o=Math.max(160,Math.floor(o*.85));continue}n=Math.max(5,n-2)}if(c)return{blob:c,width:o,fps:n,iterations:l};throw new Error("出力サイズを 10MB 以下に抑えられませんでした。設定を見直してください。")};let g=null;r.convert.addEventListener("click",async()=>{if(!(!w||!f)){g&&g.abort(),g=new AbortController,r.convert.disabled=!0,r.download.setAttribute("aria-disabled","true"),r.download.removeAttribute("href"),d("変換を開始しました...");try{r.video.pause(),r.video.currentTime=0,await D(r.video);const e={width:b(r.width.value,r.video.videoWidth||480,160,960),fps:b(r.fps.value,12,1,60),quality:b(r.quality.value,6,1,8)},t=await U(w,e,g.signal),i=URL.createObjectURL(t.blob);r.download.href=i,r.download.download=`${w.name.replace(/\.[^.]+$/,"")||"output"}.gif`,r.download.setAttribute("aria-disabled","false"),d(t.blob.size<=E?`変換が完了しました！ (${B(t.blob.size)})`:`変換は完了しましたが 10MB を超えています (${B(t.blob.size)})。解像度やフレームレートを下げて再試行してください。`,t.blob.size>E)}catch(e){console.error(e),d(e instanceof Error?e.message:"変換中にエラーが発生しました。",!0)}finally{r.convert.disabled=!1,g=null}}});P.addEventListener("change",e=>{var i;const t=e.target;(i=t.files)!=null&&i.length&&S(t.files[0])});m.addEventListener("dragover",e=>{e.preventDefault(),m.classList.add("drag-over")});m.addEventListener("dragleave",()=>{m.classList.remove("drag-over")});m.addEventListener("drop",T);r.width.addEventListener("input",v);r.fps.addEventListener("input",v);r.quality.addEventListener("input",v);r.download.addEventListener("click",()=>{r.download.getAttribute("aria-disabled")!=="true"&&d("GIF をダウンロードしています...")});const B=e=>e<1024?`${e}B`:e<1024*1024?`${(e/1024).toFixed(1)}KB`:`${(e/(1024*1024)).toFixed(2)}MB`,b=(e,t,i=0,o=Number.POSITIVE_INFINITY)=>{const n=Number.parseFloat(e);return Number.isFinite(n)?Math.min(Math.max(n,i),o):t};A();const W=(e,t)=>new Promise(i=>{const o=n=>{e.removeEventListener(t,o),i(n)};e.addEventListener(t,o,{once:!0})}),D=async e=>{if(e.readyState<HTMLMediaElement.HAVE_METADATA&&await W(e,"loadedmetadata"),(e.videoWidth===0||e.videoHeight===0)&&await new Promise(t=>requestAnimationFrame(t)),e.videoWidth===0||e.videoHeight===0)throw new Error("動画のメタデータを取得できませんでした。別のファイルでお試しください。");if(!Number.isFinite(e.duration)||e.duration<=0)throw new Error("動画の長さが不正です。")};
