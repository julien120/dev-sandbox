var _=Object.defineProperty;var X=(o,t,e)=>t in o?_(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var n=(o,t,e)=>X(o,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const h of r.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&s(h)}).observe(document,{childList:!0,subtree:!0});function e(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=e(i);fetch(i.href,r)}})();class Y{constructor(){n(this,"sounds",new Map);n(this,"muted",!1)}load(t,e){if(this.sounds.has(t))return;const s=new Audio(e);s.preload="auto",this.sounds.set(t,s)}play(t,e={}){const s=this.sounds.get(t);if(!s||this.muted)return;const i=s.cloneNode(!0);i.loop=e.loop??!1,i.volume=e.volume??1,i.play()}setMuted(t){this.muted=t}isMuted(){return this.muted}}const N=1e3/60,$=5;class W{constructor(){n(this,"lastTick",performance.now());n(this,"accumulated",0);n(this,"running",!1);n(this,"subscribers",[]);n(this,"rafId",0);n(this,"loop",()=>{if(!this.running)return;const t=performance.now(),e=t-this.lastTick;this.lastTick=t,this.accumulated+=e;let s=0;for(;this.accumulated>=N&&s<$;)this.accumulated-=N,this.subscribers.forEach(i=>i(N/1e3)),s+=1;this.rafId=requestAnimationFrame(this.loop)})}start(){this.running||(this.running=!0,this.lastTick=performance.now(),this.loop())}stop(){this.running=!1,cancelAnimationFrame(this.rafId)}subscribe(t){return this.subscribers.push(t),()=>{const e=this.subscribers.indexOf(t);e>=0&&this.subscribers.splice(e,1)}}}class B{constructor(t=window){n(this,"pressedKeys",new Set);n(this,"pointerPosition",{x:0,y:0});n(this,"listeners",[]);n(this,"keyDownListener",t=>this.handleKeyDown(t));n(this,"keyUpListener",t=>this.handleKeyUp(t));n(this,"pointerListener",t=>this.handlePointer(t));n(this,"handleKeyDown",t=>{this.pressedKeys.add(t.key.toLowerCase()),this.listeners.forEach(e=>e(t))});n(this,"handleKeyUp",t=>{this.pressedKeys.delete(t.key.toLowerCase()),this.listeners.forEach(e=>e(t))});n(this,"handlePointer",t=>{this.pointerPosition={x:t.clientX,y:t.clientY},this.listeners.forEach(e=>e(t))});this.target=t}attach(){this.addTargetListeners(this.target)}detach(){this.removeTargetListeners(this.target),this.pressedKeys.clear(),this.listeners=[]}addTargetListeners(t){if(t instanceof Window){t.addEventListener("keydown",this.keyDownListener,{passive:!0}),t.addEventListener("keyup",this.keyUpListener,{passive:!0}),t.addEventListener("pointerdown",this.pointerListener,{passive:!0}),t.addEventListener("pointerup",this.pointerListener,{passive:!0}),t.addEventListener("pointermove",this.pointerListener,{passive:!0});return}t.addEventListener("keydown",this.keyDownListener,{passive:!0}),t.addEventListener("keyup",this.keyUpListener,{passive:!0}),t.addEventListener("pointerdown",this.pointerListener,{passive:!0}),t.addEventListener("pointerup",this.pointerListener,{passive:!0}),t.addEventListener("pointermove",this.pointerListener,{passive:!0})}removeTargetListeners(t){if(t instanceof Window){t.removeEventListener("keydown",this.keyDownListener),t.removeEventListener("keyup",this.keyUpListener),t.removeEventListener("pointerdown",this.pointerListener),t.removeEventListener("pointerup",this.pointerListener),t.removeEventListener("pointermove",this.pointerListener);return}t.removeEventListener("keydown",this.keyDownListener),t.removeEventListener("keyup",this.keyUpListener),t.removeEventListener("pointerdown",this.pointerListener),t.removeEventListener("pointerup",this.pointerListener),t.removeEventListener("pointermove",this.pointerListener)}isKeyPressed(t){return this.pressedKeys.has(t.toLowerCase())}getPointerPosition(){return{...this.pointerPosition}}onInput(t){return this.listeners.push(t),()=>{this.listeners=this.listeners.filter(e=>e!==t)}}}class J{constructor(t){n(this,"context");n(this,"canvas");const e=t.getContext("2d");if(!e)throw new Error("Renderer requires 2D canvas context");this.canvas=t,this.context=e,this.context.imageSmoothingEnabled=!0}clear(t="#000000"){const e=this.context;e.save(),e.fillStyle=t,e.fillRect(0,0,this.canvas.width,this.canvas.height),e.restore()}drawSprite(t,e,s){this.context.drawImage(t,e.x,e.y,s.x,s.y)}drawRect(t,e,s){const i=this.context;i.save(),i.fillStyle=s,i.fillRect(t.x,t.y,e.x,e.y),i.restore()}drawText(t,e,s={}){const i=this.context;i.save(),i.fillStyle=s.color??"#ffffff",i.font=s.font??"16px sans-serif",i.textBaseline="top",i.fillText(t,e.x,e.y),i.restore()}resize(t){this.canvas.width=t.x,this.canvas.height=t.y}}class q{constructor(t,e={}){n(this,"audio",new Y);n(this,"input");n(this,"renderer");n(this,"ticker",new W);n(this,"currentScene",null);n(this,"elapsedTime",0);n(this,"options");n(this,"update",t=>{var s,i;const e=this.createContext(t);this.options.background?this.renderer.clear(this.options.background):this.renderer.clear(),(s=this.currentScene)==null||s.update(t,e),(i=this.currentScene)==null||i.render(e),this.elapsedTime+=t});this.options=e,this.renderer=new J(t),this.input=new B(window),this.input.attach(),this.ticker.subscribe(this.update)}setScene(t){var e,s;(e=this.currentScene)!=null&&e.onExit&&this.currentScene.onExit(this.createContext()),this.currentScene=t,(s=this.currentScene)!=null&&s.onEnter&&this.currentScene.onEnter(this.createContext())}start(){this.elapsedTime=0,this.ticker.start()}stop(){this.ticker.stop()}dispose(){this.stop(),this.input.detach()}createContext(t=0){return{renderer:this.renderer,input:this.input,elapsedTime:this.elapsedTime+t}}}const R=(o=0,t=0)=>({x:o,y:t}),D=(o,t,e)=>Math.max(t,Math.min(e,o));class z{}const V=()=>globalThis.FaceDetector??null,k=[{id:"joy",emoji:"üòÄ",label:"„Çà„Çç„Åì„Å≥",description:"Âè£Ëßí„Çí‰∏ä„Åí„Å¶„Å´„Å£„Åì„Çä"},{id:"anger",emoji:"üò°",label:"„ÅÑ„Åã„Çä",description:"ÁõÆ„ÇíÁ¥∞„ÇÅ„Å¶„Ç≠„ÉÉ„Å®"},{id:"sad",emoji:"üò¢",label:"„Åã„Å™„Åó„ÅÑ",description:"Âè£Ëßí„Çí‰∏ã„Åí„Å¶„Åó„Çá„Çì„Åº„Çä"},{id:"surprise",emoji:"üò≤",label:"„Åä„Å©„Çç„Åç",description:"ÁõÆ„Å®Âè£„ÇíÂ§ß„Åç„ÅèÈñã„Åè"}],P=.2,G=.5,H=.35,K=45,U=8,Q=(o,t)=>{var y;if(!((y=o.landmarks)!=null&&y.length))return{id:"unknown",features:null};const e=o.boundingBox,s=o.landmarks.filter(a=>a.type==="mouth").flatMap(a=>Array.from(a.locations)),i=o.landmarks.filter(a=>a.type==="eye").flatMap(a=>Array.from(a.locations));if(s.length<3||i.length<4)return{id:"unknown",features:null};const r=a=>a/e.height,h=a=>a/e.width,f=(()=>{const a=s.map(d=>d.x),L=s.map(d=>d.y),C=Math.min(...a),b=Math.max(...a),S=Math.min(...L),T=Math.max(...L),g=b-C,w=T-S,x=(T+S)/2,O=s.reduce((d,E)=>E.x<d.x?E:d,s[0]),I=s.reduce((d,E)=>E.x>d.x?E:d,s[0]),F=(O.y+I.y)/2-x;return{width:g/t.x,height:w/t.y,open:r(w),curve:r(F)}})(),u=(()=>{const a=e.x+e.width/2,L=i.filter(g=>g.x<=a),C=i.filter(g=>g.x>a),b=g=>{if(g.length<2)return 0;const w=g.map(d=>d.x),x=g.map(d=>d.y),O=Math.max(...w)-Math.min(...w),I=Math.max(...x)-Math.min(...x),A=h(O),F=r(I);return A<=0?0:F/A},S=b(L),T=b(C);return{openness:(S+T)/2}})(),c={mouthOpen:f.open,mouthCurve:f.curve,eyeOpenness:u.openness},l=-c.mouthCurve,v=c.mouthCurve,m=c.mouthOpen,p=c.eyeOpenness;return m>.22&&p>.27?{id:"surprise",features:c}:l>.02&&m>.1?{id:"joy",features:c}:p<.16&&m<.12?{id:"anger",features:c}:v>.02&&m<.14?{id:"sad",features:c}:{id:"unknown",features:c}};class Z extends z{constructor(){super(...arguments);n(this,"video",null);n(this,"stream",null);n(this,"detector",null);n(this,"detectionTimer",0);n(this,"detecting",!1);n(this,"timeLeft",K);n(this,"score",0);n(this,"combo",0);n(this,"bestCombo",0);n(this,"matchProgress",0);n(this,"target",k[0]);n(this,"lastExpression","unknown");n(this,"lastFeatures",null);n(this,"lastFace",null);n(this,"status",null);n(this,"gameOver",!1);n(this,"removeInputListener",null)}async onEnter(e){if(this.resetState(),this.video=document.getElementById("camera-stream"),!this.video){this.status="„Éì„Éá„Ç™Ë¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì";return}try{this.stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user",width:640,height:480},audio:!1}),this.video.srcObject=this.stream,await this.video.play()}catch(r){this.status="„Ç´„É°„É©„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÊ®©Èôê„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",console.error(r);return}const s=V();if(!s){this.status="FaceDetector API „Å´ÂØæÂøú„Åó„Åü„Éñ„É©„Ç¶„Ç∂„ÅåÂøÖË¶Å„Åß„Åô (Chrome / Edge Êé®Â•®)„ÄÇ";return}this.detector=new s({maxDetectedFaces:1,fastMode:!0});const i=e.input;this.removeInputListener=i.onInput(r=>this.handleInput(r)),this.pickNextTarget()}onExit(){var e;this.cleanupStream(),(e=this.removeInputListener)==null||e.call(this),this.removeInputListener=null}update(e){if(!this.gameOver){if(this.timeLeft=D(this.timeLeft-e,0,999),this.timeLeft<=0){this.gameOver=!0,this.status="ÊôÇÈñìÂàá„ÇåÔºÅ„Çπ„Éö„Éº„Çπ„Åã„ÇØ„É™„ÉÉ„ÇØ„ÅßÂÜç„Çπ„Çø„Éº„Éà";return}!this.detector||!this.video||this.video.readyState<HTMLMediaElement.HAVE_ENOUGH_DATA||(this.detectionTimer-=e,this.detectionTimer<=0&&!this.detecting&&(this.detectionTimer=P,this.detectExpression()))}}render(e){const s=e.renderer,i=s.context,r=s.canvas;i.save(),i.fillStyle="#0f172a",i.fillRect(0,0,r.width,r.height),i.restore(),this.video&&this.video.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA&&(i.save(),i.translate(r.width,0),i.scale(-1,1),i.drawImage(this.video,0,0,r.width,r.height),i.restore()),this.lastFace&&this.drawFaceOutline(i,r),this.drawHud(i,r),this.drawStatus(i,r)}resetState(){this.timeLeft=K,this.score=0,this.combo=0,this.bestCombo=0,this.matchProgress=0,this.target=k[0],this.lastExpression="unknown",this.lastFeatures=null,this.lastFace=null,this.status=null,this.gameOver=!1,this.detectionTimer=0}handleInput(e){if(e instanceof PointerEvent&&e.type==="pointerdown"){this.gameOver&&(this.resetState(),this.pickNextTarget());return}if(!(e instanceof KeyboardEvent)||e.type!=="keydown")return;const s=e.key.toLowerCase();(s===" "||s==="enter")&&this.gameOver&&(this.resetState(),this.pickNextTarget())}async detectExpression(){if(!(!this.detector||!this.video)){this.detecting=!0;try{const e=await this.detector.detect(this.video);if(e.length===0){this.lastFace=null,this.lastExpression="unknown",this.lastFeatures=null,this.matchProgress=Math.max(0,this.matchProgress-H*P);return}const s=e[0],i=R(this.video.videoWidth||this.video.width,this.video.videoHeight||this.video.height),r=Q(s,i);this.lastExpression=r.id,this.lastFeatures=r.features,this.lastFace=s,r.id===this.target.id?this.matchProgress=Math.min(1,this.matchProgress+G*P):this.matchProgress=Math.max(0,this.matchProgress-H*P),this.matchProgress>=.999&&this.onSuccessMatch()}catch(e){console.error(e),this.status="Ë°®ÊÉÖ„ÅÆËß£Êûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éñ„É©„Ç¶„Ç∂„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"}finally{this.detecting=!1}}}onSuccessMatch(){this.score+=100+this.combo*20,this.combo+=1,this.bestCombo=Math.max(this.bestCombo,this.combo),this.timeLeft=D(this.timeLeft+U,0,120),this.matchProgress=0,this.status=`${this.target.label}„ÇØ„É™„Ç¢ÔºÅ +${U}Áßí`,this.pickNextTarget()}pickNextTarget(){const e=k.filter(i=>i.id!==this.target.id),s=Math.floor(Math.random()*e.length);this.target=e[s]}drawFaceOutline(e,s){if(!this.video||!this.lastFace)return;const i=this.lastFace.boundingBox,r=s.width/(this.video.videoWidth||this.video.width||s.width),h=s.height/(this.video.videoHeight||this.video.height||s.height),f=s.width-(i.x+i.width)*r,u=i.y*h,c=i.width*r,l=i.height*h;e.save(),e.strokeStyle="rgba(96, 165, 250, 0.85)",e.lineWidth=3,e.strokeRect(f,u,c,l),e.restore(),this.drawLandmarks(e,s,r,h)}drawHud(e,s){var f;e.save(),e.fillStyle="rgba(15, 23, 42, 0.6)",e.fillRect(20,20,200,120),e.fillRect(s.width-240,20,220,160),e.fillStyle="#f8fafc",e.font='22px/1.3 "Noto Sans JP", system-ui, sans-serif',e.fillText("„Çø„Éº„Ç≤„ÉÉ„Éà",32,52),e.font='64px/1 "Segoe UI Emoji", system-ui',e.fillText(this.target.emoji,36,120),e.font='20px/1.2 "Noto Sans JP", system-ui, sans-serif',e.fillText(this.target.label,100,86),e.fillText(this.target.description,32,150),e.textAlign="right",e.font='24px/1.4 "Noto Sans JP", system-ui, sans-serif',e.fillText(`„Çπ„Ç≥„Ç¢: ${this.score}`,s.width-24,52),e.fillText(`„ÅÆ„Åì„ÇäÊôÇÈñì: ${Math.ceil(this.timeLeft)}s`,s.width-24,84),e.fillText(`„Ç≥„É≥„Éú: ${this.combo} („Éô„Çπ„Éà ${this.bestCombo})`,s.width-24,116),e.fillText(`Âà§ÂÆö: ${this.lastExpression==="unknown"?"---":((f=k.find(u=>u.id===this.lastExpression))==null?void 0:f.label)??"---"}`,s.width-24,148),e.textAlign="left";const i=s.width-80,r=40,h=s.height-60;if(e.fillStyle="rgba(15, 23, 42, 0.6)",e.fillRect(r,h,i,24),e.fillStyle="#34d399",e.fillRect(r,h,i*D(this.matchProgress,0,1),24),e.strokeStyle="rgba(248, 250, 252, 0.8)",e.lineWidth=2,e.strokeRect(r,h,i,24),e.fillStyle="#f8fafc",e.font='18px/1.2 "Noto Sans JP", system-ui, sans-serif',e.fillText("„Çø„Éº„Ç≤„ÉÉ„Éà„Å®‰∏ÄËá¥„Åô„Çã„Å®„Ç≤„Éº„Ç∏„ÅåÊ∫Ä„Çø„É≥„Å´„Å™„Çä„Åæ„Åô",r,h-8),this.lastFeatures){e.font='16px/1.2 "Noto Sans JP", system-ui, sans-serif';const u=this.lastFeatures;e.fillText(`mouthOpen: ${(u.mouthOpen*100).toFixed(1)}%`,32,s.height-120),e.fillText(`mouthCurve: ${(u.mouthCurve*100).toFixed(2)}%`,32,s.height-96),e.fillText(`eyeOpen: ${(u.eyeOpenness*100).toFixed(1)}%`,32,s.height-72)}e.restore()}drawStatus(e,s){if(!this.status)return;e.save(),e.fillStyle="rgba(15, 23, 42, 0.7)",e.fillRect(80,s.height/2-60,s.width-160,120),e.fillStyle="#f8fafc",e.textAlign="center",e.font='26px/1.4 "Noto Sans JP", system-ui, sans-serif',this.status.split(`
`).forEach((r,h)=>{e.fillText(r,s.width/2,s.height/2-10+h*30)}),e.textAlign="left",e.restore()}cleanupStream(){var e;(e=this.stream)==null||e.getTracks().forEach(s=>s.stop()),this.stream=null,this.video&&(this.video.srcObject=null,this.video=null)}drawLandmarks(e,s,i,r){const h=this.lastFace,f=this.video;if(!h||!f||!h.landmarks)return;const u=l=>{const v=s.width-l.x*i,m=l.y*r;return R(v,m)},c=(l,v)=>{e.beginPath(),e.fillStyle=v,e.arc(l.x,l.y,3,0,Math.PI*2),e.fill()};h.landmarks.forEach(l=>{const v=l.locations??[];if(v.length===0)return;const m=l.type==="mouth"?"#f97316":l.type==="eye"?"#38bdf8":"#facc15",p=v.map(u);e.save(),e.strokeStyle=m,e.lineWidth=2,e.beginPath(),e.moveTo(p[0].x,p[0].y);for(let y=1;y<p.length;y+=1)e.lineTo(p[y].x,p[y].y);(l.type==="mouth"||l.type==="eye")&&e.closePath(),e.stroke(),e.restore(),p.forEach(y=>c(y,m))})}}const M=document.getElementById("game-canvas");if(!M)throw new Error("„Ç≤„Éº„É†„Ç≠„É£„É≥„Éê„Çπ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì");const j=new q(M,{background:"#0f172a"});j.renderer.resize(R(M.width,M.height));j.setScene(new Z);j.start();
