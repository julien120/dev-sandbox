var j=Object.defineProperty;var Y=(o,t,e)=>t in o?j(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var r=(o,t,e)=>Y(o,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function e(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=e(i);fetch(i.href,n)}})();class ${constructor(){r(this,"sounds",new Map);r(this,"muted",!1)}load(t,e){if(this.sounds.has(t))return;const s=new Audio(e);s.preload="auto",this.sounds.set(t,s)}play(t,e={}){const s=this.sounds.get(t);if(!s||this.muted)return;const i=s.cloneNode(!0);i.loop=e.loop??!1,i.volume=e.volume??1,i.play()}setMuted(t){this.muted=t}isMuted(){return this.muted}}const I=1e3/60,X=5;class W{constructor(){r(this,"lastTick",performance.now());r(this,"accumulated",0);r(this,"running",!1);r(this,"subscribers",[]);r(this,"rafId",0);r(this,"loop",()=>{if(!this.running)return;const t=performance.now(),e=t-this.lastTick;this.lastTick=t,this.accumulated+=e;let s=0;for(;this.accumulated>=I&&s<X;)this.accumulated-=I,this.subscribers.forEach(i=>i(I/1e3)),s+=1;this.rafId=requestAnimationFrame(this.loop)})}start(){this.running||(this.running=!0,this.lastTick=performance.now(),this.loop())}stop(){this.running=!1,cancelAnimationFrame(this.rafId)}subscribe(t){return this.subscribers.push(t),()=>{const e=this.subscribers.indexOf(t);e>=0&&this.subscribers.splice(e,1)}}}class B{constructor(t=window){r(this,"pressedKeys",new Set);r(this,"pointerPosition",{x:0,y:0});r(this,"listeners",[]);r(this,"keyDownListener",t=>this.handleKeyDown(t));r(this,"keyUpListener",t=>this.handleKeyUp(t));r(this,"pointerListener",t=>this.handlePointer(t));r(this,"handleKeyDown",t=>{this.pressedKeys.add(t.key.toLowerCase()),this.listeners.forEach(e=>e(t))});r(this,"handleKeyUp",t=>{this.pressedKeys.delete(t.key.toLowerCase()),this.listeners.forEach(e=>e(t))});r(this,"handlePointer",t=>{this.pointerPosition={x:t.clientX,y:t.clientY},this.listeners.forEach(e=>e(t))});this.target=t}attach(){this.addTargetListeners(this.target)}detach(){this.removeTargetListeners(this.target),this.pressedKeys.clear(),this.listeners=[]}addTargetListeners(t){if(t instanceof Window){t.addEventListener("keydown",this.keyDownListener,{passive:!0}),t.addEventListener("keyup",this.keyUpListener,{passive:!0}),t.addEventListener("pointerdown",this.pointerListener,{passive:!0}),t.addEventListener("pointerup",this.pointerListener,{passive:!0}),t.addEventListener("pointermove",this.pointerListener,{passive:!0});return}t.addEventListener("keydown",this.keyDownListener,{passive:!0}),t.addEventListener("keyup",this.keyUpListener,{passive:!0}),t.addEventListener("pointerdown",this.pointerListener,{passive:!0}),t.addEventListener("pointerup",this.pointerListener,{passive:!0}),t.addEventListener("pointermove",this.pointerListener,{passive:!0})}removeTargetListeners(t){if(t instanceof Window){t.removeEventListener("keydown",this.keyDownListener),t.removeEventListener("keyup",this.keyUpListener),t.removeEventListener("pointerdown",this.pointerListener),t.removeEventListener("pointerup",this.pointerListener),t.removeEventListener("pointermove",this.pointerListener);return}t.removeEventListener("keydown",this.keyDownListener),t.removeEventListener("keyup",this.keyUpListener),t.removeEventListener("pointerdown",this.pointerListener),t.removeEventListener("pointerup",this.pointerListener),t.removeEventListener("pointermove",this.pointerListener)}isKeyPressed(t){return this.pressedKeys.has(t.toLowerCase())}getPointerPosition(){return{...this.pointerPosition}}onInput(t){return this.listeners.push(t),()=>{this.listeners=this.listeners.filter(e=>e!==t)}}}class J{constructor(t){r(this,"context");r(this,"canvas");const e=t.getContext("2d");if(!e)throw new Error("Renderer requires 2D canvas context");this.canvas=t,this.context=e,this.context.imageSmoothingEnabled=!0}clear(t="#000000"){const e=this.context;e.save(),e.fillStyle=t,e.fillRect(0,0,this.canvas.width,this.canvas.height),e.restore()}drawSprite(t,e,s){this.context.drawImage(t,e.x,e.y,s.x,s.y)}drawRect(t,e,s){const i=this.context;i.save(),i.fillStyle=s,i.fillRect(t.x,t.y,e.x,e.y),i.restore()}drawText(t,e,s={}){const i=this.context;i.save(),i.fillStyle=s.color??"#ffffff",i.font=s.font??"16px sans-serif",i.textBaseline="top",i.fillText(t,e.x,e.y),i.restore()}resize(t){this.canvas.width=t.x,this.canvas.height=t.y}}class q{constructor(t,e={}){r(this,"audio",new $);r(this,"input");r(this,"renderer");r(this,"ticker",new W);r(this,"currentScene",null);r(this,"elapsedTime",0);r(this,"options");r(this,"update",t=>{var s,i;const e=this.createContext(t);this.options.background?this.renderer.clear(this.options.background):this.renderer.clear(),(s=this.currentScene)==null||s.update(t,e),(i=this.currentScene)==null||i.render(e),this.elapsedTime+=t});this.options=e,this.renderer=new J(t),this.input=new B(window),this.input.attach(),this.ticker.subscribe(this.update)}setScene(t){var e,s;(e=this.currentScene)!=null&&e.onExit&&this.currentScene.onExit(this.createContext()),this.currentScene=t,(s=this.currentScene)!=null&&s.onEnter&&this.currentScene.onEnter(this.createContext())}start(){this.elapsedTime=0,this.ticker.start()}stop(){this.ticker.stop()}dispose(){this.stop(),this.input.detach()}createContext(t=0){return{renderer:this.renderer,input:this.input,elapsedTime:this.elapsedTime+t}}}const U=(o=0,t=0)=>({x:o,y:t}),A=(o,t,e)=>Math.max(t,Math.min(e,o));class z{}const V=()=>globalThis.FaceDetector??null,x=[{id:"joy",emoji:"üòÄ",label:"„Çà„Çç„Åì„Å≥",description:"Âè£Ëßí„Çí‰∏ä„Åí„Å¶„Å´„Å£„Åì„Çä"},{id:"anger",emoji:"üò°",label:"„ÅÑ„Åã„Çä",description:"ÁõÆ„ÇíÁ¥∞„ÇÅ„Å¶„Ç≠„ÉÉ„Å®"},{id:"sad",emoji:"üò¢",label:"„Åã„Å™„Åó„ÅÑ",description:"Âè£Ëßí„Çí‰∏ã„Åí„Å¶„Åó„Çá„Çì„Åº„Çä"},{id:"surprise",emoji:"üò≤",label:"„Åä„Å©„Çç„Åç",description:"ÁõÆ„Å®Âè£„ÇíÂ§ß„Åç„ÅèÈñã„Åè"}],b=.2,G=.5,R=.35,H=45,K=8,Q=(o,t)=>{var D;if(!((D=o.landmarks)!=null&&D.length))return{id:"unknown",features:null};const e=o.boundingBox,s=o.landmarks.filter(h=>h.type==="mouth").flatMap(h=>Array.from(h.locations)),i=o.landmarks.filter(h=>h.type==="eye").flatMap(h=>Array.from(h.locations));if(s.length<3||i.length<4)return{id:"unknown",features:null};const n=h=>h/e.height,a=h=>h/e.width,f=(()=>{const h=s.map(l=>l.x),g=s.map(l=>l.y),k=Math.min(...h),v=Math.max(...h),w=Math.min(...g),E=Math.max(...g),u=v-k,m=E-w,L=(E+w)/2,M=s.reduce((l,p)=>p.x<l.x?p:l,s[0]),P=s.reduce((l,p)=>p.x>l.x?p:l,s[0]),O=(M.y+P.y)/2-L;return{width:u/t.x,height:m/t.y,open:n(m),curve:n(O)}})(),d=(()=>{const h=e.x+e.width/2,g=i.filter(u=>u.x<=h),k=i.filter(u=>u.x>h),v=u=>{if(u.length<2)return 0;const m=u.map(l=>l.x),L=u.map(l=>l.y),M=Math.max(...m)-Math.min(...m),P=Math.max(...L)-Math.min(...L),C=a(M),O=n(P);return C<=0?0:O/C},w=v(g),E=v(k);return{openness:(w+E)/2}})(),c={mouthOpen:f.open,mouthCurve:f.curve,eyeOpenness:d.openness},T=-c.mouthCurve,_=c.mouthCurve,y=c.mouthOpen,N=c.eyeOpenness;return y>.22&&N>.27?{id:"surprise",features:c}:T>.02&&y>.1?{id:"joy",features:c}:N<.16&&y<.12?{id:"anger",features:c}:_>.02&&y<.14?{id:"sad",features:c}:{id:"unknown",features:c}};class Z extends z{constructor(){super(...arguments);r(this,"video",null);r(this,"stream",null);r(this,"detector",null);r(this,"detectionTimer",0);r(this,"detecting",!1);r(this,"timeLeft",H);r(this,"score",0);r(this,"combo",0);r(this,"bestCombo",0);r(this,"matchProgress",0);r(this,"target",x[0]);r(this,"lastExpression","unknown");r(this,"lastFeatures",null);r(this,"lastFace",null);r(this,"status",null);r(this,"gameOver",!1);r(this,"removeInputListener",null)}async onEnter(e){if(this.resetState(),this.video=document.getElementById("camera-stream"),!this.video){this.status="„Éì„Éá„Ç™Ë¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì";return}try{this.stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user",width:640,height:480},audio:!1}),this.video.srcObject=this.stream,await this.video.play()}catch(n){this.status="„Ç´„É°„É©„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÊ®©Èôê„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",console.error(n);return}const s=V();if(!s){this.status="FaceDetector API „Å´ÂØæÂøú„Åó„Åü„Éñ„É©„Ç¶„Ç∂„ÅåÂøÖË¶Å„Åß„Åô (Chrome / Edge Êé®Â•®)„ÄÇ";return}this.detector=new s({maxDetectedFaces:1,fastMode:!0});const i=e.input;this.removeInputListener=i.onInput(n=>this.handleInput(n)),this.pickNextTarget()}onExit(){var e;this.cleanupStream(),(e=this.removeInputListener)==null||e.call(this),this.removeInputListener=null}update(e){if(!this.gameOver){if(this.timeLeft=A(this.timeLeft-e,0,999),this.timeLeft<=0){this.gameOver=!0,this.status="ÊôÇÈñìÂàá„ÇåÔºÅ„Çπ„Éö„Éº„Çπ„Åã„ÇØ„É™„ÉÉ„ÇØ„ÅßÂÜç„Çπ„Çø„Éº„Éà";return}!this.detector||!this.video||this.video.readyState<HTMLMediaElement.HAVE_ENOUGH_DATA||(this.detectionTimer-=e,this.detectionTimer<=0&&!this.detecting&&(this.detectionTimer=b,this.detectExpression()))}}render(e){const s=e.renderer,i=s.context,n=s.canvas;i.save(),i.fillStyle="#0f172a",i.fillRect(0,0,n.width,n.height),i.restore(),this.video&&this.video.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA&&(i.save(),i.translate(n.width,0),i.scale(-1,1),i.drawImage(this.video,0,0,n.width,n.height),i.restore()),this.lastFace&&this.drawFaceOutline(i,n),this.drawHud(i,n),this.drawStatus(i,n)}resetState(){this.timeLeft=H,this.score=0,this.combo=0,this.bestCombo=0,this.matchProgress=0,this.target=x[0],this.lastExpression="unknown",this.lastFeatures=null,this.lastFace=null,this.status=null,this.gameOver=!1,this.detectionTimer=0}handleInput(e){if(e instanceof PointerEvent&&e.type==="pointerdown"){this.gameOver&&(this.resetState(),this.pickNextTarget());return}if(!(e instanceof KeyboardEvent)||e.type!=="keydown")return;const s=e.key.toLowerCase();(s===" "||s==="enter")&&this.gameOver&&(this.resetState(),this.pickNextTarget())}async detectExpression(){if(!(!this.detector||!this.video)){this.detecting=!0;try{const e=await this.detector.detect(this.video);if(e.length===0){this.lastFace=null,this.lastExpression="unknown",this.lastFeatures=null,this.matchProgress=Math.max(0,this.matchProgress-R*b);return}const s=e[0],i=U(this.video.videoWidth||this.video.width,this.video.videoHeight||this.video.height),n=Q(s,i);this.lastExpression=n.id,this.lastFeatures=n.features,this.lastFace=s,n.id===this.target.id?this.matchProgress=Math.min(1,this.matchProgress+G*b):this.matchProgress=Math.max(0,this.matchProgress-R*b),this.matchProgress>=.999&&this.onSuccessMatch()}catch(e){console.error(e),this.status="Ë°®ÊÉÖ„ÅÆËß£Êûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éñ„É©„Ç¶„Ç∂„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"}finally{this.detecting=!1}}}onSuccessMatch(){this.score+=100+this.combo*20,this.combo+=1,this.bestCombo=Math.max(this.bestCombo,this.combo),this.timeLeft=A(this.timeLeft+K,0,120),this.matchProgress=0,this.status=`${this.target.label}„ÇØ„É™„Ç¢ÔºÅ +${K}Áßí`,this.pickNextTarget()}pickNextTarget(){const e=x.filter(i=>i.id!==this.target.id),s=Math.floor(Math.random()*e.length);this.target=e[s]}drawFaceOutline(e,s){if(!this.video||!this.lastFace)return;const i=this.lastFace.boundingBox,n=s.width/(this.video.videoWidth||this.video.width||s.width),a=s.height/(this.video.videoHeight||this.video.height||s.height),f=s.width-(i.x+i.width)*n,d=i.y*a,c=i.width*n,T=i.height*a;e.save(),e.strokeStyle="rgba(96, 165, 250, 0.85)",e.lineWidth=3,e.strokeRect(f,d,c,T),e.restore()}drawHud(e,s){var f;e.save(),e.fillStyle="rgba(15, 23, 42, 0.6)",e.fillRect(20,20,200,120),e.fillRect(s.width-240,20,220,160),e.fillStyle="#f8fafc",e.font='22px/1.3 "Noto Sans JP", system-ui, sans-serif',e.fillText("„Çø„Éº„Ç≤„ÉÉ„Éà",32,52),e.font='64px/1 "Segoe UI Emoji", system-ui',e.fillText(this.target.emoji,36,120),e.font='20px/1.2 "Noto Sans JP", system-ui, sans-serif',e.fillText(this.target.label,100,86),e.fillText(this.target.description,32,150),e.textAlign="right",e.font='24px/1.4 "Noto Sans JP", system-ui, sans-serif',e.fillText(`„Çπ„Ç≥„Ç¢: ${this.score}`,s.width-24,52),e.fillText(`„ÅÆ„Åì„ÇäÊôÇÈñì: ${Math.ceil(this.timeLeft)}s`,s.width-24,84),e.fillText(`„Ç≥„É≥„Éú: ${this.combo} („Éô„Çπ„Éà ${this.bestCombo})`,s.width-24,116),e.fillText(`Âà§ÂÆö: ${this.lastExpression==="unknown"?"---":((f=x.find(d=>d.id===this.lastExpression))==null?void 0:f.label)??"---"}`,s.width-24,148),e.textAlign="left";const i=s.width-80,n=40,a=s.height-60;if(e.fillStyle="rgba(15, 23, 42, 0.6)",e.fillRect(n,a,i,24),e.fillStyle="#34d399",e.fillRect(n,a,i*A(this.matchProgress,0,1),24),e.strokeStyle="rgba(248, 250, 252, 0.8)",e.lineWidth=2,e.strokeRect(n,a,i,24),e.fillStyle="#f8fafc",e.font='18px/1.2 "Noto Sans JP", system-ui, sans-serif',e.fillText("„Çø„Éº„Ç≤„ÉÉ„Éà„Å®‰∏ÄËá¥„Åô„Çã„Å®„Ç≤„Éº„Ç∏„ÅåÊ∫Ä„Çø„É≥„Å´„Å™„Çä„Åæ„Åô",n,a-8),this.lastFeatures){e.font='16px/1.2 "Noto Sans JP", system-ui, sans-serif';const d=this.lastFeatures;e.fillText(`mouthOpen: ${(d.mouthOpen*100).toFixed(1)}%`,32,s.height-120),e.fillText(`mouthCurve: ${(d.mouthCurve*100).toFixed(2)}%`,32,s.height-96),e.fillText(`eyeOpen: ${(d.eyeOpenness*100).toFixed(1)}%`,32,s.height-72)}e.restore()}drawStatus(e,s){if(!this.status)return;e.save(),e.fillStyle="rgba(15, 23, 42, 0.7)",e.fillRect(80,s.height/2-60,s.width-160,120),e.fillStyle="#f8fafc",e.textAlign="center",e.font='26px/1.4 "Noto Sans JP", system-ui, sans-serif',this.status.split(`
`).forEach((n,a)=>{e.fillText(n,s.width/2,s.height/2-10+a*30)}),e.textAlign="left",e.restore()}cleanupStream(){var e;(e=this.stream)==null||e.getTracks().forEach(s=>s.stop()),this.stream=null,this.video&&(this.video.srcObject=null,this.video=null)}}const S=document.getElementById("game-canvas");if(!S)throw new Error("„Ç≤„Éº„É†„Ç≠„É£„É≥„Éê„Çπ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì");const F=new q(S,{background:"#0f172a"});F.renderer.resize(U(S.width,S.height));F.setScene(new Z);F.start();
