var $=Object.defineProperty;var J=(h,t,e)=>t in h?$(h,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):h[t]=e;var r=(h,t,e)=>J(h,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function e(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=e(s);fetch(s.href,n)}})();class X{constructor(){r(this,"sounds",new Map);r(this,"muted",!1)}load(t,e){if(this.sounds.has(t))return;const i=new Audio(e);i.preload="auto",this.sounds.set(t,i)}play(t,e={}){const i=this.sounds.get(t);if(!i||this.muted)return;const s=i.cloneNode(!0);s.loop=e.loop??!1,s.volume=e.volume??1,s.play()}setMuted(t){this.muted=t}isMuted(){return this.muted}}const D=1e3/60,Y=5;class W{constructor(){r(this,"lastTick",performance.now());r(this,"accumulated",0);r(this,"running",!1);r(this,"subscribers",[]);r(this,"rafId",0);r(this,"loop",()=>{if(!this.running)return;const t=performance.now(),e=t-this.lastTick;this.lastTick=t,this.accumulated+=e;let i=0;for(;this.accumulated>=D&&i<Y;)this.accumulated-=D,this.subscribers.forEach(s=>s(D/1e3)),i+=1;this.rafId=requestAnimationFrame(this.loop)})}start(){this.running||(this.running=!0,this.lastTick=performance.now(),this.loop())}stop(){this.running=!1,cancelAnimationFrame(this.rafId)}subscribe(t){return this.subscribers.push(t),()=>{const e=this.subscribers.indexOf(t);e>=0&&this.subscribers.splice(e,1)}}}class V{constructor(t=window){r(this,"pressedKeys",new Set);r(this,"pointerPosition",{x:0,y:0});r(this,"listeners",[]);r(this,"keyDownListener",t=>this.handleKeyDown(t));r(this,"keyUpListener",t=>this.handleKeyUp(t));r(this,"pointerListener",t=>this.handlePointer(t));r(this,"handleKeyDown",t=>{this.pressedKeys.add(t.key.toLowerCase()),this.listeners.forEach(e=>e(t))});r(this,"handleKeyUp",t=>{this.pressedKeys.delete(t.key.toLowerCase()),this.listeners.forEach(e=>e(t))});r(this,"handlePointer",t=>{this.pointerPosition={x:t.clientX,y:t.clientY},this.listeners.forEach(e=>e(t))});this.target=t}attach(){this.addTargetListeners(this.target)}detach(){this.removeTargetListeners(this.target),this.pressedKeys.clear(),this.listeners=[]}addTargetListeners(t){if(t instanceof Window){t.addEventListener("keydown",this.keyDownListener,{passive:!0}),t.addEventListener("keyup",this.keyUpListener,{passive:!0}),t.addEventListener("pointerdown",this.pointerListener,{passive:!0}),t.addEventListener("pointerup",this.pointerListener,{passive:!0}),t.addEventListener("pointermove",this.pointerListener,{passive:!0});return}t.addEventListener("keydown",this.keyDownListener,{passive:!0}),t.addEventListener("keyup",this.keyUpListener,{passive:!0}),t.addEventListener("pointerdown",this.pointerListener,{passive:!0}),t.addEventListener("pointerup",this.pointerListener,{passive:!0}),t.addEventListener("pointermove",this.pointerListener,{passive:!0})}removeTargetListeners(t){if(t instanceof Window){t.removeEventListener("keydown",this.keyDownListener),t.removeEventListener("keyup",this.keyUpListener),t.removeEventListener("pointerdown",this.pointerListener),t.removeEventListener("pointerup",this.pointerListener),t.removeEventListener("pointermove",this.pointerListener);return}t.removeEventListener("keydown",this.keyDownListener),t.removeEventListener("keyup",this.keyUpListener),t.removeEventListener("pointerdown",this.pointerListener),t.removeEventListener("pointerup",this.pointerListener),t.removeEventListener("pointermove",this.pointerListener)}isKeyPressed(t){return this.pressedKeys.has(t.toLowerCase())}getPointerPosition(){return{...this.pointerPosition}}onInput(t){return this.listeners.push(t),()=>{this.listeners=this.listeners.filter(e=>e!==t)}}}class B{constructor(t){r(this,"context");r(this,"canvas");const e=t.getContext("2d");if(!e)throw new Error("Renderer requires 2D canvas context");this.canvas=t,this.context=e,this.context.imageSmoothingEnabled=!0}clear(t="#000000"){const e=this.context;e.save(),e.fillStyle=t,e.fillRect(0,0,this.canvas.width,this.canvas.height),e.restore()}drawSprite(t,e,i){this.context.drawImage(t,e.x,e.y,i.x,i.y)}drawRect(t,e,i){const s=this.context;s.save(),s.fillStyle=i,s.fillRect(t.x,t.y,e.x,e.y),s.restore()}drawText(t,e,i={}){const s=this.context;s.save(),s.fillStyle=i.color??"#ffffff",s.font=i.font??"16px sans-serif",s.textBaseline="top",s.fillText(t,e.x,e.y),s.restore()}resize(t){this.canvas.width=t.x,this.canvas.height=t.y}}class z{constructor(t,e={}){r(this,"audio",new X);r(this,"input");r(this,"renderer");r(this,"ticker",new W);r(this,"currentScene",null);r(this,"elapsedTime",0);r(this,"options");r(this,"update",t=>{var i,s;const e=this.createContext(t);this.options.background?this.renderer.clear(this.options.background):this.renderer.clear(),(i=this.currentScene)==null||i.update(t,e),(s=this.currentScene)==null||s.render(e),this.elapsedTime+=t});this.options=e,this.renderer=new B(t),this.input=new V(window),this.input.attach(),this.ticker.subscribe(this.update)}setScene(t){var e,i;(e=this.currentScene)!=null&&e.onExit&&this.currentScene.onExit(this.createContext()),this.currentScene=t,(i=this.currentScene)!=null&&i.onEnter&&this.currentScene.onEnter(this.createContext())}start(){this.elapsedTime=0,this.ticker.start()}stop(){this.ticker.stop()}dispose(){this.stop(),this.input.detach()}createContext(t=0){return{renderer:this.renderer,input:this.input,elapsedTime:this.elapsedTime+t}}}const j=(h=0,t=0)=>({x:h,y:t}),R=(h,t,e)=>Math.max(t,Math.min(e,h));class q{}const G=()=>globalThis.FaceDetector??null,Q={joy:{minSmile:.02,minMouthOpen:.1},anger:{maxEyeOpen:.16,maxMouthOpen:.12},sad:{minFrown:.02,maxMouthOpen:.14},surprise:{minMouthOpen:.22,minEyeOpen:.27}},O=[{id:"joy",emoji:"üòÄ",label:"„Çà„Çç„Åì„Å≥",description:"Âè£Ëßí„Çí‰∏ä„Åí„Å¶„Å´„Å£„Åì„Çä"},{id:"anger",emoji:"üò°",label:"„ÅÑ„Åã„Çä",description:"ÁõÆ„ÇíÁ¥∞„ÇÅ„Å¶„Ç≠„ÉÉ„Å®"},{id:"sad",emoji:"üò¢",label:"„Åã„Å™„Åó„ÅÑ",description:"Âè£Ëßí„Çí‰∏ã„Åí„Å¶„Åó„Çá„Çì„Åº„Çä"},{id:"surprise",emoji:"üò≤",label:"„Åä„Å©„Çç„Åç",description:"ÁõÆ„Å®Âè£„ÇíÂ§ß„Åç„ÅèÈñã„Åè"}],C=.2,Z=.5,U=.35,_=45,K=8,ee=(h,t,e)=>{var w;if(!((w=h.landmarks)!=null&&w.length))return{id:"unknown",features:null};const i=h.boundingBox,s=h.landmarks.filter(c=>c.type==="mouth").flatMap(c=>Array.from(c.locations)),n=h.landmarks.filter(c=>c.type==="eye").flatMap(c=>Array.from(c.locations));if(s.length<3||n.length<4)return{id:"unknown",features:null};const a=c=>c/i.height,f=c=>c/i.width,d=(()=>{const c=s.map(u=>u.x),L=s.map(u=>u.y),P=Math.min(...c),S=Math.max(...c),b=Math.min(...L),M=Math.max(...L),g=S-P,E=M-b,T=(M+b)/2,F=s.reduce((u,x)=>x.x<u.x?x:u,s[0]),A=s.reduce((u,x)=>x.x>u.x?x:u,s[0]),I=(F.y+A.y)/2-T;return{width:g/t.x,height:E/t.y,open:a(E),curve:a(I)}})(),v=(()=>{const c=i.x+i.width/2,L=n.filter(g=>g.x<=c),P=n.filter(g=>g.x>c),S=g=>{if(g.length<2)return 0;const E=g.map(u=>u.x),T=g.map(u=>u.y),F=Math.max(...E)-Math.min(...E),A=Math.max(...T)-Math.min(...T),N=f(F),I=a(A);return N<=0?0:I/N},b=S(L),M=S(P);return{openness:(b+M)/2}})(),o={mouthOpen:d.open,mouthCurve:d.curve,eyeOpenness:v.openness},m=-o.mouthCurve,y=o.mouthCurve,l=o.mouthOpen,p=o.eyeOpenness;return l>=e.surprise.minMouthOpen&&p>=e.surprise.minEyeOpen?{id:"surprise",features:o}:m>=e.joy.minSmile&&l>=e.joy.minMouthOpen?{id:"joy",features:o}:p<=e.anger.maxEyeOpen&&l<=e.anger.maxMouthOpen?{id:"anger",features:o}:y>=e.sad.minFrown&&l<=e.sad.maxMouthOpen?{id:"sad",features:o}:{id:"unknown",features:o}};class te extends q{constructor(){super(...arguments);r(this,"video",null);r(this,"stream",null);r(this,"detector",null);r(this,"detectionTimer",0);r(this,"detecting",!1);r(this,"timeLeft",_);r(this,"score",0);r(this,"combo",0);r(this,"bestCombo",0);r(this,"matchProgress",0);r(this,"target",O[0]);r(this,"lastExpression","unknown");r(this,"lastFeatures",null);r(this,"lastFace",null);r(this,"status",null);r(this,"gameOver",!1);r(this,"removeInputListener",null);r(this,"thresholds",JSON.parse(JSON.stringify(Q)));r(this,"controlsContainer",null)}async onEnter(e){if(this.resetState(),this.video=document.getElementById("camera-stream"),!this.video){this.status="„Éì„Éá„Ç™Ë¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì";return}try{this.stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user",width:640,height:480},audio:!1}),this.video.srcObject=this.stream,await this.video.play()}catch(n){this.status="„Ç´„É°„É©„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÊ®©Èôê„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",console.error(n);return}const i=G();if(!i){this.status="FaceDetector API „Å´ÂØæÂøú„Åó„Åü„Éñ„É©„Ç¶„Ç∂„ÅåÂøÖË¶Å„Åß„Åô (Chrome / Edge Êé®Â•®)„ÄÇ";return}this.detector=new i({maxDetectedFaces:1,fastMode:!0});const s=e.input;this.removeInputListener=s.onInput(n=>this.handleInput(n)),this.pickNextTarget()}onExit(){var e;this.cleanupStream(),(e=this.removeInputListener)==null||e.call(this),this.removeInputListener=null,this.destroyControls()}update(e){if(!this.gameOver){if(this.timeLeft=R(this.timeLeft-e,0,999),this.timeLeft<=0){this.gameOver=!0,this.status="ÊôÇÈñìÂàá„ÇåÔºÅ„Çπ„Éö„Éº„Çπ„Åã„ÇØ„É™„ÉÉ„ÇØ„ÅßÂÜç„Çπ„Çø„Éº„Éà";return}!this.detector||!this.video||this.video.readyState<HTMLMediaElement.HAVE_ENOUGH_DATA||(this.detectionTimer-=e,this.detectionTimer<=0&&!this.detecting&&(this.detectionTimer=C,this.detectExpression()))}}render(e){const i=e.renderer,s=i.context,n=i.canvas;s.save(),s.fillStyle="#0f172a",s.fillRect(0,0,n.width,n.height),s.restore(),this.video&&this.video.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA&&(s.save(),s.translate(n.width,0),s.scale(-1,1),s.drawImage(this.video,0,0,n.width,n.height),s.restore()),this.lastFace&&this.drawFaceOutline(s,n),this.drawHud(s,n),this.drawStatus(s,n)}resetState(){this.timeLeft=_,this.score=0,this.combo=0,this.bestCombo=0,this.matchProgress=0,this.target=O[0],this.lastExpression="unknown",this.lastFeatures=null,this.lastFace=null,this.status=null,this.gameOver=!1,this.detectionTimer=0,this.controlsContainer||this.initializeControls()}handleInput(e){if(e instanceof PointerEvent&&e.type==="pointerdown"){this.gameOver&&(this.resetState(),this.pickNextTarget());return}if(!(e instanceof KeyboardEvent)||e.type!=="keydown")return;const i=e.key.toLowerCase();(i===" "||i==="enter")&&this.gameOver&&(this.resetState(),this.pickNextTarget())}async detectExpression(){if(!(!this.detector||!this.video)){this.detecting=!0;try{const e=await this.detector.detect(this.video);if(e.length===0){this.lastFace=null,this.lastExpression="unknown",this.lastFeatures=null,this.matchProgress=Math.max(0,this.matchProgress-U*C);return}const i=e[0],s=j(this.video.videoWidth||this.video.width,this.video.videoHeight||this.video.height),n=ee(i,s,this.thresholds);this.lastExpression=n.id,this.lastFeatures=n.features,this.lastFace=i,n.id===this.target.id?this.matchProgress=Math.min(1,this.matchProgress+Z*C):this.matchProgress=Math.max(0,this.matchProgress-U*C),this.matchProgress>=.999&&this.onSuccessMatch()}catch(e){console.error(e),this.status="Ë°®ÊÉÖ„ÅÆËß£Êûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éñ„É©„Ç¶„Ç∂„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"}finally{this.detecting=!1}}}onSuccessMatch(){this.score+=100+this.combo*20,this.combo+=1,this.bestCombo=Math.max(this.bestCombo,this.combo),this.timeLeft=R(this.timeLeft+K,0,120),this.matchProgress=0,this.status=`${this.target.label}„ÇØ„É™„Ç¢ÔºÅ +${K}Áßí`,this.pickNextTarget()}pickNextTarget(){const e=O.filter(s=>s.id!==this.target.id),i=Math.floor(Math.random()*e.length);this.target=e[i]}drawFaceOutline(e,i){if(!this.video||!this.lastFace)return;const s=this.lastFace.boundingBox,n=i.width/(this.video.videoWidth||this.video.width||i.width),a=i.height/(this.video.videoHeight||this.video.height||i.height),f=i.width-(s.x+s.width)*n,d=s.y*a,v=s.width*n,o=s.height*a;e.save(),e.strokeStyle="rgba(96, 165, 250, 0.85)",e.lineWidth=3,e.strokeRect(f,d,v,o),e.restore(),this.drawLandmarks(e,i,n,a)}drawHud(e,i){var f;e.save(),e.fillStyle="rgba(15, 23, 42, 0.6)",e.fillRect(20,20,200,120),e.fillRect(i.width-240,20,220,160),e.fillStyle="#f8fafc",e.font='22px/1.3 "Noto Sans JP", system-ui, sans-serif',e.fillText("„Çø„Éº„Ç≤„ÉÉ„Éà",32,52),e.font='64px/1 "Segoe UI Emoji", system-ui',e.fillText(this.target.emoji,36,120),e.font='20px/1.2 "Noto Sans JP", system-ui, sans-serif',e.fillText(this.target.label,100,86),e.fillText(this.target.description,32,150),e.textAlign="right",e.font='24px/1.4 "Noto Sans JP", system-ui, sans-serif',e.fillText(`„Çπ„Ç≥„Ç¢: ${this.score}`,i.width-24,52),e.fillText(`„ÅÆ„Åì„ÇäÊôÇÈñì: ${Math.ceil(this.timeLeft)}s`,i.width-24,84),e.fillText(`„Ç≥„É≥„Éú: ${this.combo} („Éô„Çπ„Éà ${this.bestCombo})`,i.width-24,116),e.fillText(`Âà§ÂÆö: ${this.lastExpression==="unknown"?"---":((f=O.find(d=>d.id===this.lastExpression))==null?void 0:f.label)??"---"}`,i.width-24,148),e.textAlign="left";const s=i.width-80,n=40,a=i.height-60;if(e.fillStyle="rgba(15, 23, 42, 0.6)",e.fillRect(n,a,s,24),e.fillStyle="#34d399",e.fillRect(n,a,s*R(this.matchProgress,0,1),24),e.strokeStyle="rgba(248, 250, 252, 0.8)",e.lineWidth=2,e.strokeRect(n,a,s,24),e.fillStyle="#f8fafc",e.font='18px/1.2 "Noto Sans JP", system-ui, sans-serif',e.fillText("„Çø„Éº„Ç≤„ÉÉ„Éà„Å®‰∏ÄËá¥„Åô„Çã„Å®„Ç≤„Éº„Ç∏„ÅåÊ∫Ä„Çø„É≥„Å´„Å™„Çä„Åæ„Åô",n,a-8),this.lastFeatures){e.font='16px/1.2 "Noto Sans JP", system-ui, sans-serif';const d=this.lastFeatures;e.fillText(`mouthOpen: ${(d.mouthOpen*100).toFixed(1)}%`,32,i.height-120),e.fillText(`mouthCurve: ${(d.mouthCurve*100).toFixed(2)}%`,32,i.height-96),e.fillText(`eyeOpen: ${(d.eyeOpenness*100).toFixed(1)}%`,32,i.height-72)}e.restore()}drawStatus(e,i){if(!this.status)return;e.save(),e.fillStyle="rgba(15, 23, 42, 0.7)",e.fillRect(80,i.height/2-60,i.width-160,120),e.fillStyle="#f8fafc",e.textAlign="center",e.font='26px/1.4 "Noto Sans JP", system-ui, sans-serif',this.status.split(`
`).forEach((n,a)=>{e.fillText(n,i.width/2,i.height/2-10+a*30)}),e.textAlign="left",e.restore()}cleanupStream(){var e;(e=this.stream)==null||e.getTracks().forEach(i=>i.stop()),this.stream=null,this.video&&(this.video.srcObject=null,this.video=null)}drawLandmarks(e,i,s,n){const a=this.lastFace,f=this.video;if(!a||!f||!a.landmarks)return;const d=o=>{const m=i.width-o.x*s,y=o.y*n;return j(m,y)},v=(o,m)=>{e.beginPath(),e.fillStyle=m,e.arc(o.x,o.y,3,0,Math.PI*2),e.fill()};a.landmarks.forEach(o=>{const m=o.locations??[];if(m.length===0)return;const y=o.type==="mouth"?"#f97316":o.type==="eye"?"#38bdf8":"#facc15",l=m.map(d);e.save(),e.strokeStyle=y,e.lineWidth=2,e.beginPath(),e.moveTo(l[0].x,l[0].y);for(let p=1;p<l.length;p+=1)e.lineTo(l[p].x,l[p].y);(o.type==="mouth"||o.type==="eye")&&e.closePath(),e.stroke(),e.restore(),l.forEach(p=>v(p,y))})}initializeControls(){this.destroyControls();const e=document.createElement("div");e.className="threshold-panel";const i=document.createElement("h2");i.textContent="Expression Thresholds",e.appendChild(i),[{label:"Joy: Min Smile Curve (%)",path:["joy","minSmile"],min:0,max:.1,step:.005},{label:"Joy: Min Mouth Open (%)",path:["joy","minMouthOpen"],min:0,max:.3,step:.01},{label:"Anger: Max Eye Open (%)",path:["anger","maxEyeOpen"],min:0,max:.4,step:.01},{label:"Anger: Max Mouth Open (%)",path:["anger","maxMouthOpen"],min:0,max:.3,step:.01},{label:"Sad: Min Frown Curve (%)",path:["sad","minFrown"],min:0,max:.1,step:.005},{label:"Sad: Max Mouth Open (%)",path:["sad","maxMouthOpen"],min:0,max:.3,step:.01},{label:"Surprise: Min Mouth Open (%)",path:["surprise","minMouthOpen"],min:0,max:.5,step:.01},{label:"Surprise: Min Eye Open (%)",path:["surprise","minEyeOpen"],min:0,max:.5,step:.01}].forEach(({label:n,path:a,min:f,max:d,step:v})=>{const o=document.createElement("label");o.className="threshold-item";const m=document.createElement("span");m.textContent=n;const y=document.createElement("code");y.className="threshold-value";const l=document.createElement("input");l.type="range",l.min=String(f),l.max=String(d),l.step=String(v),l.value=String(this.getThresholdValue(a));const p=w=>{this.setThresholdValue(a,w),y.textContent=`${(w*100).toFixed(1)}%`};l.addEventListener("input",()=>{p(Number.parseFloat(l.value))}),p(Number.parseFloat(l.value)),o.appendChild(m),o.appendChild(l),o.appendChild(y),e.appendChild(o)}),document.body.appendChild(e),this.controlsContainer=e}destroyControls(){var e;(e=this.controlsContainer)!=null&&e.parentNode&&this.controlsContainer.parentNode.removeChild(this.controlsContainer),this.controlsContainer=null}getThresholdValue(e){const[i,s]=e;return this.thresholds[i][s]}setThresholdValue(e,i){const[s,n]=e;this.thresholds[s][n]=i}}const k=document.getElementById("game-canvas");if(!k)throw new Error("„Ç≤„Éº„É†„Ç≠„É£„É≥„Éê„Çπ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì");const H=new z(k,{background:"#0f172a"});H.renderer.resize(j(k.width,k.height));H.setScene(new te);H.start();
