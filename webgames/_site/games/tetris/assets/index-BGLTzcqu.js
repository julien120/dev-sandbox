var O=Object.defineProperty;var N=(c,s,e)=>s in c?O(c,s,{enumerable:!0,configurable:!0,writable:!0,value:e}):c[s]=e;var n=(c,s,e)=>N(c,typeof s!="symbol"?s+"":s,e);(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))t(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&t(a)}).observe(document,{childList:!0,subtree:!0});function e(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function t(i){if(i.ep)return;i.ep=!0;const r=e(i);fetch(i.href,r)}})();class C{constructor(){n(this,"sounds",new Map);n(this,"muted",!1)}load(s,e){if(this.sounds.has(s))return;const t=new Audio(e);t.preload="auto",this.sounds.set(s,t)}play(s,e={}){const t=this.sounds.get(s);if(!t||this.muted)return;const i=t.cloneNode(!0);i.loop=e.loop??!1,i.volume=e.volume??1,i.play()}setMuted(s){this.muted=s}isMuted(){return this.muted}}const P=1e3/60,R=5;class B{constructor(){n(this,"lastTick",performance.now());n(this,"accumulated",0);n(this,"running",!1);n(this,"subscribers",[]);n(this,"rafId",0);n(this,"loop",()=>{if(!this.running)return;const s=performance.now(),e=s-this.lastTick;this.lastTick=s,this.accumulated+=e;let t=0;for(;this.accumulated>=P&&t<R;)this.accumulated-=P,this.subscribers.forEach(i=>i(P/1e3)),t+=1;this.rafId=requestAnimationFrame(this.loop)})}start(){this.running||(this.running=!0,this.lastTick=performance.now(),this.loop())}stop(){this.running=!1,cancelAnimationFrame(this.rafId)}subscribe(s){return this.subscribers.push(s),()=>{const e=this.subscribers.indexOf(s);e>=0&&this.subscribers.splice(e,1)}}}class M{constructor(s=window){n(this,"pressedKeys",new Set);n(this,"pointerPosition",{x:0,y:0});n(this,"listeners",[]);n(this,"keyDownListener",s=>this.handleKeyDown(s));n(this,"keyUpListener",s=>this.handleKeyUp(s));n(this,"pointerListener",s=>this.handlePointer(s));n(this,"handleKeyDown",s=>{this.pressedKeys.add(s.key.toLowerCase()),this.listeners.forEach(e=>e(s))});n(this,"handleKeyUp",s=>{this.pressedKeys.delete(s.key.toLowerCase()),this.listeners.forEach(e=>e(s))});n(this,"handlePointer",s=>{this.pointerPosition={x:s.clientX,y:s.clientY},this.listeners.forEach(e=>e(s))});this.target=s}attach(){this.addTargetListeners(this.target)}detach(){this.removeTargetListeners(this.target),this.pressedKeys.clear(),this.listeners=[]}addTargetListeners(s){if(s instanceof Window){s.addEventListener("keydown",this.keyDownListener,{passive:!0}),s.addEventListener("keyup",this.keyUpListener,{passive:!0}),s.addEventListener("pointerdown",this.pointerListener,{passive:!0}),s.addEventListener("pointerup",this.pointerListener,{passive:!0}),s.addEventListener("pointermove",this.pointerListener,{passive:!0});return}s.addEventListener("keydown",this.keyDownListener,{passive:!0}),s.addEventListener("keyup",this.keyUpListener,{passive:!0}),s.addEventListener("pointerdown",this.pointerListener,{passive:!0}),s.addEventListener("pointerup",this.pointerListener,{passive:!0}),s.addEventListener("pointermove",this.pointerListener,{passive:!0})}removeTargetListeners(s){if(s instanceof Window){s.removeEventListener("keydown",this.keyDownListener),s.removeEventListener("keyup",this.keyUpListener),s.removeEventListener("pointerdown",this.pointerListener),s.removeEventListener("pointerup",this.pointerListener),s.removeEventListener("pointermove",this.pointerListener);return}s.removeEventListener("keydown",this.keyDownListener),s.removeEventListener("keyup",this.keyUpListener),s.removeEventListener("pointerdown",this.pointerListener),s.removeEventListener("pointerup",this.pointerListener),s.removeEventListener("pointermove",this.pointerListener)}isKeyPressed(s){return this.pressedKeys.has(s.toLowerCase())}getPointerPosition(){return{...this.pointerPosition}}onInput(s){return this.listeners.push(s),()=>{this.listeners=this.listeners.filter(e=>e!==s)}}}class D{constructor(s){n(this,"context");n(this,"canvas");const e=s.getContext("2d");if(!e)throw new Error("Renderer requires 2D canvas context");this.canvas=s,this.context=e,this.context.imageSmoothingEnabled=!0}clear(s="#000000"){const e=this.context;e.save(),e.fillStyle=s,e.fillRect(0,0,this.canvas.width,this.canvas.height),e.restore()}drawSprite(s,e,t){this.context.drawImage(s,e.x,e.y,t.x,t.y)}drawRect(s,e,t){const i=this.context;i.save(),i.fillStyle=t,i.fillRect(s.x,s.y,e.x,e.y),i.restore()}drawText(s,e,t={}){const i=this.context;i.save(),i.fillStyle=t.color??"#ffffff",i.font=t.font??"16px sans-serif",i.textBaseline="top",i.fillText(s,e.x,e.y),i.restore()}resize(s){this.canvas.width=s.x,this.canvas.height=s.y}}class K{constructor(s,e={}){n(this,"audio",new C);n(this,"input");n(this,"renderer");n(this,"ticker",new B);n(this,"currentScene",null);n(this,"elapsedTime",0);n(this,"options");n(this,"update",s=>{var t,i;const e=this.createContext(s);this.options.background?this.renderer.clear(this.options.background):this.renderer.clear(),(t=this.currentScene)==null||t.update(s,e),(i=this.currentScene)==null||i.render(e),this.elapsedTime+=s});this.options=e,this.renderer=new D(s),this.input=new M(window),this.input.attach(),this.ticker.subscribe(this.update)}setScene(s){var e,t;(e=this.currentScene)!=null&&e.onExit&&this.currentScene.onExit(this.createContext()),this.currentScene=s,(t=this.currentScene)!=null&&t.onEnter&&this.currentScene.onEnter(this.createContext())}start(){this.elapsedTime=0,this.ticker.start()}stop(){this.ticker.stop()}dispose(){this.stop(),this.input.detach()}createContext(s=0){return{renderer:this.renderer,input:this.input,elapsedTime:this.elapsedTime+s}}}const o=(c=0,s=0)=>({x:c,y:s});class A{}function J(c){return Math.floor(Math.random()*c)}const u=10,p=20,h=28,l=o(72,40),f=88,w=18,Q=[{name:"I",color:"#38bdf8",rotations:[[{x:0,y:1},{x:1,y:1},{x:2,y:1},{x:3,y:1}],[{x:2,y:0},{x:2,y:1},{x:2,y:2},{x:2,y:3}],[{x:0,y:2},{x:1,y:2},{x:2,y:2},{x:3,y:2}],[{x:1,y:0},{x:1,y:1},{x:1,y:2},{x:1,y:3}]]},{name:"J",color:"#60a5fa",rotations:[[{x:0,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1}],[{x:1,y:0},{x:2,y:0},{x:1,y:1},{x:1,y:2}],[{x:0,y:1},{x:1,y:1},{x:2,y:1},{x:2,y:2}],[{x:1,y:0},{x:1,y:1},{x:0,y:2},{x:1,y:2}]]},{name:"L",color:"#f97316",rotations:[[{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1}],[{x:1,y:0},{x:1,y:1},{x:1,y:2},{x:2,y:2}],[{x:0,y:1},{x:1,y:1},{x:2,y:1},{x:0,y:2}],[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:1,y:2}]]},{name:"O",color:"#facc15",rotations:[[{x:1,y:0},{x:2,y:0},{x:1,y:1},{x:2,y:1}],[{x:1,y:0},{x:2,y:0},{x:1,y:1},{x:2,y:1}],[{x:1,y:0},{x:2,y:0},{x:1,y:1},{x:2,y:1}],[{x:1,y:0},{x:2,y:0},{x:1,y:1},{x:2,y:1}]]},{name:"S",color:"#4ade80",rotations:[[{x:1,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1}],[{x:1,y:0},{x:1,y:1},{x:2,y:1},{x:2,y:2}],[{x:1,y:1},{x:2,y:1},{x:0,y:2},{x:1,y:2}],[{x:0,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2}]]},{name:"T",color:"#c084fc",rotations:[[{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1}],[{x:1,y:0},{x:1,y:1},{x:2,y:1},{x:1,y:2}],[{x:0,y:1},{x:1,y:1},{x:2,y:1},{x:1,y:2}],[{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:1,y:2}]]},{name:"Z",color:"#f472b6",rotations:[[{x:0,y:0},{x:1,y:0},{x:1,y:1},{x:2,y:1}],[{x:2,y:0},{x:1,y:1},{x:2,y:1},{x:1,y:2}],[{x:0,y:1},{x:1,y:1},{x:1,y:2},{x:2,y:2}],[{x:1,y:0},{x:0,y:1},{x:1,y:1},{x:0,y:2}]]}];class G extends A{constructor(){super(...arguments);n(this,"board",this.createEmptyBoard());n(this,"activePiece",null);n(this,"nextQueue",[]);n(this,"bag",[]);n(this,"dropTimer",0);n(this,"score",0);n(this,"level",1);n(this,"totalClearedLines",0);n(this,"gameOver",!1);n(this,"inputDisposer",null)}onEnter(e){this.inputDisposer=e.input.onInput(t=>this.handleInput(t)),this.reset()}onExit(){var e;(e=this.inputDisposer)==null||e.call(this)}update(e,t){if(this.gameOver||!this.activePiece&&(this.spawnNextPiece(),!this.activePiece))return;this.dropTimer+=e;const i=t.input.isKeyPressed("arrowdown")||t.input.isKeyPressed("s"),r=i?Math.max(.05,this.getDropInterval()*.2):this.getDropInterval();for(;this.dropTimer>=r;)if(this.dropTimer-=r,this.movePiece(0,1))i&&(this.score+=1);else{this.lockPiece();break}}render(e){const t=e.renderer;this.drawBoardBackground(t),this.drawBoardGrid(t),this.drawSettledBlocks(t),this.activePiece&&!this.gameOver&&this.drawGhost(t,this.activePiece),this.activePiece&&this.drawActivePiece(t,this.activePiece),this.drawSidePanel(t),this.drawInstructions(t),this.gameOver&&this.drawGameOver(t)}reset(){this.board=this.createEmptyBoard(),this.nextQueue=[],this.bag=[],this.activePiece=null,this.dropTimer=0,this.score=0,this.level=1,this.totalClearedLines=0,this.gameOver=!1,this.spawnNextPiece()}handleInput(e){if(!(e instanceof KeyboardEvent)||e.type!=="keydown")return;const t=e.key.toLowerCase();if(["arrowleft","arrowright","arrowup","arrowdown"," ","z","x","w","a","s","d","enter","r"].includes(t)&&e.preventDefault(),this.gameOver){(t==="enter"||t===" ")&&!e.repeat&&this.reset(),t==="r"&&!e.repeat&&this.reset();return}switch(t){case"arrowleft":case"a":this.movePiece(-1,0);break;case"arrowright":case"d":this.movePiece(1,0);break;case"arrowdown":case"s":{this.movePiece(0,1)&&(this.score+=1);break}case"arrowup":case"w":case"x":e.repeat||this.rotatePiece(1);break;case"z":e.repeat||this.rotatePiece(-1);break;case" ":e.repeat||this.hardDrop();break;case"r":e.repeat||this.reset();break}}spawnNextPiece(){this.ensureQueue();const e=this.nextQueue.shift();if(!e)return;const t={x:Math.floor(u/2)-2,y:-2};this.activePiece={shape:e,rotation:0,position:t},this.dropTimer=0,this.canPlace(e,0,t)||(this.gameOver=!0,this.activePiece=null)}ensureQueue(){for(;this.nextQueue.length<5;){this.bag.length===0&&this.refillBag();const e=this.bag.pop();e&&this.nextQueue.push(e)}}refillBag(){this.bag=[...Q];for(let e=this.bag.length-1;e>0;e-=1){const t=J(e+1);[this.bag[e],this.bag[t]]=[this.bag[t],this.bag[e]]}}movePiece(e,t){if(!this.activePiece)return!1;const i={x:this.activePiece.position.x+e,y:this.activePiece.position.y+t};return this.canPlace(this.activePiece.shape,this.activePiece.rotation,i)?(this.activePiece.position=i,t!==0&&(this.dropTimer=0),!0):!1}rotatePiece(e){if(!this.activePiece)return;const t=this.activePiece.shape,i=t.rotations.length,r=(this.activePiece.rotation+e+i)%i,a=t.name==="I"?[{x:0,y:0},{x:1,y:0},{x:-1,y:0},{x:2,y:0},{x:-2,y:0},{x:0,y:-1},{x:1,y:-1},{x:-1,y:-1}]:[{x:0,y:0},{x:1,y:0},{x:-1,y:0},{x:0,y:-1},{x:1,y:-1},{x:-1,y:-1}];for(const x of a){const d={x:this.activePiece.position.x+x.x,y:this.activePiece.position.y+x.y};if(this.canPlace(t,r,d)){this.activePiece.rotation=r,this.activePiece.position=d,this.dropTimer=0;return}}}hardDrop(){if(!this.activePiece)return;let e=0;for(;this.activePiece&&this.movePiece(0,1);)e+=1;e>0&&(this.score+=e*2),this.lockPiece()}lockPiece(){if(!this.activePiece)return;const e=this.getCells(this.activePiece.shape,this.activePiece.rotation,this.activePiece.position);let t=!1;for(const r of e){if(r.y<0){t=!0;continue}if(r.y>=p||r.x<0||r.x>=u){t=!0;continue}this.board[r.y][r.x]=this.activePiece.shape.color}const i=this.clearLines();if(i>0){const r=[0,100,300,500,800];this.score+=r[i]*this.level,this.totalClearedLines+=i,this.level=1+Math.floor(this.totalClearedLines/10)}if(this.activePiece=null,t){this.gameOver=!0;return}this.spawnNextPiece()}clearLines(){let e=0;for(let t=p-1;t>=0;)this.board[t].every(i=>i!==null)?(this.board.splice(t,1),this.board.unshift(Array.from({length:u},()=>null)),e+=1):t-=1;return e}canPlace(e,t,i){return this.getCells(e,t,i).every(a=>a.x<0||a.x>=u||a.y>=p?!1:a.y<0?!0:this.board[a.y][a.x]===null)}getCells(e,t,i){return e.rotations[t%e.rotations.length].map(a=>({x:a.x+i.x,y:a.y+i.y}))}getDropInterval(){return Math.max(.1,.8-(this.level-1)*.06)}createEmptyBoard(){return Array.from({length:p},()=>Array(u).fill(null))}drawBoardBackground(e){const t=o(l.x-12,l.y-12),i=o(u*h+24,p*h+24);e.drawRect(t,i,"rgba(15, 23, 42, 0.7)")}drawBoardGrid(e){for(let t=0;t<p;t+=1)for(let i=0;i<u;i+=1){const r=o(l.x+i*h,l.y+t*h);e.drawRect(r,o(h,h),"rgba(30, 41, 59, 0.35)")}}drawSettledBlocks(e){for(let t=0;t<p;t+=1)for(let i=0;i<u;i+=1){const r=this.board[t][i];if(!r)continue;const a=o(l.x+i*h,l.y+t*h);this.drawBlock(e,a,h,r)}}drawActivePiece(e,t){const i=this.getCells(t.shape,t.rotation,t.position);for(const r of i){if(r.y<0)continue;const a=o(l.x+r.x*h,l.y+r.y*h);this.drawBlock(e,a,h,t.shape.color)}}drawGhost(e,t){const i={...t.position};for(;this.canPlace(t.shape,t.rotation,{x:i.x,y:i.y+1});)i.y+=1;const r=this.getCells(t.shape,t.rotation,i);for(const a of r){if(a.y<0)continue;const x=o(l.x+a.x*h,l.y+a.y*h);e.drawRect(x,o(h,h),"rgba(148, 163, 184, 0.24)")}}drawSidePanel(e){const t=l.x+u*h+16,i=l.y;e.drawText("SCORE",o(t,i),{font:'16px/1.2 "Noto Sans JP", sans-serif',color:"#94a3b8"}),e.drawText(this.score.toString().padStart(6,"0"),o(t,i+20),{font:'24px/1.2 "Noto Sans JP", sans-serif',color:"#e2e8f0"}),e.drawText("LEVEL",o(t,i+60),{font:'16px/1.2 "Noto Sans JP", sans-serif',color:"#94a3b8"}),e.drawText(this.level.toString(),o(t,i+80),{font:'22px/1.2 "Noto Sans JP", sans-serif',color:"#e2e8f0"}),e.drawText("LINES",o(t,i+112),{font:'16px/1.2 "Noto Sans JP", sans-serif',color:"#94a3b8"}),e.drawText(this.totalClearedLines.toString(),o(t,i+132),{font:'22px/1.2 "Noto Sans JP", sans-serif',color:"#e2e8f0"}),e.drawText("NEXT",o(t,i+172),{font:'16px/1.2 "Noto Sans JP", sans-serif',color:"#94a3b8"}),this.drawNextQueue(e,o(t,i+192))}drawNextQueue(e,t){const i=Math.min(3,this.nextQueue.length);for(let r=0;r<i;r+=1){const a=this.nextQueue[r],x=t.y+r*(f+12),d=o(t.x-4,x-4);e.drawRect(d,o(f+8,f+8),"rgba(30, 41, 59, 0.55)"),this.drawPreview(e,a,o(t.x,x))}}drawPreview(e,t,i){const r=t.rotations[0],a=Math.min(...r.map(y=>y.x)),x=Math.max(...r.map(y=>y.x)),d=Math.min(...r.map(y=>y.y)),m=Math.max(...r.map(y=>y.y)),b=x-a+1,E=m-d+1,S=i.x+(f-b*w)/2,k=i.y+(f-E*w)/2;for(const y of r){const T=S+(y.x-a)*w,I=k+(y.y-d)*w;this.drawBlock(e,o(T,I),w,t.color)}}drawInstructions(e){const t=l.y+p*h+12;e.drawText("← →: 移動   ↓: ソフトドロップ   Space: ハードドロップ",o(l.x,t),{font:'16px/1.3 "Noto Sans JP", sans-serif',color:"#cbd5f5"}),e.drawText("Z: 左回転   ↑ / X: 右回転   Enter / R: リスタート",o(l.x,t+20),{font:'16px/1.3 "Noto Sans JP", sans-serif',color:"#cbd5f5"})}drawGameOver(e){const t=o(l.x+12,l.y+180),i=o(u*h-24,160);e.drawRect(t,i,"rgba(2, 6, 23, 0.88)"),e.drawText("GAME OVER",o(t.x+16,t.y+24),{font:'32px/1.3 "Noto Sans JP", sans-serif',color:"#f97316"}),e.drawText("Enter / Space / R で再スタート",o(t.x+16,t.y+72),{font:'18px/1.5 "Noto Sans JP", sans-serif',color:"#f8fafc"}),e.drawText(`スコア: ${this.score.toString()}`,o(t.x+16,t.y+104),{font:'18px/1.5 "Noto Sans JP", sans-serif',color:"#e2e8f0"})}drawBlock(e,t,i,r){e.drawRect(t,o(i,i),r);const a=L(r,45),x=Math.max(4,i-6);e.drawRect(o(t.x+3,t.y+3),o(x,x),a);const d=L(r,-40);e.drawRect(o(t.x+3,t.y+i-5),o(x,2),d)}}function L(c,s){const e=c.startsWith("#")?c.slice(1):c;if(e.length!==6)return c;const t=Number.parseInt(e,16),i=m=>Math.max(0,Math.min(255,m)),r=i((t>>16)+s),a=i((t>>8&255)+s),x=i((t&255)+s);return`#${(r<<16|a<<8|x).toString(16).padStart(6,"0")}`}const v=document.getElementById("game-canvas");if(!v)throw new Error("ゲームキャンバスが見つかりません");const g=new K(v,{background:"#020617"});g.renderer.resize(o(v.width,v.height));g.setScene(new G);g.start();
