var R=Object.defineProperty;var O=(a,s,t)=>s in a?R(a,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[s]=t;var r=(a,s,t)=>O(a,typeof s!="symbol"?s+"":s,t);(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))i(e);new MutationObserver(e=>{for(const n of e)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function t(e){const n={};return e.integrity&&(n.integrity=e.integrity),e.referrerPolicy&&(n.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?n.credentials="include":e.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(e){if(e.ep)return;e.ep=!0;const n=t(e);fetch(e.href,n)}})();class A{constructor(){r(this,"sounds",new Map);r(this,"muted",!1)}load(s,t){if(this.sounds.has(s))return;const i=new Audio(t);i.preload="auto",this.sounds.set(s,i)}play(s,t={}){const i=this.sounds.get(s);if(!i||this.muted)return;const e=i.cloneNode(!0);e.loop=t.loop??!1,e.volume=t.volume??1,e.play()}setMuted(s){this.muted=s}isMuted(){return this.muted}}const T=1e3/60,D=5;class B{constructor(){r(this,"lastTick",performance.now());r(this,"accumulated",0);r(this,"running",!1);r(this,"subscribers",[]);r(this,"rafId",0);r(this,"loop",()=>{if(!this.running)return;const s=performance.now(),t=s-this.lastTick;this.lastTick=s,this.accumulated+=t;let i=0;for(;this.accumulated>=T&&i<D;)this.accumulated-=T,this.subscribers.forEach(e=>e(T/1e3)),i+=1;this.rafId=requestAnimationFrame(this.loop)})}start(){this.running||(this.running=!0,this.lastTick=performance.now(),this.loop())}stop(){this.running=!1,cancelAnimationFrame(this.rafId)}subscribe(s){return this.subscribers.push(s),()=>{const t=this.subscribers.indexOf(s);t>=0&&this.subscribers.splice(t,1)}}}class N{constructor(s=window){r(this,"pressedKeys",new Set);r(this,"pointerPosition",{x:0,y:0});r(this,"listeners",[]);r(this,"keyDownListener",s=>this.handleKeyDown(s));r(this,"keyUpListener",s=>this.handleKeyUp(s));r(this,"pointerListener",s=>this.handlePointer(s));r(this,"handleKeyDown",s=>{this.pressedKeys.add(s.key.toLowerCase()),this.listeners.forEach(t=>t(s))});r(this,"handleKeyUp",s=>{this.pressedKeys.delete(s.key.toLowerCase()),this.listeners.forEach(t=>t(s))});r(this,"handlePointer",s=>{this.pointerPosition={x:s.clientX,y:s.clientY},this.listeners.forEach(t=>t(s))});this.target=s}attach(){this.addTargetListeners(this.target)}detach(){this.removeTargetListeners(this.target),this.pressedKeys.clear(),this.listeners=[]}addTargetListeners(s){if(s instanceof Window){s.addEventListener("keydown",this.keyDownListener,{passive:!0}),s.addEventListener("keyup",this.keyUpListener,{passive:!0}),s.addEventListener("pointerdown",this.pointerListener,{passive:!0}),s.addEventListener("pointerup",this.pointerListener,{passive:!0}),s.addEventListener("pointermove",this.pointerListener,{passive:!0});return}s.addEventListener("keydown",this.keyDownListener,{passive:!0}),s.addEventListener("keyup",this.keyUpListener,{passive:!0}),s.addEventListener("pointerdown",this.pointerListener,{passive:!0}),s.addEventListener("pointerup",this.pointerListener,{passive:!0}),s.addEventListener("pointermove",this.pointerListener,{passive:!0})}removeTargetListeners(s){if(s instanceof Window){s.removeEventListener("keydown",this.keyDownListener),s.removeEventListener("keyup",this.keyUpListener),s.removeEventListener("pointerdown",this.pointerListener),s.removeEventListener("pointerup",this.pointerListener),s.removeEventListener("pointermove",this.pointerListener);return}s.removeEventListener("keydown",this.keyDownListener),s.removeEventListener("keyup",this.keyUpListener),s.removeEventListener("pointerdown",this.pointerListener),s.removeEventListener("pointerup",this.pointerListener),s.removeEventListener("pointermove",this.pointerListener)}isKeyPressed(s){return this.pressedKeys.has(s.toLowerCase())}getPointerPosition(){return{...this.pointerPosition}}onInput(s){return this.listeners.push(s),()=>{this.listeners=this.listeners.filter(t=>t!==s)}}}class _{constructor(s){r(this,"context");r(this,"canvas");const t=s.getContext("2d");if(!t)throw new Error("Renderer requires 2D canvas context");this.canvas=s,this.context=t,this.context.imageSmoothingEnabled=!0}clear(s="#000000"){const t=this.context;t.save(),t.fillStyle=s,t.fillRect(0,0,this.canvas.width,this.canvas.height),t.restore()}drawSprite(s,t,i){this.context.drawImage(s,t.x,t.y,i.x,i.y)}drawRect(s,t,i){const e=this.context;e.save(),e.fillStyle=i,e.fillRect(s.x,s.y,t.x,t.y),e.restore()}drawText(s,t,i={}){const e=this.context;e.save(),e.fillStyle=i.color??"#ffffff",e.font=i.font??"16px sans-serif",e.textBaseline="top",e.fillText(s,t.x,t.y),e.restore()}resize(s){this.canvas.width=s.x,this.canvas.height=s.y}}class K{constructor(s,t={}){r(this,"audio",new A);r(this,"input");r(this,"renderer");r(this,"ticker",new B);r(this,"currentScene",null);r(this,"elapsedTime",0);r(this,"options");r(this,"update",s=>{var i,e;const t=this.createContext(s);this.options.background?this.renderer.clear(this.options.background):this.renderer.clear(),(i=this.currentScene)==null||i.update(s,t),(e=this.currentScene)==null||e.render(t),this.elapsedTime+=s});this.options=t,this.renderer=new _(s),this.input=new N(window),this.input.attach(),this.ticker.subscribe(this.update)}setScene(s){var t,i;(t=this.currentScene)!=null&&t.onExit&&this.currentScene.onExit(this.createContext()),this.currentScene=s,(i=this.currentScene)!=null&&i.onEnter&&this.currentScene.onEnter(this.createContext())}start(){this.elapsedTime=0,this.ticker.start()}stop(){this.ticker.stop()}dispose(){this.stop(),this.input.detach()}createContext(s=0){return{renderer:this.renderer,input:this.input,elapsedTime:this.elapsedTime+s}}}const x=(a=0,s=0)=>({x:a,y:s}),w=(a,s,t)=>Math.max(s,Math.min(t,a)),G=(a,s,t)=>a+(s-a)*w(t,0,1);class X{}const m=[{name:"さくらんぼ",color:"#f9739a",radius:16,score:2},{name:"いちご",color:"#f87171",radius:22,score:4},{name:"かき",color:"#fb923c",radius:28,score:8},{name:"みかん",color:"#f97316",radius:36,score:12},{name:"りんご",color:"#ef4444",radius:44,score:20},{name:"なし",color:"#facc15",radius:52,score:36},{name:"もも",color:"#f472b6",radius:62,score:60},{name:"メロン",color:"#34d399",radius:74,score:100},{name:"パイナップル",color:"#fbbf24",radius:88,score:150},{name:"スイカ",color:"#22c55e",radius:110,score:250}],d=80,h=120,f=320,b=520,p=d+f,M=h+b,F=h+40,S=12,U=1200,Y=320,W=.995,H=.92,I=.45,J=.9,k=.08,$=36,z=.28,V=[0,0,0,1,1,1,2,2];class q extends X{constructor(){super(...arguments);r(this,"fruits",[]);r(this,"nextFruitId",1);r(this,"activeFruitId",null);r(this,"currentType",0);r(this,"previewType",0);r(this,"spawnBag",[]);r(this,"dropCooldown",0);r(this,"pointerX",null);r(this,"pendingMerges",[]);r(this,"score",0);r(this,"bestScore",0);r(this,"gameOver",!1);r(this,"canvasRect",null);r(this,"removeInputListener",null);r(this,"handleResize",()=>{const t=document.getElementById("game-canvas");t&&(this.canvasRect=t.getBoundingClientRect())})}onEnter(t){this.canvasRect=t.renderer.canvas.getBoundingClientRect(),this.bestScore=this.getStoredBestScore(),this.removeInputListener=t.input.onInput(i=>this.handleInput(i)),window.addEventListener("resize",this.handleResize),this.reset()}onExit(){var t;(t=this.removeInputListener)==null||t.call(this),this.removeInputListener=null,window.removeEventListener("resize",this.handleResize)}update(t,i){this.dropCooldown>0&&(this.dropCooldown=Math.max(0,this.dropCooldown-t));const e=this.getActiveFruit();if(!this.gameOver&&!e&&this.dropCooldown<=0&&this.spawnControlledFruit(this.currentType),e){e.age+=t;let n=0;if((i.input.isKeyPressed("arrowleft")||i.input.isKeyPressed("a"))&&(n-=1),(i.input.isKeyPressed("arrowright")||i.input.isKeyPressed("d"))&&(n+=1),n!==0&&(e.position.x+=n*Y*t),this.pointerX!==null){const o=w(this.pointerX,d+e.radius,p-e.radius);e.position.x=w(G(e.position.x,o,.35),d+e.radius,p-e.radius)}e.position.x=w(e.position.x,d+e.radius,p-e.radius),e.position.y=F}this.simulatePhysics(t),this.gameOver||this.checkGameOver()}render(t){const e=t.renderer.context;e.save(),e.fillStyle="#fcd34d",e.fillRect(d-S,h-S,f+S*2,b+S*2),e.fillStyle="#fefce8",e.fillRect(d,h,f,b),e.strokeStyle="rgba(251, 191, 36, 0.4)",e.setLineDash([8,8]),e.lineWidth=2,e.beginPath(),e.moveTo(d,h+2),e.lineTo(p,h+2),e.stroke(),e.restore(),this.fruits.forEach(o=>{const l=m[o.type];e.save(),e.translate(o.position.x,o.position.y);const c=e.createRadialGradient(-o.radius*.3,-o.radius*.3,o.radius*.4,0,0,o.radius);c.addColorStop(0,j(l.color,.25)),c.addColorStop(1,l.color),e.fillStyle=c,e.beginPath(),e.arc(0,0,o.radius,0,Math.PI*2),e.fill(),e.fillStyle="rgba(15, 23, 42, 0.24)",e.beginPath(),e.ellipse(0,o.radius*.4,o.radius*.85,o.radius*.45,0,0,Math.PI*2),e.fill(),e.fillStyle="#fefce8",e.font=`bold ${Math.max(12,o.radius*.6)}px/1 "Noto Sans JP", sans-serif`,e.textAlign="center",e.textBaseline="middle",e.fillText(String(o.type+1),0,o.radius*.05),e.restore()}),e.save(),e.fillStyle="#1f2937",e.font='24px/1.2 "Noto Sans JP", system-ui, sans-serif',e.textBaseline="top",e.fillText(`スコア: ${this.score}`,24,24),e.font='18px/1.2 "Noto Sans JP", system-ui, sans-serif',e.fillText(`ベスト: ${this.bestScore}`,24,58),e.fillText("操作: ← → / A D 移動, Space / Enter / タップでドロップ",24,92),e.restore();const n=m[this.previewType];e.save(),e.translate(p+48,h+96),e.fillStyle="#1f2937",e.font='18px/1 "Noto Sans JP", sans-serif',e.textAlign="center",e.textBaseline="middle",e.fillText("つぎのフルーツ",0,-n.radius*.9),e.beginPath(),e.fillStyle=n.color,e.arc(0,0,n.radius*.6,0,Math.PI*2),e.fill(),e.fillStyle="#0f172a",e.font="bold 16px/1 sans-serif",e.fillText(String(this.previewType+1),0,0),e.font='14px/1.2 "Noto Sans JP", sans-serif',e.fillText(n.name,0,n.radius*.8),e.restore(),this.gameOver&&(e.save(),e.fillStyle="rgba(15, 23, 42, 0.65)",e.fillRect(d+16,h+140,f-32,160),e.fillStyle="#f8fafc",e.textAlign="center",e.textBaseline="middle",e.font='bold 32px/1.2 "Noto Sans JP", sans-serif',e.fillText("ゲームオーバー",d+f/2,h+200),e.font='18px/1.3 "Noto Sans JP", sans-serif',e.fillText("R キー または タップでリスタート",d+f/2,h+240),e.restore())}handleInput(t){if(t instanceof PointerEvent){this.updatePointerPosition(t),t.type==="pointerdown"&&(this.gameOver?this.reset():this.tryDropActiveFruit());return}if(t.type!=="keydown")return;const i=t.key.toLowerCase();if(this.gameOver){i==="r"&&this.reset();return}(i===" "||i==="space"||i==="enter")&&this.tryDropActiveFruit()}updatePointerPosition(t){const i=t.currentTarget??document.getElementById("game-canvas");if(!i)return;this.canvasRect=i.getBoundingClientRect();const e=this.canvasRect,n=i.width/e.width;this.pointerX=(t.clientX-e.left)*n}reset(){this.fruits=[],this.pendingMerges=[],this.spawnBag=[],this.pointerX=null,this.nextFruitId=1,this.score=0,this.gameOver=!1,this.dropCooldown=0,this.currentType=this.drawNextType(),this.previewType=this.drawNextType(),this.spawnControlledFruit(this.currentType)}getActiveFruit(){return this.activeFruitId===null?null:this.fruits.find(t=>t.id===this.activeFruitId)??null}spawnControlledFruit(t){const i=m[t].radius,e=w(this.pointerX??d+f/2,d+i,p-i),n={id:this.nextFruitId++,type:t,radius:i,position:x(e,F),velocity:x(0,0),isControlled:!0,age:0};this.fruits.push(n),this.activeFruitId=n.id}tryDropActiveFruit(){if(this.gameOver||this.dropCooldown>0)return;const t=this.getActiveFruit();t&&(t.isControlled=!1,t.age=0,t.position.y=Math.max(t.position.y,h+t.radius+2),this.activeFruitId=null,this.dropCooldown=z,this.currentType=this.previewType,this.previewType=this.drawNextType())}simulatePhysics(t){for(const i of this.fruits)i.isControlled||(i.age+=t,i.velocity.y+=U*t,i.velocity.x*=W,i.position.x+=i.velocity.x*t,i.position.y+=i.velocity.y*t,i.position.x-i.radius<d&&(i.position.x=d+i.radius,i.velocity.x=Math.abs(i.velocity.x)*I),i.position.x+i.radius>p&&(i.position.x=p-i.radius,i.velocity.x=-Math.abs(i.velocity.x)*I),i.position.y+i.radius>M&&(i.position.y=M-i.radius,Math.abs(i.velocity.y)<60?i.velocity.y=0:i.velocity.y=-i.velocity.y*I,i.velocity.x*=H));this.resolveFruitCollisions(),this.processPendingMerges()}resolveFruitCollisions(){for(let t=0;t<this.fruits.length;t+=1){const i=this.fruits[t];if(!i.isControlled)for(let e=t+1;e<this.fruits.length;e+=1){const n=this.fruits[e];if(n.isControlled)continue;const o=n.position.x-i.position.x,l=n.position.y-i.position.y,c=Math.hypot(o,l),y=i.radius+n.radius;if(c===0||c>=y)continue;const v=y-c,u=c===0?0:o/c,g=c===0?0:l/c;i.position.x-=u*v/2,i.position.y-=g*v/2,n.position.x+=u*v/2,n.position.y+=g*v/2;const C=(n.velocity.x-i.velocity.x)*u+(n.velocity.y-i.velocity.y)*g;if(C<0){const L=-1.45*C*.5;i.velocity.x-=L*u,i.velocity.y-=L*g,n.velocity.x+=L*u,n.velocity.y+=L*g}this.maybeQueueMerge(i,n,c,y)}}}maybeQueueMerge(t,i,e,n){this.gameOver||t.type!==i.type||t.type>=m.length-1||t.isControlled||i.isControlled||t.age<k||i.age<k||e<=n*J&&this.pendingMerges.push([t.id,i.id])}processPendingMerges(){if(this.pendingMerges.length===0)return;const t=new Set,i=[];for(const[e,n]of this.pendingMerges){if(t.has(e)||t.has(n))continue;const o=this.fruits.find(u=>u.id===e),l=this.fruits.find(u=>u.id===n);if(!o||!l||o.type!==l.type)continue;const c=Math.min(o.type+1,m.length-1),y=m[c],v={id:this.nextFruitId++,type:c,radius:y.radius,position:x((o.position.x+l.position.x)/2,(o.position.y+l.position.y)/2),velocity:x((o.velocity.x+l.velocity.x)/2,(o.velocity.y+l.velocity.y)/2-80),isControlled:!1,age:0};i.push(v),t.add(e),t.add(n),this.score+=y.score}this.fruits=this.fruits.filter(e=>!t.has(e.id)),this.fruits.push(...i),this.pendingMerges=[],this.score>this.bestScore&&(this.bestScore=this.score,this.setStoredBestScore(this.bestScore))}checkGameOver(){const t=h+$;this.fruits.some(e=>!e.isControlled&&e.age>1&&e.position.y-e.radius<=t&&Math.abs(e.velocity.y)<20)&&(this.gameOver=!0,this.activeFruitId=null)}drawNextType(){return this.spawnBag.length===0&&(this.spawnBag=[...V],this.shuffle(this.spawnBag)),this.spawnBag.shift()??0}shuffle(t){for(let i=t.length-1;i>0;i-=1){const e=Math.floor(Math.random()*(i+1)),n=t[i];t[i]=t[e],t[e]=n}}getStoredBestScore(){try{const t=localStorage.getItem("suika-best-score");return t&&Number.parseInt(t,10)||0}catch{return 0}}setStoredBestScore(t){try{localStorage.setItem("suika-best-score",String(t))}catch{}}}const j=(a,s)=>{const t=a.replace("#",""),i=Number.parseInt(t,16),e=i>>16&255,n=i>>8&255,o=i&255,l=c=>Math.round(c+(255-c)*s);return`rgb(${l(e)}, ${l(n)}, ${l(o)})`},E=document.getElementById("game-canvas");if(!E)throw new Error("ゲームキャンバスが見つかりません");const P=new K(E,{background:"#fde68a"});P.renderer.resize(x(E.width,E.height));P.setScene(new q);P.start();
