var m=Object.defineProperty;var g=(o,e,t)=>e in o?m(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var r=(o,e,t)=>g(o,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function t(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=t(s);fetch(s.href,n)}})();class x{constructor(){r(this,"sounds",new Map);r(this,"muted",!1)}load(e,t){if(this.sounds.has(e))return;const i=new Audio(t);i.preload="auto",this.sounds.set(e,i)}play(e,t={}){const i=this.sounds.get(e);if(!i||this.muted)return;const s=i.cloneNode(!0);s.loop=t.loop??!1,s.volume=t.volume??1,s.play()}setMuted(e){this.muted=e}isMuted(){return this.muted}}const u=(o,e)=>{const t=Math.max(o.position.x,Math.min(e.position.x,o.position.x+o.size.x)),i=Math.max(o.position.y,Math.min(e.position.y,o.position.y+o.size.y)),s=e.position.x-t,n=e.position.y-i;return s*s+n*n<=e.radius*e.radius},f=1e3/60,w=5;class v{constructor(){r(this,"lastTick",performance.now());r(this,"accumulated",0);r(this,"running",!1);r(this,"subscribers",[]);r(this,"rafId",0);r(this,"loop",()=>{if(!this.running)return;const e=performance.now(),t=e-this.lastTick;this.lastTick=e,this.accumulated+=t;let i=0;for(;this.accumulated>=f&&i<w;)this.accumulated-=f,this.subscribers.forEach(s=>s(f/1e3)),i+=1;this.rafId=requestAnimationFrame(this.loop)})}start(){this.running||(this.running=!0,this.lastTick=performance.now(),this.loop())}stop(){this.running=!1,cancelAnimationFrame(this.rafId)}subscribe(e){return this.subscribers.push(e),()=>{const t=this.subscribers.indexOf(e);t>=0&&this.subscribers.splice(t,1)}}}class b{constructor(e=window){r(this,"pressedKeys",new Set);r(this,"pointerPosition",{x:0,y:0});r(this,"listeners",[]);r(this,"keyDownListener",e=>this.handleKeyDown(e));r(this,"keyUpListener",e=>this.handleKeyUp(e));r(this,"pointerListener",e=>this.handlePointer(e));r(this,"handleKeyDown",e=>{this.pressedKeys.add(e.key.toLowerCase()),this.listeners.forEach(t=>t(e))});r(this,"handleKeyUp",e=>{this.pressedKeys.delete(e.key.toLowerCase()),this.listeners.forEach(t=>t(e))});r(this,"handlePointer",e=>{this.pointerPosition={x:e.clientX,y:e.clientY},this.listeners.forEach(t=>t(e))});this.target=e}attach(){this.addTargetListeners(this.target)}detach(){this.removeTargetListeners(this.target),this.pressedKeys.clear(),this.listeners=[]}addTargetListeners(e){if(e instanceof Window){e.addEventListener("keydown",this.keyDownListener,{passive:!0}),e.addEventListener("keyup",this.keyUpListener,{passive:!0}),e.addEventListener("pointerdown",this.pointerListener,{passive:!0}),e.addEventListener("pointerup",this.pointerListener,{passive:!0}),e.addEventListener("pointermove",this.pointerListener,{passive:!0});return}e.addEventListener("keydown",this.keyDownListener,{passive:!0}),e.addEventListener("keyup",this.keyUpListener,{passive:!0}),e.addEventListener("pointerdown",this.pointerListener,{passive:!0}),e.addEventListener("pointerup",this.pointerListener,{passive:!0}),e.addEventListener("pointermove",this.pointerListener,{passive:!0})}removeTargetListeners(e){if(e instanceof Window){e.removeEventListener("keydown",this.keyDownListener),e.removeEventListener("keyup",this.keyUpListener),e.removeEventListener("pointerdown",this.pointerListener),e.removeEventListener("pointerup",this.pointerListener),e.removeEventListener("pointermove",this.pointerListener);return}e.removeEventListener("keydown",this.keyDownListener),e.removeEventListener("keyup",this.keyUpListener),e.removeEventListener("pointerdown",this.pointerListener),e.removeEventListener("pointerup",this.pointerListener),e.removeEventListener("pointermove",this.pointerListener)}isKeyPressed(e){return this.pressedKeys.has(e.toLowerCase())}getPointerPosition(){return{...this.pointerPosition}}onInput(e){return this.listeners.push(e),()=>{this.listeners=this.listeners.filter(t=>t!==e)}}}class S{constructor(e){r(this,"context");r(this,"canvas");const t=e.getContext("2d");if(!t)throw new Error("Renderer requires 2D canvas context");this.canvas=e,this.context=t,this.context.imageSmoothingEnabled=!0}clear(e="#000000"){const t=this.context;t.save(),t.fillStyle=e,t.fillRect(0,0,this.canvas.width,this.canvas.height),t.restore()}drawSprite(e,t,i){this.context.drawImage(e,t.x,t.y,i.x,i.y)}drawRect(e,t,i){const s=this.context;s.save(),s.fillStyle=i,s.fillRect(e.x,e.y,t.x,t.y),s.restore()}drawText(e,t,i={}){const s=this.context;s.save(),s.fillStyle=i.color??"#ffffff",s.font=i.font??"16px sans-serif",s.textBaseline="top",s.fillText(e,t.x,t.y),s.restore()}resize(e){this.canvas.width=e.x,this.canvas.height=e.y}}class L{constructor(e,t={}){r(this,"audio",new x);r(this,"input");r(this,"renderer");r(this,"ticker",new v);r(this,"currentScene",null);r(this,"elapsedTime",0);r(this,"options");r(this,"update",e=>{var i,s;const t=this.createContext(e);this.options.background?this.renderer.clear(this.options.background):this.renderer.clear(),(i=this.currentScene)==null||i.update(e,t),(s=this.currentScene)==null||s.render(t),this.elapsedTime+=e});this.options=t,this.renderer=new S(e),this.input=new b(window),this.input.attach(),this.ticker.subscribe(this.update)}setScene(e){var t,i;(t=this.currentScene)!=null&&t.onExit&&this.currentScene.onExit(this.createContext()),this.currentScene=e,(i=this.currentScene)!=null&&i.onEnter&&this.currentScene.onEnter(this.createContext())}start(){this.elapsedTime=0,this.ticker.start()}stop(){this.ticker.stop()}dispose(){this.stop(),this.input.detach()}createContext(e=0){return{renderer:this.renderer,input:this.input,elapsedTime:this.elapsedTime+e}}}const c=(o=0,e=0)=>({x:o,y:e}),k=(o,e,t)=>Math.max(e,Math.min(t,o));class E{}const P={background:new URL("data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20width='320'%20height='640'%20viewBox='0%200%20320%20640'%3e%3cdefs%3e%3clinearGradient%20id='sky'%20x1='0%25'%20y1='0%25'%20x2='0%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%237dd3fc'%20/%3e%3cstop%20offset='60%25'%20stop-color='%23bae6fd'%20/%3e%3cstop%20offset='100%25'%20stop-color='%23fef08a'%20/%3e%3c/linearGradient%3e%3clinearGradient%20id='ground'%20x1='0%25'%20y1='0%25'%20x2='100%25'%20y2='0%25'%3e%3cstop%20offset='0%25'%20stop-color='%23a8e05f'%20/%3e%3cstop%20offset='100%25'%20stop-color='%2386c946'%20/%3e%3c/linearGradient%3e%3c/defs%3e%3crect%20width='320'%20height='640'%20fill='url(%23sky)'%20/%3e%3cg%20transform='translate(0%20520)'%3e%3crect%20width='320'%20height='120'%20fill='url(%23ground)'%20/%3e%3cpath%20d='M0%2040%20C40%2020%2080%2020%20120%2040%20C160%2060%20200%2060%20240%2040%20C280%2020%20320%2020%20360%2040%20L360%20120%20L0%20120%20Z'%20fill='%2365a30d'%20opacity='0.3'%20/%3e%3c/g%3e%3cg%20fill='%23ffffff'%20opacity='0.5'%3e%3ccircle%20cx='60'%20cy='80'%20r='24'%20/%3e%3ccircle%20cx='84'%20cy='80'%20r='24'%20/%3e%3ccircle%20cx='72'%20cy='68'%20r='20'%20/%3e%3ccircle%20cx='200'%20cy='120'%20r='18'%20/%3e%3ccircle%20cx='220'%20cy='120'%20r='24'%20/%3e%3ccircle%20cx='240'%20cy='120'%20r='18'%20/%3e%3c/g%3e%3c/svg%3e",import.meta.url).href,bird:new URL("data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20width='64'%20height='48'%20viewBox='0%200%2064%2048'%3e%3cdefs%3e%3clinearGradient%20id='body'%20x1='0%25'%20y1='0%25'%20x2='100%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%23fb923c'%20/%3e%3cstop%20offset='100%25'%20stop-color='%23ea580c'%20/%3e%3c/linearGradient%3e%3c/defs%3e%3cg%20fill='none'%20fill-rule='evenodd'%3e%3cellipse%20cx='28'%20cy='24'%20rx='24'%20ry='18'%20fill='url(%23body)'%20/%3e%3cpath%20d='M44%2022%20L62%2018%20L62%2028%20Z'%20fill='%23fbbf24'%20/%3e%3ccircle%20cx='36'%20cy='18'%20r='6'%20fill='%23fff'%20/%3e%3ccircle%20cx='38'%20cy='18'%20r='3'%20fill='%231f2937'%20/%3e%3cpath%20d='M12%2016%20C4%2018%202%2026%2012%2032%20C10%2026%2010%2022%2012%2016%20Z'%20fill='%23f97316'%20/%3e%3cpath%20d='M22%2044%20C26%2036%2034%2036%2038%2044%20Z'%20fill='%23ea580c'%20/%3e%3c/g%3e%3c/svg%3e",import.meta.url).href,pipeTop:new URL("data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20width='96'%20height='320'%20viewBox='0%200%2096%20320'%3e%3cdefs%3e%3clinearGradient%20id='pipeTop'%20x1='0%25'%20y1='0%25'%20x2='0%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%23bbf7d0'%20/%3e%3cstop%20offset='100%25'%20stop-color='%2322c55e'%20/%3e%3c/linearGradient%3e%3c/defs%3e%3crect%20width='96'%20height='320'%20rx='16'%20fill='url(%23pipeTop)'%20/%3e%3crect%20width='112'%20height='36'%20x='-8'%20y='270'%20rx='18'%20fill='%2316a34a'%20/%3e%3crect%20width='92'%20height='12'%20x='2'%20y='256'%20rx='6'%20fill='%2386efac'%20opacity='0.7'%20/%3e%3c/svg%3e",import.meta.url).href,pipeBottom:new URL("data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20width='96'%20height='320'%20viewBox='0%200%2096%20320'%3e%3cdefs%3e%3clinearGradient%20id='pipeBottom'%20x1='0%25'%20y1='0%25'%20x2='0%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%2322c55e'%20/%3e%3cstop%20offset='100%25'%20stop-color='%2316a34a'%20/%3e%3c/linearGradient%3e%3c/defs%3e%3crect%20width='96'%20height='320'%20rx='16'%20fill='url(%23pipeBottom)'%20/%3e%3crect%20width='112'%20height='36'%20x='-8'%20y='14'%20rx='18'%20fill='%230f9f4b'%20/%3e%3crect%20width='92'%20height='12'%20x='2'%20y='40'%20rx='6'%20fill='%23bbf7d0'%20opacity='0.6'%20/%3e%3c/svg%3e",import.meta.url).href},T=o=>new Promise((e,t)=>{const i=new Image;i.src=o,i.onload=()=>e(i),i.onerror=()=>t(new Error(`画像の読み込みに失敗しました: ${o}`))}),M=async()=>{const o=await Promise.all(Object.entries(P).map(async([e,t])=>{const i=await T(t);return[e,i]}));return Object.fromEntries(o)},d=c(480,640);class I extends E{constructor(t){super();r(this,"state","ready");r(this,"birdSize");r(this,"pipeWidth");r(this,"gapSize",180);r(this,"gravity",1500);r(this,"flapVelocity",-520);r(this,"pipeSpeed",240);r(this,"pipeInterval",1.6);r(this,"pipes",[]);r(this,"birdPosition",c(d.x*.28,d.y*.5));r(this,"birdVelocity",0);r(this,"score",0);r(this,"bestScore",0);r(this,"timeSincePipe",0);r(this,"backgroundOffset",0);r(this,"idleTimer",0);r(this,"removeInputListener",null);this.assets=t,this.birdSize=c(t.bird.width||48,t.bird.height||36),this.pipeWidth=Math.max(t.pipeBottom.width,t.pipeTop.width,96)}onEnter(t){this.resetToReady(),this.removeInputListener=t.input.onInput(i=>{if(i instanceof PointerEvent){i.type==="pointerdown"&&this.handleAction();return}if(i instanceof KeyboardEvent){if(i.type!=="keydown")return;const s=i.key.toLowerCase();(s===" "||s==="space"||s==="arrowup")&&this.handleAction()}})}onExit(){var t;(t=this.removeInputListener)==null||t.call(this),this.removeInputListener=null}update(t,i){const s=i.renderer.canvas;if(this.backgroundOffset=(this.backgroundOffset+this.pipeSpeed*.35*t)%s.width,this.state==="ready"){this.idleTimer+=t,this.birdPosition.x=d.x*.28,this.birdPosition.y=d.y*.5+Math.sin(this.idleTimer*4)*12;return}if(this.state==="playing")this.timeSincePipe+=t,this.timeSincePipe>=this.pipeInterval&&(this.spawnPipe(s),this.timeSincePipe=0),this.birdVelocity+=this.gravity*t,this.birdPosition.y+=this.birdVelocity*t,this.updatePipes(t),this.checkCollisions(s);else if(this.state==="gameover"){this.birdVelocity+=this.gravity*t,this.birdPosition.y+=this.birdVelocity*t;const n=s.height-this.birdSize.y;this.birdPosition.y>n&&(this.birdPosition.y=n,this.birdVelocity=0)}}render(t){const{renderer:i}=t;this.drawScrollingBackground(i),this.drawPipes(i),i.drawSprite(this.assets.bird,this.birdPosition,this.birdSize),this.drawScoreboard(i),this.state==="ready"?this.drawOverlay(i,"タップ / スペースでスタート","連打しすぎず、リズム良く羽ばたこう"):this.state==="gameover"&&this.drawOverlay(i,"GAME OVER","スペースまたはタップでリスタート")}handleAction(){if(this.state==="ready"){this.startGame();return}if(this.state==="playing"){this.birdVelocity=this.flapVelocity;return}this.startGame()}startGame(){this.state="playing",this.birdPosition=c(d.x*.28,d.y*.5),this.birdVelocity=this.flapVelocity,this.pipes=[],this.score=0,this.timeSincePipe=0,this.backgroundOffset=0}resetToReady(){this.state="ready",this.birdPosition=c(d.x*.28,d.y*.5),this.birdVelocity=0,this.pipes=[],this.score=0,this.timeSincePipe=0,this.backgroundOffset=0,this.idleTimer=0}updatePipes(t){this.pipes.forEach(i=>{i.x-=this.pipeSpeed*t,!i.scored&&i.x+this.pipeWidth<this.birdPosition.x&&(i.scored=!0,this.score+=1,this.bestScore=Math.max(this.bestScore,this.score))}),this.pipes=this.pipes.filter(i=>i.x+this.pipeWidth>-this.pipeWidth)}spawnPipe(t){const s=120+this.gapSize/2,n=t.height-120-this.gapSize/2,a=k(s+Math.random()*(n-s),s,n);this.pipes.push({x:t.width+this.pipeWidth,gapY:a,scored:!1})}checkCollisions(t){if(this.birdPosition.y+this.birdSize.y>=t.height||this.birdPosition.y<=0){this.triggerGameOver();return}const i={position:c(this.birdPosition.x+this.birdSize.x/2,this.birdPosition.y+this.birdSize.y/2),radius:Math.max(this.birdSize.x,this.birdSize.y)*.35},s=this.gapSize/2;for(const n of this.pipes){const a=n.gapY-s,h=n.gapY+s,l={position:c(n.x,0),size:c(this.pipeWidth,a)},p={position:c(n.x,h),size:c(this.pipeWidth,t.height-h)};if(u(l,i)||u(p,i)){this.triggerGameOver();break}}}triggerGameOver(){this.state!=="gameover"&&(this.state="gameover",this.bestScore=Math.max(this.bestScore,this.score),this.birdVelocity=0)}drawScrollingBackground(t){const i=t.canvas,s=this.assets.background.width||i.width,n=this.assets.background.height||i.height,a=i.height/n,h=s*a,l=this.backgroundOffset%h;for(let p=-h+l;p<i.width+h;p+=h)t.drawSprite(this.assets.background,c(p,0),c(h,i.height))}drawPipes(t){const i=t.canvas,s=this.gapSize/2;for(const n of this.pipes){const a=n.gapY-s,h=n.gapY+s,l=a,p=i.height-h;t.drawSprite(this.assets.pipeTop,c(n.x,0),c(this.pipeWidth,l)),t.drawSprite(this.assets.pipeBottom,c(n.x,h),c(this.pipeWidth,p))}}drawScoreboard(t){const i=t.context;i.save(),i.fillStyle="#ffffff",i.font='bold 48px/1 "Inter", sans-serif',i.textAlign="center",i.textBaseline="top",i.strokeStyle="rgba(15, 23, 42, 0.45)",i.lineWidth=4,i.strokeText(String(this.score),t.canvas.width/2,28),i.fillText(String(this.score),t.canvas.width/2,28),i.font='18px/1.2 "Inter", sans-serif',i.textAlign="left",i.fillStyle="#0f172a",i.fillText(`BEST: ${this.bestScore}`,24,24),i.restore()}drawOverlay(t,i,s){const n=t.context,{width:a,height:h}=t.canvas;n.save(),n.fillStyle="rgba(15, 23, 42, 0.45)",n.fillRect(0,h*.32,a,140),n.fillStyle="#f8fafc",n.font='bold 28px/1.2 "Inter", sans-serif',n.textAlign="center",n.textBaseline="middle",n.fillText(i,a/2,h*.38),n.font='20px/1.4 "Inter", sans-serif',n.fillText(s,a/2,h*.44),n.restore()}}const y=document.getElementById("game-canvas");if(!y)throw new Error("ゲームキャンバスが見つかりません");const O=async()=>{const o=await M(),e=new L(y,{background:"#38bdf8"});e.renderer.resize(d),e.setScene(new I(o)),e.start()};O().catch(o=>{console.error(o)});
